<!DOCTYPE html>
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Media Pembelajaran Pertemuan 5 ‚Äî Relasi dan Fungsi</title>
<link href="https://fonts.googleapis.com/css2?family=Bagel+Fat+One&display=swap" rel="stylesheet">
<!-- Stub functions untuk Google API (harus sebelum script yang call-nya) -->
<script>
function gapiLoaded() {
  console.log('gapiLoaded called');
}
function gisLoaded() {
  console.log('gisLoaded called');
}
</script>
<!-- jsPDF Library untuk generate PDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<!-- html2canvas untuk screenshot slide -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<!-- EmailJS untuk pengiriman email -->
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
<!-- Google API Client Library untuk Google Drive Upload -->
<script src="https://apis.google.com/js/api.js" onload="gapiLoaded()"></script>
<script src="https://accounts.google.com/gsi/client" onload="gisLoaded()" async defer></script>
<style>
:root{
  --bg:#e8dcc8;
  --panel:#e0d0ba;
  --accent:#6b5542;
  --muted:#958770;
  --success:#9ac2a8;
  --danger:#d4a8a8;
  --info:#a8c5d8;
  --warning:#d8bd95;
  --nav-brown:#6b5542;
}

html,body{
  height:100%;
  margin:0;
  font-family:'Bagel Fat One',cursive;
  background:var(--bg);
  color:var(--accent);
}

body {
  background: linear-gradient(135deg, #e8dcc8 0%, #e0d0ba 50%, #d8c4ad 100%);
}

/* Modal overlay untuk Google Form */
#gformModal {
  display: none;
  position: fixed;
  z-index: 9999;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0,0,0,0.7);
  animation: fadeIn 0.3s ease;
}

#gformModalContent {
  position: relative;
  background: linear-gradient(135deg, #fff 0%, #f9f9f9 100%);
  margin: 5% auto;
  padding: 40px;
  border-radius: 20px;
  width: 90%;
  max-width: 600px;
  box-shadow: 0 10px 40px rgba(0,0,0,0.3);
  animation: slideDown 0.4s ease;
  text-align: center;
}

#gformModalClose {
  position: absolute;
  top: 15px;
  right: 20px;
  font-size: 32px;
  font-weight: bold;
  color: #999;
  cursor: pointer;
  transition: color 0.2s;
}

#gformModalClose:hover {
  color: #333;
}

.gform-title {
  color: #2a2420;
  font-size: 24px;
  margin-bottom: 20px;
  font-weight: 700;
}

.gform-message {
  color: #555;
  font-size: 16px;
  line-height: 1.6;
  margin-bottom: 30px;
}

.gform-link-btn {
  display: inline-block;
  background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
  color: white;
  padding: 18px 40px;
  font-size: 20px;
  font-weight: 700;
  border-radius: 12px;
  text-decoration: none;
  box-shadow: 0 4px 15px rgba(76,175,80,0.4);
  transition: all 0.3s ease;
  margin: 10px;
}

.gform-link-btn:hover {
  background: linear-gradient(135deg, #45a049 0%, #3d8b40 100%);
  box-shadow: 0 6px 20px rgba(76,175,80,0.5);
  transform: translateY(-2px);
}

.gform-close-btn {
  display: inline-block;
  background: #ccc;
  color: #333;
  padding: 12px 30px;
  font-size: 16px;
  border-radius: 8px;
  cursor: pointer;
  margin-top: 20px;
  transition: all 0.2s;
}

.gform-close-btn:hover {
  background: #bbb;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

@keyframes slideDown {
  from {
    opacity: 0;
    transform: translateY(-50px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: radial-gradient(circle at 20% 50%, rgba(255, 215, 0, 0.08), transparent 50%);
  z-index: -1;
  pointer-events: none;
}

.wrapper{
  min-height:100vh;
  display:flex;
  align-items:flex-start;
  justify-content:center;
  padding:28px;
  box-sizing:border-box;
}

.card{
  width:1100px;
  max-width:98%;
  background:#c0aa95;
  border-radius:18px;
  box-shadow:0 18px 40px rgba(0,0,0,.12);
  overflow:hidden;
  position:relative;
}

.header{
  text-align:center;
  padding:20px 10px;
  background:#f5e6d3;
  border-bottom:5px solid #6b5542;
  box-shadow:0 4px 12px rgba(0,0,0,0.15);
}
h1{font-size:44px;margin:6px 0;color:var(--accent)}
h2{font-size:28px;color:var(--accent);margin:12px 0}
h3{font-size:20px;color:var(--accent);margin:10px 0}

.lead{color:rgba(0,0,0,0.6);margin-bottom:18px}
.slides{
  min-height:60vh;
  padding:28px 18px;
  background:#c0aa95;
}
.slides h2,
.slides h3,
.slides p,
.slides label,
.slides strong {
  color:#2a2420;
}
.slide{display:none;padding:10px 18px 20px 18px;min-height:400px}
.slide.active{display:block;animation: fadeIn 0.5s ease-out;}
.center{display:flex;flex-direction:column;align-items:center;gap:12px;padding-top:100px}

.btn{
  background:#6b5542;
  color:#f5f0e8;
  border:none;
  padding:10px 20px;
  border-radius:12px;
  cursor:pointer;
  font-size:16px;
  transition: all 0.3s ease;
  font-family:'Bagel Fat One',cursive;
}
.btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 12px rgba(0,0,0,0.15);
  background:#5a4535;
}
.btn.ghost{background:transparent;color:#6b5542;border:2px solid #6b5542}
.btn:disabled{opacity:0.5;cursor:not-allowed}

.card-lite{
  background:#b09880;
  border:2px dashed #8b6b5a;
  border-radius:14px;
  padding:14px;
  margin:10px 0;
  animation: fadeIn 0.6s ease-out;
  box-shadow:0 2px 4px rgba(0,0,0,0.08);
}
.card-lite h2,
.card-lite h3,
.card-lite p {
  color:#2a2420;
}

/* Styling untuk pilihan penyajian */
.penyajian-option {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 12px;
  background: #fff;
  border: 2px solid #ddd;
  border-radius: 10px;
  cursor: pointer;
  transition: all 0.3s ease;
}

.penyajian-option:hover {
  background: #fffbf0;
  border-color: #6b5542;
  transform: translateY(-2px);
}

.penyajian-option input[type="radio"] {
  width: 18px;
  height: 18px;
  cursor: pointer;
}

.penyajian-option input[type="radio"]:checked + span {
  font-weight: 700;
  color: #6b5542;
}

.penyajian-option span {
  font-size: 16px;
  color: #6b5542;
  transition: all 0.2s ease;
}

/* Styling untuk komentar */
.komentar-item {
  background: #f9f9f9;
  border-left: 4px solid #6b5542;
  padding: 12px;
  margin-bottom: 12px;
  border-radius: 8px;
  animation: slideInLeft 0.5s ease-out;
}

.komentar-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}

.komentar-kelompok {
  font-weight: 700;
  color: #6b5542;
  font-size: 14px;
}

.komentar-waktu {
  font-size: 12px;
  color: #999;
}

.komentar-isi {
  color: #333;
  line-height: 1.5;
  font-family: Arial, sans-serif;
  font-size: 14px;
}

@keyframes slideInLeft {
  from {
    opacity: 0;
    transform: translateX(-20px);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}

.scenario-box{
  background:#a08870;
  border-left:4px solid var(--accent);
  border-radius:8px;
  padding:16px;
  margin:16px 0;
  animation: slideIn 0.6s ease-out;
  box-shadow:0 2px 4px rgba(0,0,0,0.08);
}
.scenario-box h3,
.scenario-box p,
.scenario-box li {
  color:#2a2420;
}

.feedback-box{
  padding:12px 16px;
  border-radius:8px;
  margin:12px 0;
  font-weight:700;
  text-align:center;
}

.feedback-box.success{
  background:#c8d8c8;
  color:#4a6b55;
  border-left:4px solid #9ac2a8;
}

.feedback-box.warning{
  background:#e0d0ba;
  color:#6b5542;
  border-left:4px solid #b89968;
}

.feedback-box.info{
  background:#c8d8e0;
  color:#556b7a;
  border-left:4px solid #a8c5d8;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

@keyframes slideIn {
  from { 
    opacity: 0;
    transform: translateX(-20px);
  }
  to { 
    opacity: 1;
    transform: translateX(0);
  }
}

.anggota-input{
  background:#ede3d3;
  border:2px solid #b89968;
  border-radius:8px;
  padding:10px;
  margin:8px 0;
  font-family:'Bagel Fat One',cursive;
  font-size:14px;
  display:flex;
  gap:8px;
  align-items:center;
  box-sizing:border-box;
  animation: slideIn 0.3s ease-out;
}

.anggota-input input{
  flex:1;
  border:none;
  padding:8px;
  font-family:'Bagel Fat One',cursive;
  font-size:14px;
  outline:none;
}

.anggota-input select{
  border:1px solid #b89968;
  padding:8px;
  font-family:'Bagel Fat One',cursive;
  font-size:14px;
  background:#f5f0e8;
  border-radius:6px;
  outline:none;
}

.anggota-input button{
  background:#d4a8a8;
  color:#f5f0e8;
  border:none;
  border-radius:6px;
  padding:6px 12px;
  cursor:pointer;
  font-weight:700;
}

.footer-nav{
  display:flex;
  gap:10px;
  justify-content:center;
  margin-top:20px;
  flex-wrap:wrap;
}

.atlet-btn, .atlet-btn-putri {
  font-size: 14px;
  transition: all 0.3s ease;
}

.atlet-btn:hover, .atlet-btn-putri:hover {
  transform: scale(1.05);
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
}

.atlet-btn.dipilih {
  background: #b71c1c !important;
  box-shadow: 0 0 10px rgba(233, 30, 99, 0.5) !important;
}

.atlet-btn.terpasang {
  background: #4caf50 !important;
  opacity: 0.7;
  cursor: not-allowed;
}

.atlet-btn-putri.terpasang {
  background: #4caf50 !important;
  opacity: 0.7;
  cursor: not-allowed;
}

.analisis-btn {
  padding: 10px 16px;
  background: #f5f5f5;
  border: 2px solid #bdbdbd;
  border-radius: 6px;
  cursor: pointer;
  font-size: 14px;
  font-weight: 600;
  transition: all 0.3s ease;
}

.analisis-btn:hover {
  background: #e0e0e0;
  border-color: #9c27b0;
}

.analisis-btn.dipilih {
  background: #9c27b0 !important;
  color: white !important;
  border-color: #7b1fa2 !important;
  box-shadow: 0 0 10px rgba(156, 39, 176, 0.4);
}

/* Recording Indicator */
.recording-indicator {
  position: fixed;
  top: 20px;
  right: 20px;
  background: #d32f2f;
  color: white;
  padding: 10px 16px;
  border-radius: 20px;
  font-size: 14px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.2);
  z-index: 1000;
  display: flex;
  align-items: center;
  gap: 8px;
  animation: pulse 2s infinite;
}

.recording-indicator .rec-dot {
  width: 10px;
  height: 10px;
  background: white;
  border-radius: 50%;
  animation: blink 1s infinite;
}

@keyframes pulse {
  0%, 100% { box-shadow: 0 4px 12px rgba(211, 47, 47, 0.4); }
  50% { box-shadow: 0 4px 20px rgba(211, 47, 47, 0.8); }
}

@keyframes blink {
  0%, 100% { opacity: 1; }
  50% { opacity: 0.3; }
}

.download-section {
  background: #fff3cd;
  border: 2px solid #ffc107;
  border-radius: 12px;
  padding: 20px;
  margin: 20px 0;
  text-align: center;
}

.download-btn {
  background: #4caf50;
  color: white;
  padding: 14px 28px;
  border: none;
  border-radius: 12px;
  font-size: 18px;
  font-weight: bold;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 4px 12px rgba(76, 175, 80, 0.3);
}

.download-btn:hover {
  background: #45a049;
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(76, 175, 80, 0.4);
}

.session-info {
  background: #e3f2fd;
  border-left: 4px solid #2196f3;
  padding: 12px;
  margin: 10px 0;
  border-radius: 6px;
  font-size: 14px;
  color: #1565c0;
}

.gdrive-section {
  background: #fff;
  border: 2px solid #4285f4;
  border-radius: 12px;
  padding: 20px;
  margin: 20px 0;
  text-align: center;
}

.gdrive-btn {
  background: #4285f4;
  color: white;
  padding: 14px 28px;
  border: none;
  border-radius: 12px;
  font-size: 16px;
  font-weight: bold;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 4px 12px rgba(66, 133, 244, 0.3);
  display: inline-flex;
  align-items: center;
  gap: 8px;
}

.gdrive-btn:hover {
  background: #3367d6;
  transform: translateY(-2px);
  box-shadow: 0 6px 16px rgba(66, 133, 244, 0.4);
}

.gdrive-btn:disabled {
  background: #ccc;
  cursor: not-allowed;
  transform: none;
}

.email-btn {
  background: #ff9800;
  color: white;
  padding: 12px 24px;
  border: none;
  border-radius: 12px;
  font-size: 16px;
  font-weight: bold;
  cursor: pointer;
  transition: all 0.3s ease;
  box-shadow: 0 4px 12px rgba(255, 152, 0, 0.3);
  display: inline-flex;
  align-items: center;
  gap: 8px;
}

.email-btn:hover {
  background: #f57c00;
  transform: translateY(-2px);
}

.modal-overlay {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(0, 0, 0, 0.7);
  z-index: 2000;
  align-items: center;
  justify-content: center;
}

.modal-overlay.active {
  display: flex;
}

.modal-content {
  background: white;
  border-radius: 16px;
  padding: 30px;
  max-width: 600px;
  width: 90%;
  max-height: 80vh;
  overflow-y: auto;
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
  animation: slideDown 0.3s ease-out;
}

@keyframes slideDown {
  from {
    opacity: 0;
    transform: translateY(-50px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 20px;
  padding-bottom: 15px;
  border-bottom: 2px solid #e0e0e0;
}

.modal-header h2 {
  margin: 0;
  color: #333;
}

.close-modal {
  background: none;
  border: none;
  font-size: 28px;
  cursor: pointer;
  color: #666;
  padding: 0;
  width: 30px;
  height: 30px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.close-modal:hover {
  color: #d32f2f;
}

.setup-steps {
  text-align: left;
  margin: 20px 0;
}

.setup-steps ol {
  padding-left: 20px;
}

.setup-steps li {
  margin: 10px 0;
  line-height: 1.6;
  color: #555;
}

.setup-steps code {
  background: #f5f5f5;
  padding: 2px 6px;
  border-radius: 4px;
  font-family: 'Courier New', monospace;
  font-size: 13px;
  color: #d32f2f;
}

.status-message {
  padding: 12px;
  border-radius: 8px;
  margin: 10px 0;
  text-align: center;
  font-weight: bold;
}

.status-message.success {
  background: #c8e6c9;
  color: #2e7d32;
}

.status-message.error {
  background: #ffcdd2;
  color: #c62828;
}

.status-message.info {
  background: #bbdefb;
  color: #1565c0;
}

/* Modal overlay untuk Google Form */
#gformModal {
  display: none;
  position: fixed;
  z-index: 9999;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0,0,0,0.7);
  animation: fadeIn 0.3s ease;
}

#gformModalContent {
  position: relative;
  background: linear-gradient(135deg, #fff 0%, #f9f9f9 100%);
  margin: 5% auto;
  padding: 40px;
  border-radius: 20px;
  width: 90%;
  max-width: 600px;
  box-shadow: 0 10px 40px rgba(0,0,0,0.3);
  animation: slideDown 0.4s ease;
  text-align: center;
}

#gformModalClose {
  position: absolute;
  top: 15px;
  right: 20px;
  font-size: 32px;
  font-weight: bold;
  color: #999;
  cursor: pointer;
  transition: color 0.2s;
}

#gformModalClose:hover {
  color: #333;
}

.gform-title {
  color: #2a2420;
  font-size: 24px;
  margin-bottom: 20px;
  font-weight: 700;
}

.gform-message {
  color: #555;
  font-size: 16px;
  line-height: 1.6;
  margin-bottom: 30px;
}

.gform-link-btn {
  display: inline-block;
  background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
  color: white;
  padding: 18px 40px;
  font-size: 20px;
  font-weight: 700;
  border-radius: 12px;
  text-decoration: none;
  box-shadow: 0 4px 15px rgba(76,175,80,0.4);
  transition: all 0.3s ease;
  margin: 10px;
}

.gform-link-btn:hover {
  background: linear-gradient(135deg, #45a049 0%, #3d8b40 100%);
  box-shadow: 0 6px 20px rgba(76,175,80,0.5);
  transform: translateY(-2px);
}

.gform-close-btn {
  display: inline-block;
  background: #ccc;
  color: #333;
  padding: 12px 30px;
  font-size: 16px;
  border-radius: 8px;
  cursor: pointer;
  margin-top: 20px;
  transition: all 0.2s;
}

.gform-close-btn:hover {
  background: #bbb;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

@keyframes slideDown {
  from {
    opacity: 0;
    transform: translateY(-50px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.input-group {
  margin: 15px 0;
  text-align: left;
}

.input-group label {
  display: block;
  margin-bottom: 5px;
  font-weight: bold;
  color: #333;
}

.input-group input {
  width: 100%;
  padding: 10px;
  border: 2px solid #e0e0e0;
  border-radius: 8px;
  font-size: 14px;
  box-sizing: border-box;
}

.input-group input:focus {
  outline: none;
  border-color: #4285f4;
}

.btn-group {
  display: flex;
  gap: 10px;
  justify-content: center;
  margin-top: 20px;
  flex-wrap: wrap;
}

@keyframes floating {
  0%, 100% { transform: translateY(0px); }
  50% { transform: translateY(-12px); }
}

h1, h2 {
  animation: floating 3s ease-in-out infinite;
}

</style>
</head>
<body>

<!-- Modal Google Form -->
<div id="gformModal">
  <div id="gformModalContent">
    <span id="gformModalClose" onclick="closeGFormModal()">&times;</span>
    <div class="gform-title">‚úÖ PDF Berhasil Didownload!</div>
    <div class="gform-message">
      <p style="margin:10px 0;">File PDF hasil pembelajaran sudah tersimpan di komputer Anda.</p>
      <p style="margin:10px 0;font-weight:700;color:#d32f2f;">Sekarang silakan upload ke Google Form:</p>
    </div>
    <a href="" id="gformLink" class="gform-link-btn" target="_blank">üìù BUKA GOOGLE FORM</a>
    <div style="margin-top:25px;padding:20px;background:#fff9e6;border-radius:10px;text-align:left;">
      <p style="font-size:14px;margin:8px 0;color:#333;"><strong>Instruksi:</strong></p>
      <ol style="font-size:13px;line-height:1.8;color:#555;margin:8px 0;padding-left:20px;">
        <li>Klik tombol hijau di atas untuk membuka Google Form</li>
        <li>Isi nama kelompok Anda</li>
        <li>Upload file PDF yang baru didownload</li>
        <li>Klik Submit</li>
      </ol>
      <p style="font-size:12px;margin:10px 0;color:#777;font-style:italic;">üí° File akan otomatis masuk ke Google Drive guru!</p>
    </div>
    <div class="gform-close-btn" onclick="closeGFormModal()">Tutup</div>
  </div>
</div>

<!-- Recording Indicator -->
<div class="recording-indicator" id="recordingIndicator" style="display: none;">
  <div class="rec-dot"></div>
  <span>Merekam Aktivitas</span>
</div>

<div class="wrapper">
  <div class="card">
    <div class="header">
      <h1>üìö Media Pembelajaran Pertemuan 5</h1>
      <h2 style="font-size:24px;color:#2a2420;margin-top:8px">Relasi dan Fungsi</h2>
      <p class="lead">Perjalanan Mengenal Relasi &amp; Fungsi dalam Matematika</p>
    </div>

    <main class="slides">

      <!-- Slide 1: Start -->
      <section class="slide active" id="start">
        <div class="card-lite">
          <h2>üëã Selamat Datang di Pertemuan 5!</h2>
          <p style="color:#2a2420;font-size:18px;margin:16px 0">Hari ini kita akan mempelajari tentang <strong>Korespondensi Satu-satu</strong> ‚Äî dan menghitung banyaknya korespondensi satu-satu</p>

          <div class="scenario-box">
            <h3 style="color:var(--accent);margin-top:0">üéØ Tujuan Pembelajaran</h3>
            <ul style="font-size:16px;line-height:1.8;color:#2a2420">
              <li>Memahami konsep korespondensi satu-satu</li>
              <li>Menghitung banyaknya korespondensi satu-satu</li>
              <li>Mengaplikasikan konsep dalam masalah nyata</li>
            </ul>
          </div>

          <div class="scenario-box" style="background:#e3f2fd;border-left:4px solid #2196f3">
            <h3 style="color:#2a2420;margin-top:0">üìö Alur Pembelajaran</h3>
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-top:12px">
              <div style="background:#f9f5f0;padding:12px;border-radius:8px;border:2px solid #6b5542">
                <p style="margin:0;font-weight:700;color:#6b5542;font-size:14px">üìç Fase 1-2: Orientasi</p>
                <p style="margin:4px 0 0 0;font-size:13px;color:#2a2420">Permasalahan & Identitas</p>
              </div>
              <div style="background:#f9f5f0;padding:12px;border-radius:8px;border:2px solid #6b5542">
                <p style="margin:0;font-weight:700;color:#6b5542;font-size:14px">üîç Fase 3: Investigasi</p>
                <p style="margin:4px 0 0 0;font-size:13px;color:#2a2420">Penemuan & Analisis Konsep</p>
              </div>
              <div style="background:#f9f5f0;padding:12px;border-radius:8px;border:2px solid #6b5542">
                <p style="margin:0;font-weight:700;color:#6b5542;font-size:14px">üé® Fase 4: Penyajian</p>
                <p style="margin:4px 0 0 0;font-size:13px;color:#2a2420">Visualisasi & Kesimpulan</p>
              </div>
              <div style="background:#c8f0d4;padding:12px;border-radius:8px;border:2px solid #4caf50">
                <p style="margin:0;font-weight:700;color:#2e7d32;font-size:14px">üéâ Ringkasan Akhir</p>
                <p style="margin:4px 0 0 0;font-size:13px;color:#2a2420">Download PDF & Kirim ke Guru</p>
              </div>
            </div>
          </div>

          
          <div class="footer-nav">
            <button class="btn" onclick="show('orientasi-permasalahan')" style="width:100%;padding:14px;font-size:18px">Mulai Pembelajaran ‚ü∂</button>
          </div>
        </div>
      </section>

      <!-- Slide 2: Orientasi Permasalahan dengan Foto -->
      <section class="slide" id="orientasi-permasalahan">
        <div class="card-lite">
          <h2>üéØ Orientasi Permasalahan</h2>
          <p class="lead" style="color:#2a2420">Perhatikan permasalahan berikut lalu tekan "Lanjut ke Identitas Kelompok" untuk melanjutkan.</p>

          <div style="text-align:center;margin:20px 0">
            <img src="../images/badminton.png" alt="Ilustrasi Turnamen Badminton" style="max-width:100%;height:auto;border-radius:10px;display:block;margin:0 auto 12px;box-shadow:0 4px 12px rgba(0,0,0,0.15)">
          </div>

          <div style="background:#fff3d9;border-left:4px solid #d4a574;border-radius:10px;padding:16px;margin:14px auto;max-width:760px;text-align:left">
            <div style="font-weight:700;color:var(--accent);margin-bottom:10px;font-size:18px">üè∏ Permasalahan: Turnamen Badminton Ganda Campuran!</div>
            <p style="color:#2a2420;font-size:14px;line-height:1.6;margin:8px 0">
              Sekolah kalian mengadakan turnamen badminton ganda campuran. Ada 4 pemain putra (Andi, Budi, Citra, Dani) dan 4 pemain putri (Evi, Fani, Gita, Hana) yang akan membentuk pasangan untuk bertanding.
            </p>

            <p style="color:#2a2420;font-size:14px;line-height:1.6;margin:8px 0;font-weight:700;background:#fff9e6;padding:8px;border-radius:6px">
              Setiap pemain putra harus berpasangan dengan TEPAT SATU pemain putri, dan sebaliknya ‚Äî tidak boleh ada pemain yang berpasangan lebih dari satu kali atau tidak kebagian pasangan.
            </p>

            <div style="background:#fffacd;border:3px solid #ffd700;border-radius:10px;padding:16px;margin:16px 0;box-shadow:0 4px 8px rgba(0,0,0,0.1)">
              <p style="color:#2a2420;font-size:16px;line-height:1.6;margin:0;font-weight:700;text-align:center">‚ùì PERTANYAAN UTAMA YANG HARUS DIJAWAB:</p>
              <p style="color:#d32f2f;font-size:18px;line-height:1.6;margin:12px 0;font-weight:700;text-align:center">
                "Berapa banyak pasangan berbeda yang dapat dibentuk dari 4 pemain putra dan 4 pemain putri jika setiap pemain harus berpasangan dengan TEPAT SATU pemain lainnya (korespondensi satu-satu)?"
              </p>
              <p style="color:#2a2420;font-size:13px;line-height:1.6;margin:8px 0;text-align:center;font-style:italic">
                üí° Ingat pertanyaan ini! Kalian akan menjawabnya di akhir pembelajaran setelah memahami konsep korespondensi satu-satu.
              </p>
            </div>

            <p style="color:#2a2420;font-size:14px;line-height:1.6;margin:12px 0">
              Pertanyaan pemantik tambahan:
            </p>
            <ul style="color:#2a2420;font-size:14px;line-height:1.6;margin:6px 0 10px 18px">
              <li>Bagaimana cara terbaik untuk menampilkan hubungan antara pemain putra dan pemain putri?</li>
              <li>Apa yang dimaksud dengan "korespondensi satu-satu" dalam konteks pembentukan pasangan ini?</li>
              <li>Apakah ada rumus untuk menghitung total kemungkinan pasangan?</li>
            </ul>

            <p style="color:var(--accent);font-weight:700;font-size:14px;line-height:1.6;margin:10px 0">
              Tugas: Kalian akan mempelajari konsep korespondensi satu-satu dan menghitung semua kemungkinan pasangan yang dapat dibentuk dalam turnamen ini!
            </p>
          </div>

          <p style="color:var(--accent);font-weight:700;margin:16px 0;font-size:18px;text-align:center">üéØ Misi Kalian:</p>
          <p style="color:#2a2420;margin-bottom:10px;font-size:14px;line-height:1.6;text-align:center;max-width:700px;margin:0 auto 20px auto">
            Memahami konsep korespondensi satu-satu, membentuk pasangan badminton yang valid, dan menghitung berapa banyak kemungkinan pasangan yang dapat dibentuk dengan aturan turnamen!
          </p>

          <!-- Textarea untuk siswa menuliskan solusi -->
          <div style="max-width:800px;margin:24px auto">
            <label style="display:block;color:var(--accent);font-weight:700;font-size:16px;margin-bottom:10px">üí° Ide Solusi Awal Kalian:</label>
            <p style="color:#2a2420;font-size:14px;margin-bottom:10px">Sebelum melanjutkan, tuliskan ide awal kalian tentang bagaimana cara menyelesaikan permasalahan turnamen badminton ini:</p>
            <textarea id="solusiAwalPertemuan5" placeholder="Contoh: Saya akan membuat diagram pasangan, menghitung kemungkinan dengan rumus kombinasi/permutasi..." style="width:100%;min-height:120px;padding:14px;border-radius:10px;border:2px solid rgba(0,0,0,0.1);background:#fff;font-family:sans-serif;font-size:14px;resize:vertical;box-sizing:border-box"></textarea>
            <p style="color:var(--muted);font-size:12px;margin-top:8px;font-style:italic">üí≠ Tidak apa jika belum yakin, tuliskan saja apa yang terpikirkan saat ini!</p>
          </div>

          <div class="footer-nav">
            <button class="btn ghost" onclick="show('start')">‚üµ Kembali</button>
            <button class="btn" onclick="show('identitas-kelompok')">Lanjut ke Identitas Kelompok ‚ü∂</button>
          </div>
        </div>
      </section>

      <!-- Slide 3: Identitas Kelompok -->
      <section class="slide" id="identitas-kelompok">
        <div class="card-lite">
          <h2>üë• Data Kelompok Anda</h2>
          <p style="color:#2a2420;margin-bottom:20px">Silakan isi data kelompok Anda sebelum melanjutkan ke tahap pembelajaran.</p>

          <div class="scenario-box">
            <label for="namaKelompok" style="display:block;margin-bottom:8px;color:var(--accent);font-weight:700;font-size:16px">üìù Nama Kelompok</label>
            <input type="text" id="namaKelompok" placeholder="Contoh: Kelompok Relasi Jaya" style="width:100%;padding:12px;border-radius:8px;border:2px solid #d1d5db;font-family:'Bagel Fat One',cursive;font-size:15px;box-sizing:border-box">

            <div style="margin-top:20px">
              <label style="color:var(--accent);font-weight:700;font-size:16px">üë§ Anggota Kelompok</label>
              <div id="anggotaContainer" style="margin-top:12px"></div>
              <button type="button" class="btn ghost" onclick="tambahAnggota()" style="margin-top:12px;width:100%">+ Tambah Anggota</button>
            </div>
          </div>

          <button class="btn" id="btnSimpanKelompok" style="width:100%;padding:12px;margin:20px 0">‚úì Simpan Data Kelompok</button>
          <div id="feedbackKelompok" style="margin:20px auto;max-width:700px;padding:12px;border-radius:8px;text-align:center;display:none"></div>

          <div class="footer-nav">
            <button class="btn ghost" onclick="show('orientasi-permasalahan')">‚üµ Kembali</button>
            <button class="btn" onclick="show('discovery-korespondensi')">Lanjut: Penemuan Konsep ‚ü∂</button>
          </div>
        </div>
      </section>

      <!-- FASE 3: INVESTIGASI & ANALISIS -->

      <!-- Slide 3.1: Discovery - Apa itu Korespondensi Satu-Satu? -->
      <section class="slide" id="discovery-korespondensi">
        <div class="card-lite">
          <h2>üîé Fase 3.1: Penemuan Konsep Korespondensi Satu-Satu</h2>
          <p style="color:#2a2420;margin-bottom:20px">Mari kita cari tahu sendiri apa yang disebut "Korespondensi Satu-Satu" dengan mengamati beberapa relasi berikut.</p>

          <!-- PENGANTAR AKTIVITAS -->
          <div style="background:#fff3cd;border:3px solid #ffcb64;border-radius:12px;padding:16px;margin:16px 0">
            <h3 style="color:#d4a574;margin-top:0;display:flex;align-items:center;gap:8px">üìå Mengapa Kegiatan Ini Penting?</h3>
            <p style="color:#2a2420;margin:8px 0;line-height:1.6;font-size:15px">
              Sebelum menghitung berapa banyak pasangan yang bisa dibuat, kita HARUS memahami apa itu "Korespondensi Satu-Satu". Dengan mempelajari contoh-contoh nyata yang berbeda, kalian akan menemukan ciri-ciri khusus dari relasi ini. Inilah cara para matematikawan menemukan konsep baru ‚Äî dari pengamatan contoh-contoh terlebih dahulu! üîç
            </p>
          </div>

          <div class="scenario-box" style="background:#c8d8e0;border-left:4px solid #a8c5d8">
            <h3 style="color:#7a9bc4;margin-top:0">Contoh 1: Relasi Siswa dengan Nomor Induk Siswa (NIS)</h3>
            <p style="color:#2a2420;margin:8px 0;font-size:14px">Setiap siswa memiliki SATU nomor induk siswa, dan setiap nomor induk siswa milik SATU siswa saja.</p>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin:12px 0">
              <div style="background:#e8dcc8;padding:12px;border-radius:6px;border-left:4px solid #a8c5d8">
                <p style="margin:0;font-weight:700;color:#7a9bc4">üë® Siswa</p>
                <p style="margin:4px 0;font-size:13px">‚Ä¢ Andi</p>
                <p style="margin:4px 0;font-size:13px">‚Ä¢ Budi</p>
                <p style="margin:4px 0;font-size:13px">‚Ä¢ Citra</p>
              </div>
              <div style="background:#e8dcc8;padding:12px;border-radius:6px;border-left:4px solid #a8c5d8">
                <p style="margin:0;font-weight:700;color:#7a9bc4">üÜî NIS</p>
                <p style="margin:4px 0;font-size:13px">‚Ä¢ 001</p>
                <p style="margin:4px 0;font-size:13px">‚Ä¢ 002</p>
                <p style="margin:4px 0;font-size:13px">‚Ä¢ 003</p>
              </div>
            </div>
            <p style="color:#2196f3;font-weight:700;margin:8px 0">‚úì SETIAP siswa ‚Üî SATU NIS | SETIAP NIS ‚Üî SATU siswa</p>
          </div>

          <div class="scenario-box" style="background:#fff3e0;border-left:4px solid #ff9800">
            <h3 style="color:#2a2420;margin-top:0">Contoh 2: Relasi Siswa dengan Mata Pelajaran</h3>
            <p style="color:#2a2420;margin:8px 0;font-size:14px">Setiap siswa belajar BANYAK mata pelajaran (Matematika, IPA, Bahasa, dsb).</p>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin:12px 0">
              <div style="background:#e8dcc8;padding:12px;border-radius:6px;border-left:4px solid #b89968">
                <p style="margin:0;font-weight:700;color:#8b6b5a">üë® Siswa</p>
                <p style="margin:4px 0;font-size:13px">‚Ä¢ Andi</p>
                <p style="margin:4px 0;font-size:13px">‚Ä¢ Budi</p>
                <p style="margin:4px 0;font-size:13px">‚Ä¢ Citra</p>
              </div>
              <div style="background:#e8dcc8;padding:12px;border-radius:6px;border-left:4px solid #b89968">
                <p style="margin:0;font-weight:700;color:#8b6b5a">üìö Mata Pelajaran</p>
                <p style="margin:4px 0;font-size:13px">‚Ä¢ Matematika</p>
                <p style="margin:4px 0;font-size:13px">‚Ä¢ IPA</p>
                <p style="margin:4px 0;font-size:13px">‚Ä¢ Bahasa</p>
              </div>
            </div>
            <p style="color:#2a2420;font-weight:700;margin:8px 0">‚úó SETIAP siswa ‚Üî BANYAK mata pelajaran (BUKAN satu-satu)</p>
          </div>

          <div class="scenario-box" style="background:#f3dce8;border-left:4px solid #d4a0b8">
            <h3 style="color:#c2185b;margin-top:0">Contoh 3: Relasi Pemain Putra dengan Pemain Putri dalam Badminton Ganda</h3>
            <p style="color:#2a2420;margin:8px 0;font-size:14px">Setiap pemain putra berpasangan dengan SATU pemain putri, dan sebaliknya setiap pemain putri berpasangan dengan SATU pemain putra.</p>
            <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin:12px 0">
              <div style="background:#e8dcc8;padding:12px;border-radius:6px;border-left:4px solid #b89888">
                <p style="margin:0;font-weight:700;color:#8b6b5a">üë® Pemain Putra</p>
                <p style="margin:4px 0;font-size:13px">‚Ä¢ Andi</p>
                <p style="margin:4px 0;font-size:13px">‚Ä¢ Budi</p>
                <p style="margin:4px 0;font-size:13px">‚Ä¢ Citra</p>
              </div>
              <div style="background:#e8dcc8;padding:12px;border-radius:6px;border-left:4px solid #b89888">
                <p style="margin:0;font-weight:700;color:#c2185b">üë© Pemain Putri</p>
                <p style="margin:4px 0;font-size:13px">‚Ä¢ Evi</p>
                <p style="margin:4px 0;font-size:13px">‚Ä¢ Fani</p>
                <p style="margin:4px 0;font-size:13px">‚Ä¢ Gita</p>
              </div>
            </div>
            <p style="color:#e91e63;font-weight:700;margin:8px 0">‚úì SETIAP pemain putra ‚Üî SATU pemain putri | SETIAP pemain putri ‚Üî SATU pemain putra</p>
          </div>

          <div class="scenario-box" style="background:#fff3e0;border-left:4px solid #d4a574;margin-top:20px">
            <h3 style="color:#2a2420;margin-top:0">üí≠ Hipotesis Awal Kelompok Kalian</h3>
            <p style="color:#2a2420;font-size:15px;margin:8px 0">Berdasarkan 3 contoh di atas, coba tuliskan <strong>hipotesis/dugaan kalian</strong>:</p>
            <p style="color:#2a2420;font-size:15px;margin:8px 0;font-weight:700">Menurut kalian, apa yang dimaksud dengan "Korespondensi Satu-Satu"?</p>
            
            <textarea id="hipotesisKorespondensi" placeholder="Contoh: Korespondensi satu-satu adalah relasi dimana..." style="width:100%;padding:14px;border-radius:8px;border:3px solid #6b5542;font-family:Arial,sans-serif;font-size:16px;box-sizing:border-box;min-height:100px;background:#ffffff;color:#2a2420;line-height:1.5;margin:12px 0"></textarea>
            
            <button class="btn" onclick="submitHipotesis()" style="width:100%;padding:12px">‚úì Submit Hipotesis Kami</button>
          </div>

          <div id="pengertianBenar" style="display:none;margin-top:20px">
            <div class="scenario-box" style="background:#c8d8c8;border-left:4px solid #4caf50">
              <h3 style="color:#2a2420;margin-top:0">‚úÖ Pengertian Korespondensi Satu-Satu (Definisi Benar)</h3>
              <p style="color:#2a2420;font-size:15px;margin:8px 0;line-height:1.8;background:#e8dcc8;padding:12px;border-radius:6px">
                <strong>Korespondensi satu-satu</strong> adalah relasi antara dua himpunan dimana <strong>setiap anggota himpunan pertama dipasangkan dengan TEPAT satu anggota himpunan kedua</strong>, dan <strong>sebaliknya setiap anggota himpunan kedua juga dipasangkan dengan TEPAT satu anggota himpunan pertama</strong>.
              </p>
              <div style="background:#f9f5f0;padding:12px;border-radius:6px;margin:12px 0">
                <p style="color:#2a2420;font-size:14px;margin:4px 0"><strong>Ciri-ciri:</strong></p>
                <ul style="color:#2a2420;font-size:14px;margin:8px 0;padding-left:20px">
                  <li>Setiap anggota A berpasangan dengan TEPAT SATU anggota B</li>
                  <li>Setiap anggota B berpasangan dengan TEPAT SATU anggota A</li>
                  <li>Tidak ada yang berpasangan lebih dari satu</li>
                  <li>Tidak ada yang tidak berpasangan</li>
                </ul>
              </div>
              <p style="color:#2a2420;font-size:14px;margin:8px 0">üí° <strong>Bandingkan dengan hipotesis kalian!</strong> Apakah sudah mendekati?</p>
            </div>

            <button class="btn" onclick="show('identifikasi-himpunan')" style="width:100%;padding:12px;margin-top:12px">Lanjut: Identifikasi Himpunan ‚ü∂</button>
          </div>

          <div class="footer-nav">
            <button class="btn ghost" onclick="show('identitas-kelompok')">‚üµ Kembali</button>
          </div>
        </div>
      </section>

      <!-- Slide 3.2: Identifikasi Himpunan -->
      <section class="slide" id="identifikasi-himpunan">
        <div class="card-lite">
          <h2>üîç Fase 3.2: Identifikasi Himpunan</h2>
          <p style="color:#2a2420;margin-bottom:20px">Mari kita identifikasi himpunan pemain putra dan pemain putri dari permasalahan turnamen badminton ganda campuran.</p>

          <div class="scenario-box">
            <h3 style="color:var(--accent);margin-top:0">üìã Permasalahan</h3>
            <p style="margin:8px 0;font-size:16px">
              <strong>Turnamen Badminton Ganda Campuran:</strong> Ada 4 pemain putra (Andi, Budi, Citra, Dani) dan 4 pemain putri (Evi, Fani, Gita, Hana) yang akan membentuk pasangan ganda campuran.
            </p>
            <p style="margin:8px 0;font-size:16px;background:#f0dcc8;padding:12px;border-radius:6px;">
              <strong>‚ùì Pertanyaan:</strong> Berapa banyak pasangan berbeda yang dapat dibentuk jika setiap pemain putra berpasangan dengan TEPAT satu pemain putri (Korespondensi Satu-Satu)?
            </p>
          </div>

          <div style="margin:20px 0;padding:16px;background:#f5f5f5;border-radius:8px">
            <h3 style="color:var(--accent);margin-top:0">‚úèÔ∏è Tugas: Isi Himpunan Berikut</h3>
            
            <div style="margin:16px 0">
              <label style="display:block;margin-bottom:8px;color:var(--accent);font-weight:700;font-size:16px">Himpunan A (Pemain Putra)</label>
              <input type="text" id="himpunanA" placeholder="Contoh: Andi, Budi, Citra, Dani" style="width:100%;padding:12px;border-radius:8px;border:2px solid #d1d5db;font-family:'Bagel Fat One',cursive;font-size:15px;box-sizing:border-box">
              <small style="color:#2a2420;margin-top:4px;display:block">Pisahkan dengan koma</small>
            </div>

            <div style="margin:16px 0">
              <label style="display:block;margin-bottom:8px;color:var(--accent);font-weight:700;font-size:16px">Himpunan B (Pemain Putri)</label>
              <input type="text" id="himpunanB" placeholder="Contoh: Evi, Fani, Gita, Hana" style="width:100%;padding:12px;border-radius:8px;border:2px solid #d1d5db;font-family:'Bagel Fat One',cursive;font-size:15px;box-sizing:border-box">
              <small style="color:#2a2420;margin-top:4px;display:block">Pisahkan dengan koma</small>
            </div>
          </div>

          <button class="btn" onclick="show('eksplorasi-interaktif')" style="width:100%;padding:12px">Lanjut: Eksplorasi Interaktif ‚ü∂</button>

          <div class="footer-nav">
            <button class="btn ghost" onclick="show('discovery-korespondensi')">‚üµ Kembali</button>
          </div>
        </div>
      </section>

      <!-- Slide 3.2: Eksplorasi Interaktif -->
      <section class="slide" id="eksplorasi-interaktif">
        <div class="card-lite">
          <h2>üé≤ Fase 3.3: Eksplorasi Interaktif - Pasangkan Pemain!</h2>
          <p style="color:#2a2420;margin-bottom:20px">Klik pada pemain putra, kemudian pilih pemain putri yang akan menjadi pasangannya. Setiap pemain hanya bisa berpasangan dengan SATU pemain lain!</p>

          <div style="display:grid;grid-template-columns:1fr 1fr;gap:20px;margin:20px 0">
            <!-- Himpunan A -->
            <div style="background:#e0d0c8;border-radius:8px;padding:16px">
              <h3 style="color:#8b6b5a;margin-top:0;text-align:center">üë® Pemain Putra (Himpunan A)</h3>
              <div id="daftarPutra" style="display:flex;flex-direction:column;gap:8px">
                <button class="atlet-btn" data-atlet="Andi" onclick="clickAtletPutra('Andi')" style="background:#b89888;color:#f5f0e8;padding:12px;border:none;border-radius:6px;cursor:pointer;font-weight:700;transition:all 0.3s">
                  üë® Andi
                </button>
                <button class="atlet-btn" data-atlet="Budi" onclick="clickAtletPutra('Budi')" style="background:#b89888;color:#f5f0e8;padding:12px;border:none;border-radius:6px;cursor:pointer;font-weight:700;transition:all 0.3s">
                  üë® Budi
                </button>
                <button class="atlet-btn" data-atlet="Citra" onclick="clickAtletPutra('Citra')" style="background:#b89888;color:#f5f0e8;padding:12px;border:none;border-radius:6px;cursor:pointer;font-weight:700;transition:all 0.3s">
                  üë® Citra
                </button>
                <button class="atlet-btn" data-atlet="Dani" onclick="clickAtletPutra('Dani')" style="background:#b89888;color:#f5f0e8;padding:12px;border:none;border-radius:6px;cursor:pointer;font-weight:700;transition:all 0.3s">
                  üë® Dani
                </button>
              </div>
            </div>

            <!-- Himpunan B -->
            <div style="background:#d8c8d8;border-radius:8px;padding:16px">
              <h3 style="color:#7a6585;margin-top:0;text-align:center">üë© Pemain Putri (Himpunan B)</h3>
              <div id="daftarPutri" style="display:flex;flex-direction:column;gap:8px">
                <button class="atlet-btn-putri" data-atlet="Evi" onclick="clickAtletPutri('Evi')" style="background:#a8909b;color:#f5f0e8;padding:12px;border:none;border-radius:6px;cursor:pointer;font-weight:700;transition:all 0.3s">
                  üë© Evi
                </button>
                <button class="atlet-btn-putri" data-atlet="Fani" onclick="clickAtletPutri('Fani')" style="background:#a8909b;color:#f5f0e8;padding:12px;border:none;border-radius:6px;cursor:pointer;font-weight:700;transition:all 0.3s">
                  üë© Fani
                </button>
                <button class="atlet-btn-putri" data-atlet="Gita" onclick="clickAtletPutri('Gita')" style="background:#a8909b;color:#f5f0e8;padding:12px;border:none;border-radius:6px;cursor:pointer;font-weight:700;transition:all 0.3s">
                  üë© Gita
                </button>
                <button class="atlet-btn-putri" data-atlet="Hana" onclick="clickAtletPutri('Hana')" style="background:#a8909b;color:#f5f0e8;padding:12px;border:none;border-radius:6px;cursor:pointer;font-weight:700;transition:all 0.3s">
                  üë© Hana
                </button>
              </div>
            </div>
          </div>

          <div style="background:#f5e6d3;border-left:4px solid #d4a574;padding:16px;border-radius:8px;margin:20px 0">
            <p style="margin:0;color:#2a2420;font-weight:700">
              üìä Status Pasangan: <span id="statusPasangan">0/4 pemain putra sudah berpasangan</span>
            </p>
          </div>

          <div style="background:#f1f1f1;border-radius:8px;padding:16px;margin:20px 0">
            <h3 style="color:var(--accent);margin-top:0">üë• Hasil Pasangan Sementara</h3>
            <div id="hasilPasangan" style="min-height:80px;background:#e8dcc8;padding:12px;border-radius:6px;border:2px dashed #b89968">
              <p style="color:#999;text-align:center;margin:0">Belum ada pasangan. Klik atlet untuk memulai!</p>
            </div>
          </div>

          <button class="btn" id="btnLanjutAnalisis" onclick="show('perumusan-pengertian')" style="width:100%;padding:12px">Lanjut: Perumusan Pengertian ‚ü∂</button>

          <div class="footer-nav">
            <button class="btn ghost" onclick="show('identifikasi-himpunan')">‚üµ Kembali</button>
          </div>
        </div>
      </section>

      <!-- Slide 3.4: Perumusan Pengertian Berdasarkan Hasil Kerja -->
      <section class="slide" id="perumusan-pengertian">
        <div class="card-lite">
          <h2>‚úèÔ∏è Fase 3.4: Perumusan Pengertian Korespondensi Satu-Satu</h2>
          <p style="color:#2a2420;margin-bottom:20px">Berdasarkan hasil matching yang kalian lakukan, sekarang tulislah dengan kata-kata kalian sendiri: <strong>Apa itu Korespondensi Satu-Satu?</strong></p>

          <div class="scenario-box" style="background:#c8d8c8;border-left:4px solid #9ac2a8">
            <h3 style="color:#2a2420;margin-top:0">üìå Hasil Matching Kalian</h3>
            <div id="ringkasanMatching" style="background:#e8dcc8;padding:12px;border-radius:6px;margin:12px 0"></div>
            <p style="color:#2a2420;font-size:14px;margin:8px 0"><strong>Pengamatan:</strong> Setiap pemain putra berpasangan dengan TEPAT SATU pemain putri, dan tidak ada pemain yang berpasangan dengan lebih dari satu orang. Ini adalah karakteristik Korespondensi Satu-Satu!</p>
          </div>

          <div class="scenario-box" style="background:#f3e5f5;border-left:4px solid #9c27b0">
            <h3 style="color:#2a2420;margin-top:0">‚ùì Pertanyaan Perumusan</h3>
            
            <div style="margin:16px 0">
              <p style="margin:8px 0;color:#2a2420;font-size:15px;font-weight:700">1. Berdasarkan hasil matching kalian, tuliskan pengertian Korespondensi Satu-Satu dengan bahasa kalian sendiri:</p>
              <textarea id="pengertianSiswa" placeholder="Contoh: Korespondensi satu-satu adalah relasi di mana setiap anggota dari himpunan A berpasangan dengan... dan sebaliknya..." style="width:100%;padding:12px;border-radius:8px;border:2px solid #d1d5db;font-family:Arial,sans-serif;font-size:14px;box-sizing:border-box;min-height:100px"></textarea>
            </div>

            <div style="margin:16px 0">
              <p style="margin:8px 0;color:#2a2420;font-size:15px;font-weight:700">2. Apa ciri-ciri utama dari korespondensi satu-satu? (Pilih semua yang benar)</p>
              <div style="display:flex;flex-direction:column;gap:10px;margin:8px 0">
                <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size:14px">
                  <input type="checkbox" value="ciri1" onchange="pilihCiri(this)"> Setiap anggota himpunan A berpasangan dengan TEPAT SATU anggota himpunan B
                </label>
                <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size:14px">
                  <input type="checkbox" value="ciri2" onchange="pilihCiri(this)"> Setiap anggota himpunan B berpasangan dengan TEPAT SATU anggota himpunan A
                </label>
                <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size:14px">
                  <input type="checkbox" value="ciri3" onchange="pilihCiri(this)"> Himpunan A dan himpunan B harus memiliki jumlah anggota yang SAMA
                </label>
                <label style="display:flex;align-items:center;gap:8px;cursor:pointer;font-size:14px">
                  <input type="checkbox" value="ciri4" onchange="pilihCiri(this)"> Tidak ada anggota yang tidak terpasang
                </label>
              </div>
            </div>
          </div>

          <button class="btn" onclick="cekPengertianSiswa()" style="width:100%;padding:12px">‚úì Validasi Perumusan Saya</button>
          <div id="feedbackPengertian" class="feedback-box"></div>

          <button class="btn" id="btnLanjutAnalisis2" onclick="show('analisis-pola')" style="width:100%;padding:12px;margin-top:12px">Lanjut: Analisis Pola & Perhitungan ‚ü∂</button>

          <div class="footer-nav">
            <button class="btn ghost" onclick="show('eksplorasi-interaktif')">‚üµ Kembali</button>
          </div>
        </div>
      </section>

      <!-- Slide 3.5: Analisis Pola & Perhitungan -->
      <section class="slide" id="analisis-pola">
        <div class="card-lite">
          <h2>üìä Fase 3.5: Analisis Pola & Perhitungan (HOTS - C4)</h2>
          <p style="color:#2a2420;margin-bottom:20px">Mari kita analisis berapa banyak kemungkinan pasangan yang bisa dibentuk menggunakan pola kombinatorial.</p>

          <div class="scenario-box" style="background:#e8f5e9;border-left:4px solid #4caf50">
            <h3 style="color:#2e7d32;margin-top:0">üéØ Analisis Langkah-demi-Langkah</h3>
            
            <div style="margin:16px 0;padding:12px;background:#f9f5f0;border-radius:6px;border-left:4px solid #4caf50">
              <p style="margin:0 0 8px 0;color:var(--accent);font-weight:700">Langkah 1: Pilihan untuk Pemain Putra 1 (Andi)</p>
              <p style="margin:0;color:#2a2420">‚ùì Andi bisa berpasangan dengan berapa pemain putri?</p>
              <input type="text" id="pilihan1" placeholder="Masukkan angka" style="width:100%;padding:10px;margin-top:8px;border-radius:6px;border:2px solid #d1d5db;font-size:15px;box-sizing:border-box">
              <small style="color:#2a2420;margin-top:4px;display:block">Jawaban: 4</small>
            </div>

            <div style="margin:16px 0;padding:12px;background:#f9f5f0;border-radius:6px;border-left:4px solid #4caf50">
              <p style="margin:0 0 8px 0;color:var(--accent);font-weight:700">Langkah 2: Pilihan untuk Pemain Putra 2 (Budi)</p>
              <p style="margin:0;color:#2a2420">‚ùì Setelah Andi dipasangkan dengan 1 pemain putri, Budi punya berapa pilihan?</p>
              <input type="text" id="pilihan2" placeholder="Masukkan angka" style="width:100%;padding:10px;margin-top:8px;border-radius:6px;border:2px solid #d1d5db;font-size:15px;box-sizing:border-box">
              <small style="color:#2a2420;margin-top:4px;display:block">Jawaban: 3</small>
            </div>

            <div style="margin:16px 0;padding:12px;background:#f9f5f0;border-radius:6px;border-left:4px solid #4caf50">
              <p style="margin:0 0 8px 0;color:var(--accent);font-weight:700">Langkah 3: Pilihan untuk Pemain Putra 3 (Citra)</p>
              <p style="margin:0;color:#2a2420">‚ùì Citra punya berapa pilihan?</p>
              <input type="text" id="pilihan3" placeholder="Masukkan angka" style="width:100%;padding:10px;margin-top:8px;border-radius:6px;border:2px solid #d1d5db;font-size:15px;box-sizing:border-box">
              <small style="color:#2a2420;margin-top:4px;display:block">Jawaban: 2</small>
            </div>

            <div style="margin:16px 0;padding:12px;background:#f9f5f0;border-radius:6px;border-left:4px solid #4caf50">
              <p style="margin:0 0 8px 0;color:var(--accent);font-weight:700">Langkah 4: Pilihan untuk Pemain Putra 4 (Dani)</p>
              <p style="margin:0;color:#2a2420">‚ùì Dani punya berapa pilihan?</p>
              <input type="text" id="pilihan4" placeholder="Masukkan angka" style="width:100%;padding:10px;margin-top:8px;border-radius:6px;border:2px solid #d1d5db;font-size:15px;box-sizing:border-box">
              <small style="color:#2a2420;margin-top:4px;display:block">Jawaban: 1</small>
            </div>
          </div>

          <div class="scenario-box" style="background:#fff3e0;border-left:4px solid #ff9800">
            <h3 style="color:#2a2420;margin-top:0">üßÆ Rumus Perhitungan</h3>
            <p style="margin:8px 0;color:#2a2420;font-size:16px">
              Total kemungkinan pasangan = Pilihan 1 √ó Pilihan 2 √ó Pilihan 3 √ó Pilihan 4
            </p>
            <p style="margin:8px 0;color:#2a2420;font-size:16px;background:#f9f5f0;padding:12px;border-radius:6px;font-weight:700">
              = 4 √ó 3 √ó 2 √ó 1 = ?
            </p>
            <p style="margin:8px 0;color:#2a2420;font-size:16px;font-weight:700">
              Rumus: n! (n faktorial), dimana n = 4
            </p>
          </div>

          <div style="margin:20px 0;padding:16px;background:#f5f5f5;border-radius:8px">
            <h3 style="color:var(--accent);margin-top:0">üìù Pertanyaan Final</h3>
            <p style="margin:8px 0;color:#2a2420;font-size:16px;font-weight:700">Berapa total kemungkinan pasangan yang dapat dibentuk?</p>
            <input type="text" id="totalPasangan" placeholder="Masukkan angka" style="width:100%;padding:12px;border-radius:8px;border:2px solid #d1d5db;font-size:15px;box-sizing:border-box;margin-top:8px">
          </div>

          <button class="btn" onclick="cekJawabanAnalisis()" style="width:100%;padding:12px">‚úì Cek Jawaban Analisis</button>
          <div id="feedbackAnalisis" class="feedback-box"></div>

          <button class="btn" id="btnLanjutValidasi" onclick="show('diagram-panah')" style="width:100%;padding:12px;margin-top:12px">Lanjut ke Fase 4: Penyajian Hasil Karya ‚ü∂</button>

          <div class="footer-nav">
            <button class="btn ghost" onclick="show('perumusan-pengertian')">‚üµ Kembali</button>
          </div>
        </div>
      </section>

      <!-- FASE 4: PENYAJIAN HASIL KARYA -->

      <!-- Slide 4.1: Diagram Panah -->
      <section class="slide" id="diagram-panah">
        <div class="card-lite">
          <h2>üé® Fase 4.1: Diagram Panah - Visualisasi Pasangan Kalian</h2>
          <p style="color:#2a2420;margin-bottom:20px">Berikut adalah visualisasi diagram panah dari pasangan yang telah kalian bentuk!</p>

          <div class="scenario-box" style="background:#e3f2fd;border-left:4px solid #2196f3">
            <h3 style="color:#2a2420;margin-top:0">üìä Diagram Panah Korespondensi Satu-Satu</h3>
            <div id="containerDiagram" style="background:#e8dcc8;padding:20px;border-radius:8px;margin:12px 0">
              <div style="display:grid;grid-template-columns:1fr auto 1fr;gap:40px;align-items:center">
                <!-- Himpunan A -->
                <div style="background:#b09880;padding:16px;border-radius:8px;border:2px solid #8b6b5a">
                  <h4 style="color:#2a2420;margin-top:0;text-align:center">Himpunan A (Putra)</h4>
                  <div id="diagramA" style="display:flex;flex-direction:column;gap:12px"></div>
                </div>

                <!-- Panah -->
                <div id="diagramPanah" style="display:flex;flex-direction:column;gap:12px;justify-content:center"></div>

                <!-- Himpunan B -->
                <div style="background:#b09880;padding:16px;border-radius:8px;border:2px solid #8b6b5a">
                  <h4 style="color:#2a2420;margin-top:0;text-align:center">Himpunan B (Putri)</h4>
                  <div id="diagramB" style="display:flex;flex-direction:column;gap:12px"></div>
                </div>
              </div>
            </div>
            <p style="color:#2a2420;font-size:14px;margin:8px 0"><strong>Catatan:</strong> Setiap panah menunjukkan satu pasangan dalam korespondensi satu-satu.</p>
          </div>

          <button class="btn" onclick="show('pasangan-berurutan')" style="width:100%;padding:12px">Lanjut: Himpunan Pasangan Berurutan ‚ü∂</button>

          <div class="footer-nav">
            <button class="btn ghost" onclick="show('analisis-pola')">‚üµ Kembali</button>
          </div>
        </div>
      </section>

      <!-- Slide 4.2: Himpunan Pasangan Berurutan -->
      <section class="slide" id="pasangan-berurutan">
        <div class="card-lite">
          <h2>üìù Fase 4.2: Himpunan Pasangan Berurutan</h2>
          <p style="color:#2a2420;margin-bottom:20px">Korespondensi satu-satu dapat dinyatakan dalam bentuk himpunan pasangan berurutan.</p>

          <div class="scenario-box" style="background:#f3e5f5;border-left:4px solid #9c27b0">
            <h3 style="color:#2a2420;margin-top:0">üî¢ Notasi Himpunan Pasangan Berurutan</h3>
            <p style="color:#2a2420;font-size:15px;margin:8px 0">Pasangan berurutan ditulis dalam bentuk (a, b) dimana a ‚àà A dan b ‚àà B.</p>
            
            <div style="background:#e8dcc8;padding:16px;border-radius:8px;margin:12px 0">
              <p style="color:#2a2420;font-weight:700;margin:8px 0">Himpunan Pasangan Berurutan dari hasil matching kalian:</p>
              <div id="pasanganBerurutanText" style="background:#f9f5f0;padding:16px;border-radius:6px;margin:12px 0;font-size:18px;font-weight:700;text-align:center;color:#2a2420;font-family:Arial,sans-serif">
                <!-- Akan diisi otomatis -->
              </div>
            </div>

            <div style="background:#f9f5f0;padding:12px;border-radius:6px;margin:12px 0">
              <p style="color:#2a2420;font-size:14px;margin:4px 0"><strong>Jumlah Anggota Himpunan A:</strong> <span id="jumlahA">4</span></p>
              <p style="color:#2a2420;font-size:14px;margin:4px 0"><strong>Jumlah Anggota Himpunan B:</strong> <span id="jumlahB">4</span></p>
              <p style="color:#2a2420;font-size:14px;margin:4px 0"><strong>Jumlah Pasangan Terbentuk:</strong> <span id="jumlahPasangan">4</span></p>
            </div>
          </div>

          <button class="btn" onclick="show('tabel-korespondensi')" style="width:100%;padding:12px">Lanjut: Tabel Semua Kemungkinan ‚ü∂</button>

          <div class="footer-nav">
            <button class="btn ghost" onclick="show('diagram-panah')">‚üµ Kembali</button>
          </div>
        </div>
      </section>

      <!-- Slide 4.3: Tabel Korespondensi -->
      <section class="slide" id="tabel-korespondensi">
        <div class="card-lite">
          <h2>üìã Fase 4.3: Tabel Semua Kemungkinan Korespondensi Satu-Satu</h2>
          <p style="color:#2a2420;margin-bottom:20px">Ingat kembali: Ada <strong>24 kemungkinan</strong> pasangan berbeda yang dapat dibentuk (4! = 24). Berikut adalah tabel semua kemungkinan tersebut:</p>

          <div class="scenario-box" style="background:#e8f5e9;border-left:4px solid #4caf50">
            <h3 style="color:#2a2420;margin-top:0">üìä Tabel 24 Kemungkinan Korespondensi</h3>
            
            <div style="overflow-x:auto;margin:12px 0">
              <table id="tabelKorespondensi" style="width:100%;border-collapse:collapse;background:#e8dcc8;border-radius:8px">
                <!-- Akan diisi otomatis dengan JavaScript -->
              </table>
            </div>

            <div style="background:#f9f5f0;padding:12px;border-radius:6px;margin:12px 0">
              <p style="color:#2a2420;font-size:14px;margin:4px 0"><strong>Pasangan yang kalian pilih:</strong></p>
              <div id="pasanganKalian" style="background:#c8d8c8;padding:12px;border-radius:6px;margin:8px 0;border:3px solid #4caf50">
                <!-- Akan diisi otomatis -->
              </div>
            </div>
          </div>

          <button class="btn" onclick="show('kesimpulan-kelompok')" style="width:100%;padding:12px">Lanjut: Kesimpulan Kelompok ‚ü∂</button>

          <div class="footer-nav">
            <button class="btn ghost" onclick="show('pasangan-berurutan')">‚üµ Kembali</button>
          </div>
        </div>
      </section>

      <!-- Slide 4.4: Kesimpulan Kelompok -->
      <section class="slide" id="kesimpulan-kelompok">
        <div class="card-lite">
          <h2>‚úÖ Fase 4.4: Kesimpulan Kelompok</h2>
          <p style="color:#2a2420;margin-bottom:20px">Tuliskan kesimpulan kelompok kalian berdasarkan seluruh investigasi yang telah dilakukan!</p>

          <div class="scenario-box" style="background:#fff3e0;border-left:4px solid #d4a574">
            <h3 style="color:#2a2420;margin-top:0">üéØ Pertanyaan Refleksi</h3>
            
            <div style="margin:16px 0">
              <p style="margin:8px 0;color:#2a2420;font-size:15px;font-weight:700">1. Berapa banyak pasangan berbeda yang dapat dibentuk dari 4 pemain putra dan 4 pemain putri?</p>
              <textarea id="jawabanKesimpulan1" placeholder="Tuliskan jawabanmu..." style="width:100%;padding:14px;border-radius:8px;border:3px solid #6b5542;font-family:Arial,sans-serif;font-size:16px;box-sizing:border-box;min-height:90px;background:#ffffff;color:#2a2420;line-height:1.5"></textarea>
            </div>

            <div style="margin:16px 0">
              <p style="margin:8px 0;color:#2a2420;font-size:15px;font-weight:700">2. Apa yang kalian pahami tentang korespondensi satu-satu setelah melakukan investigasi ini?</p>
              <textarea id="jawabanKesimpulan2" placeholder="Tuliskan pemahamanmu..." style="width:100%;padding:14px;border-radius:8px;border:3px solid #6b5542;font-family:Arial,sans-serif;font-size:16px;box-sizing:border-box;min-height:110px;background:#ffffff;color:#2a2420;line-height:1.5"></textarea>
            </div>

            <div style="margin:16px 0">
              <p style="margin:8px 0;color:#2a2420;font-size:15px;font-weight:700">3. Sebutkan contoh lain dari korespondensi satu-satu dalam kehidupan sehari-hari!</p>
              <textarea id="jawabanKesimpulan3" placeholder="Contoh: Setiap orang dengan KTP-nya..." style="width:100%;padding:14px;border-radius:8px;border:3px solid #6b5542;font-family:Arial,sans-serif;font-size:16px;box-sizing:border-box;min-height:110px;background:#ffffff;color:#2a2420;line-height:1.5"></textarea>
            </div>
          </div>

          <button class="btn" onclick="simpanKesimpulan()" style="width:100%;padding:12px">‚úì Simpan Kesimpulan</button>
          <div id="feedbackKesimpulan" class="feedback-box"></div>

          <button class="btn" onclick="show('penyajian-hasil-karya')" style="width:100%;padding:12px;margin-top:12px">Lanjut: Penyajian Hasil Karya ‚ü∂</button>

          <div class="footer-nav">
            <button class="btn ghost" onclick="show('tabel-korespondensi')">‚üµ Kembali</button>
          </div>
        </div>
      </section>

      <!-- Slide 4.5: PENYAJIAN HASIL KARYA (GALLERY WALK) -->
      <section class="slide" id="penyajian-hasil-karya">
        <div class="card-lite">
          <h2>üé® Fase 4: Penyajian Hasil Karya (Gallery Walk)</h2>
          <p style="color:#2a2420;margin-bottom:20px">Presentasikan hasil investigasi korespondensi satu-satu kelompokmu! Pilih bentuk penyajian yang paling menarik.</p>

          <!-- BAGIAN A: PILIH BENTUK PENYAJIAN -->
          <div class="card-lite">
            <h3 style="color:var(--accent);margin-bottom:12px">üìä A. Pilih Bentuk Penyajian Investigasi</h3>
            <p style="color:var(--muted);font-size:14px;margin-bottom:12px">
              Kelompokmu sudah menemukan bahwa ada 24 kemungkinan pasangan. Pilih cara terbaik untuk menyajikannya:
            </p>
            
            <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-bottom:16px">
              <label class="penyajian-option">
                <input type="radio" name="bentukPenyajianKorespondensi" value="diagram-panah" checked>
                <span>üéØ Diagram Panah</span>
              </label>
              <label class="penyajian-option">
                <input type="radio" name="bentukPenyajianKorespondensi" value="tabel-lengkap">
                <span>üìã Tabel 24 Kemungkinan</span>
              </label>
              <label class="penyajian-option">
                <input type="radio" name="bentukPenyajianKorespondensi" value="cerita-visual">
                <span>üìñ Cerita + Visual</span>
              </label>
              <label class="penyajian-option">
                <input type="radio" name="bentukPenyajianKorespondensi" value="infografis">
                <span>üé® Infografis Kreatif</span>
              </label>
            </div>

            <textarea id="deskripsiPenyajianKorespondensi" 
              placeholder="Jelaskan mengapa bentuk penyajian ini dipilih... (contoh: Kami pilih diagram panah karena paling mudah terlihat hubungan satu-satu antara putra dan putri)"
              style="width:100%;padding:12px;border-radius:8px;border:2px solid #ddd;font-family:Arial;min-height:80px"></textarea>

            <button class="btn" id="btnSimpanPenyajianKorespondensi" style="margin-top:12px">üíæ Simpan Penyajian Kami</button>
            <div id="feedbackPenyajianKorespondensi" style="margin-top:12px"></div>
          </div>

          <!-- BAGIAN B: GALLERY WALK - KOMENTAR DARI KELOMPOK LAIN -->
          <div class="card-lite" style="margin-top:20px">
            <h3 style="color:var(--accent);margin-bottom:12px">üë• B. Gallery Walk: Berikan Saran</h3>
            <p style="color:var(--muted);font-size:14px;margin-bottom:12px">
              Kunjungi hasil karya kelompok lain dan berikan saran yang membangun!
            </p>

            <div style="display:flex;gap:12px;margin-bottom:16px">
              <input type="text" id="namaKelompokKomentarKorespondensi" 
                placeholder="Nama Kelompokmu"
                style="flex:1;padding:10px;border-radius:8px;border:2px solid #ddd">
            </div>

            <textarea id="komentarPeerReviewKorespondensi" 
              placeholder="Berikan saran untuk kelompok ini... (contoh: Penjelasan kalian sangat jelas! Tapi coba tambahkan jumlah total kemungkinan pasangan di diagram)"
              style="width:100%;padding:12px;border-radius:8px;border:2px solid #ddd;font-family:Arial;min-height:100px"></textarea>

            <button class="btn" id="btnKirimKomentarKorespondensi" style="margin-top:12px">üí¨ Kirim Saran</button>

            <!-- DAFTAR KOMENTAR -->
            <div id="daftarKomentarKorespondensi" style="margin-top:20px">
              <h4 style="color:var(--accent);margin-bottom:12px">üìù Saran dari Kelompok Lain:</h4>
              <div id="komentarListKorespondensi" style="max-height:300px;overflow-y:auto">
                <p style="color:var(--muted);font-style:italic">Belum ada saran. Jadilah yang pertama!</p>
              </div>
            </div>
          </div>

          <!-- NAVIGASI -->
          <div style="display:flex;gap:12px;justify-content:center;margin-top:24px;flex-wrap:wrap">
            <button class="btn ghost" onclick="show('kesimpulan-kelompok')">‚üµ Kembali</button>
            <button class="btn" onclick="show('ringkasan-akhir')">Lanjut: Ringkasan Akhir ‚ü∂</button>
          </div>
        </div>
      </section>

      <!-- Slide 4.5: Ringkasan Akhir -->
      <section class="slide" id="ringkasan-akhir">
        <div class="card-lite">
          <h2>üéâ Ringkasan Pembelajaran - Korespondensi Satu-Satu</h2>
          <p style="color:#2a2420;margin-bottom:20px">Selamat! Kalian telah menyelesaikan pembelajaran tentang Korespondensi Satu-Satu. Berikut adalah ringkasan perjalanan pembelajaran kalian:</p>

          <div class="scenario-box" style="background:#c8f0d4;border-left:5px solid #4caf50;box-shadow:0 4px 12px rgba(0,0,0,0.15)">
            <h3 style="color:#2a2420;margin-top:0;font-size:18px">‚úÖ JAWABAN PERMASALAHAN AWAL</h3>
            <div style="background:#fffacd;border:3px solid #ffd700;border-radius:8px;padding:14px;margin:12px 0">
              <p style="color:#2a2420;font-size:15px;line-height:1.6;margin:4px 0"><strong>Pertanyaan di awal:</strong></p>
              <p style="color:#d32f2f;font-size:15px;line-height:1.6;margin:8px 0;font-style:italic">
                "Berapa banyak pasangan berbeda yang dapat dibentuk dari 4 pemain putra dan 4 pemain putri jika setiap pemain harus berpasangan dengan TEPAT SATU pemain lainnya?"
              </p>
            </div>
            <div style="background:#e8f5e9;border:3px solid #4caf50;border-radius:8px;padding:16px;margin:12px 0">
              <p style="color:#2a2420;font-size:16px;line-height:1.8;margin:4px 0"><strong>üéØ Jawaban:</strong></p>
              <p style="color:#1b5e20;font-size:18px;line-height:1.8;margin:8px 0;font-weight:700">
                Ada <span style="background:#ffd700;padding:4px 12px;border-radius:6px;color:#d32f2f">24 pasangan berbeda</span> yang dapat dibentuk!
              </p>
              <p style="color:#2a2420;font-size:15px;line-height:1.6;margin:8px 0">
                Mengapa? Karena untuk korespondensi satu-satu dari 4 pemain putra ke 4 pemain putri, kita menghitung dengan rumus faktorial: <strong>4! = 4 √ó 3 √ó 2 √ó 1 = 24</strong>
              </p>
              <ul style="color:#2a2420;font-size:14px;line-height:1.6;margin:8px 0 8px 20px">
                <li>Pemain putra pertama bisa memilih 4 pemain putri</li>
                <li>Pemain putra kedua bisa memilih 3 pemain putri (1 sudah terpasang)</li>
                <li>Pemain putra ketiga bisa memilih 2 pemain putri (2 sudah terpasang)</li>
                <li>Pemain putra keempat otomatis dengan 1 pemain putri tersisa</li>
              </ul>
              <p style="color:#1b5e20;font-size:15px;line-height:1.6;margin:8px 0;font-weight:700;text-align:center">
                Total: 4 √ó 3 √ó 2 √ó 1 = 24 kemungkinan pasangan!
              </p>
            </div>
          </div>

          <div class="scenario-box" style="background:#e3f2fd;border-left:4px solid #2196f3">
            <h3 style="color:#2a2420;margin-top:0">üìö Apa yang Telah Kalian Pelajari?</h3>
            <div style="background:#f9f5f0;padding:16px;border-radius:6px;margin:12px 0">
              <p style="color:#2a2420;font-size:15px;margin:8px 0"><strong>‚úì Fase 1:</strong> Memahami permasalahan turnamen badminton ganda campuran</p>
              <p style="color:#2a2420;font-size:15px;margin:8px 0"><strong>‚úì Fase 2:</strong> Mengidentifikasi himpunan A (pemain putra) dan B (pemain putri)</p>
              <p style="color:#2a2420;font-size:15px;margin:8px 0"><strong>‚úì Fase 3:</strong> Menemukan konsep korespondensi satu-satu melalui matching interaktif</p>
              <p style="color:#2a2420;font-size:15px;margin:8px 0"><strong>‚úì Fase 4:</strong> Menghitung total kemungkinan (4! = 24) dan memvisualisasikan hasil</p>
            </div>
          </div>

          <div class="scenario-box" style="background:#e8f5e9;border-left:4px solid #4caf50">
            <h3 style="color:#2a2420;margin-top:0">üí° Konsep Kunci</h3>
            <div style="background:#f9f5f0;padding:16px;border-radius:6px;margin:12px 0">
              <p style="color:#2a2420;font-size:15px;margin:8px 0;line-height:1.6">
                <strong>Korespondensi Satu-Satu</strong> adalah relasi antara dua himpunan dimana setiap anggota himpunan A dipasangkan dengan TEPAT SATU anggota himpunan B, dan sebaliknya.
              </p>
              <p style="color:#2a2420;font-size:15px;margin:8px 0;line-height:1.6">
                <strong>Banyaknya korespondensi satu-satu</strong> dari himpunan dengan n anggota adalah <strong>n!</strong> (n faktorial).
              </p>
            </div>
          </div>

          <div class="scenario-box" style="background:#f3e5f5;border-left:4px solid #9c27b0">
            <h3 style="color:#2a2420;margin-top:0">üë• Data Kelompok Kalian</h3>
            <div id="ringkasanKelompok" style="background:#e8dcc8;padding:16px;border-radius:6px;margin:12px 0">
              <!-- Akan diisi otomatis -->
            </div>
          </div>

          <!-- Tombol Kirim ke Guru (UTAMA) -->
          <div style="background:#fff3cd;border:3px solid #ffc107;border-radius:12px;padding:20px;margin:20px 0;text-align:center;">
            <h3 style="color:#2a2420;margin-top:0">üìß Kirim Hasil ke Guru</h3>
            <p style="color:#666;margin:10px 0;font-size:14px;">
              Klik tombol di bawah untuk mengirim hasil pembelajaran langsung ke guru Anda
            </p>
            <button class="btn" onclick="kirimKeGuru()" style="width:100%;padding:16px;background:#ff9800;color:white;font-size:18px;font-weight:bold;box-shadow:0 4px 12px rgba(255,152,0,0.4)">
              üì§ Kirim ke Guru Sekarang
            </button>
            <div id="kirimStatus" class="status-message" style="display:none;margin-top:15px;"></div>
            <p style="font-size:12px;color:#999;margin-top:15px;">
              Hasil akan dikirim ke: <strong id="emailGuruDisplay">Loading...</strong><br>
              <a href="#" onclick="showEmailSetup(); return false;" style="color:#ff9800;text-decoration:none;">‚öôÔ∏è Setup Email Guru</a>
            </p>
          </div>
          
          <!-- Opsi Download PDF (Opsional) -->
          <details style="margin:20px 0;">
            <summary style="cursor:pointer;padding:12px;background:#e0e0e0;border-radius:8px;font-weight:bold;color:#333;">
              üì• Opsi Lain: Download PDF atau Upload Google Drive
            </summary>
            <div style="padding:15px;background:#f5f5f5;border-radius:0 0 8px 8px;margin-top:-5px;">
              <button class="btn" onclick="downloadHasil()" style="width:100%;padding:12px;background:#4caf50;color:white;margin-bottom:10px">
                üì• Download Hasil (PDF)
              </button>
              
              <div id="uploadOptionsSection" class="gdrive-section" style="display:none;margin-top:10px;">
                <h4 style="color:#333;margin-top:0;font-size:16px;">Upload ke Google Drive:</h4>
                
                <div class="btn-group">
                  <button class="gdrive-btn" onclick="uploadToGoogleDrive()">
                    <svg width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                      <path d="M19.35 10.04L16.21 4.41C15.93 3.89 15.39 3.56 14.81 3.56H9.19C8.61 3.56 8.07 3.89 7.79 4.41L4.65 10.04C4.37 10.56 4.37 11.21 4.65 11.73L7.79 17.36C8.07 17.88 8.61 18.21 9.19 18.21H14.81C15.39 18.21 15.93 17.88 16.21 17.36L19.35 11.73C19.63 11.21 19.63 10.56 19.35 10.04Z"/>
                    </svg>
                    Upload ke Google Drive
                  </button>
                </div>
                
                <div id="uploadStatus" class="status-message" style="display:none;margin-top:15px;"></div>
              </div>
            </div>
          </details>

          <p style="text-align:center;margin-top:30px;color:#2a2420;font-size:18px;font-weight:700">
            üéì Terima kasih telah mengikuti pembelajaran ini!
          </p>
          
          <div class="footer-nav" style="margin-top:20px">
            <button class="btn ghost" onclick="show('kesimpulan-kelompok')">‚üµ Kembali ke Kesimpulan</button>
            <button class="btn ghost" onclick="show('refleksi-individu')">üìù Lanjut: Refleksi Individu ‚ü∂</button>
            <button class="btn ghost" onclick="show('start')">üè† Kembali ke Awal</button>
          </div>
        </div>
      </section>

      <!-- Slide: Bagian G - REFLEKSI INDIVIDU -->
      <section class="slide" id="refleksi-individu">
        <div class="card-lite">
          <h2>‚ú® Bagian G: Refleksi Individu</h2>
          <p style="color:#2a2420;margin-bottom:20px">Setiap siswa perlu merenungkan proses pembelajaran mereka secara mendalam. Jawab pertanyaan-pertanyaan berikut dengan jujur dan detail!</p>

          <div class="scenario-box" style="background:#e8f5e9;border-left:5px solid #4caf50;box-shadow:0 4px 12px rgba(0,0,0,0.1)">
            
            <!-- Pertanyaan 1 -->
            <div style="margin:20px 0;padding:16px;background:#fff9e6;border-radius:8px;border-left:4px solid #ffb300">
              <p style="margin:0 0 12px 0;color:#2a2420;font-size:16px;font-weight:700">ü§î Pertanyaan 1: Apa yang membingungkan kamu dalam pembelajaran ini?</p>
              <p style="margin:8px 0 12px 0;color:#666;font-size:13px;font-style:italic">Jelaskan bagian mana yang sulit dipahami dan mengapa terasa membingungkan.</p>
              <textarea id="refleksi7" placeholder="Contoh: Awalnya saya bingung membedakan antara relasi biasa dan korespondensi satu-satu..." 
                style="width:100%;padding:14px;border-radius:8px;border:2px solid #ffb300;font-family:Arial,sans-serif;font-size:14px;box-sizing:border-box;min-height:100px;background:#fffef2;color:#2a2420;line-height:1.5"></textarea>
            </div>

            <!-- Pertanyaan 2 -->
            <div style="margin:20px 0;padding:16px;background:#ffe8e6;border-radius:8px;border-left:4px solid #ff6b6b">
              <p style="margin:0 0 12px 0;color:#2a2420;font-size:16px;font-weight:700">‚ö†Ô∏è Pertanyaan 2: Kesalahan apa yang pernah kamu buat selama pembelajaran ini?</p>
              <p style="margin:8px 0 12px 0;color:#666;font-size:13px;font-style:italic">Sebutkan kesalahan dalam berpikir atau penghitungan, lalu jelaskan bagaimana kamu menyadarinya.</p>
              <textarea id="refleksi8" placeholder="Contoh: Saya awalnya menghitung 4 √ó 4 = 16, tapi seharusnya 4! = 24 karena..." 
                style="width:100%;padding:14px;border-radius:8px;border:2px solid #ff6b6b;font-family:Arial,sans-serif;font-size:14px;box-sizing:border-box;min-height:100px;background:#fef5f4;color:#2a2420;line-height:1.5"></textarea>
            </div>

            <!-- Pertanyaan 3 -->
            <div style="margin:20px 0;padding:16px;background:#e3f2fd;border-radius:8px;border-left:4px solid #2196f3">
              <p style="margin:0 0 12px 0;color:#2a2420;font-size:16px;font-weight:700">üå± Pertanyaan 3: Apa yang masih perlu kamu pelajari lebih lanjut tentang korespondensi satu-satu?</p>
              <p style="margin:8px 0 12px 0;color:#666;font-size:13px;font-style:italic">Identifikasi area yang belum sepenuhnya kamu kuasai dan apa yang ingin kamu pelajari lebih dalam.</p>
              <textarea id="refleksi9" placeholder="Contoh: Saya ingin belajar lebih banyak tentang hubungan faktorial dengan permutasi..." 
                style="width:100%;padding:14px;border-radius:8px;border:2px solid #2196f3;font-family:Arial,sans-serif;font-size:14px;box-sizing:border-box;min-height:100px;background:#f5fafe;color:#2a2420;line-height:1.5"></textarea>
            </div>

          </div>

          <button class="btn" onclick="simpanRefleksiIndividu()" style="width:100%;padding:14px;margin-top:20px;font-size:16px">‚úì Simpan Refleksi Individu Saya</button>
          <div id="feedbackRefleksi" class="feedback-box" style="margin-top:12px"></div>

          <div class="footer-nav" style="margin-top:20px">
            <button class="btn ghost" onclick="show('ringkasan-akhir')">‚üµ Kembali ke Ringkasan</button>
            <button class="btn ghost" onclick="show('start')">üè† Kembali ke Awal</button>
          </div>
        </div>
      </section>
  </div>
</div>

<!-- Modal Setup Email -->
<div id="emailSetupModal" class="modal-overlay">
  <div class="modal-content">
    <div class="modal-header">
      <h2>‚öôÔ∏è Setup Email Guru</h2>
      <button class="close-modal" onclick="closeModal('emailSetupModal')">&times;</button>
    </div>
    
    <div style="background:#e3f2fd;border-left:4px solid #2196f3;padding:15px;border-radius:8px;margin:15px 0;">
      <p style="margin:0;color:#1565c0;font-size:14px;line-height:1.6;">
        <strong>‚ÑπÔ∏è Informasi:</strong> Setup email guru hanya perlu dilakukan SATU KALI. Semua siswa akan mengirim hasil pembelajaran ke email yang Anda setup di sini.
      </p>
    </div>
    
    <div class="input-group">
      <label>Email Guru (Wajib) *</label>
      <input type="email" id="email-guru-input" placeholder="guru@example.com">
      <small style="color:#666;font-size:12px;">Hasil pembelajaran siswa akan dikirim ke email ini</small>
    </div>
    
    <div style="background:#fff3cd;border-left:4px solid #ffc107;padding:15px;border-radius:8px;margin:15px 0;">
      <h4 style="margin-top:0;color:#856404;">üìã Metode Pengiriman:</h4>
      <p style="font-size:14px;color:#666;margin:8px 0;">
        <strong>FormSubmit</strong> - Mudah & langsung bisa digunakan (Direkomendasikan)
      </p>
      <p style="font-size:13px;color:#666;margin:4px 0;">
        ‚úÖ Tidak perlu registrasi<br>
        ‚úÖ Langsung kirim ke email guru<br>
        ‚ö†Ô∏è Siswa perlu verifikasi captcha sekali (untuk keamanan)
      </p>
    </div>
    
    <div class="btn-group">
      <button class="btn" onclick="saveEmailConfig()" style="background:#ff9800;">üíæ Simpan Email Guru</button>
      <button class="btn ghost" onclick="closeModal('emailSetupModal')">Batal</button>
    </div>
    
    <div style="background:#e8f5e9;border-left:4px solid #4caf50;padding:15px;border-radius:8px;margin:15px 0;">
      <p style="margin:0;color:#2e7d32;font-size:13px;line-height:1.6;">
        <strong>üí° Cara Kerja:</strong> Siswa klik "Kirim ke Guru" ‚Üí Tab baru terbuka ‚Üí Siswa centang "I'm not a robot" ‚Üí Klik Submit ‚Üí Email terkirim ke guru!
      </p>
    </div>
  </div>
</div>

<!-- Modal Setup Google Drive -->
<div id="gdriveSetupModal" class="modal-overlay">
  <div class="modal-content">
    <div class="modal-header">
      <h2>‚öôÔ∏è Setup Google Drive</h2>
      <button class="close-modal" onclick="closeModal('gdriveSetupModal')">&times;</button>
    </div>
    
    <div style="background:#fff3cd;border-left:4px solid #ffc107;padding:15px;border-radius:8px;margin:15px 0;">
      <p style="margin:0;color:#856404;font-size:14px;line-height:1.6;">
        <strong>‚ö†Ô∏è Perhatian:</strong> Untuk menggunakan fitur upload ke Google Drive, Anda perlu setup Google Cloud Project terlebih dahulu. Ini hanya perlu dilakukan SATU KALI oleh guru/admin.
      </p>
    </div>
    
    <div class="setup-steps">
      <h3>üìã Langkah-langkah Setup:</h3>
      <ol style="line-height:1.8;">
        <li>Buka <a href="https://console.cloud.google.com" target="_blank" style="color:#4285f4;">Google Cloud Console</a></li>
        <li>Buat project baru atau pilih project yang sudah ada</li>
        <li>Enable <strong>Google Drive API</strong> di Library</li>
        <li>Buat <strong>OAuth 2.0 Client ID</strong> (tipe: Web Application)</li>
        <li>Tambahkan <strong>Authorized JavaScript origins</strong>:
          <ul>
            <li><code>http://localhost</code></li>
            <li><code>file://</code> (untuk file lokal)</li>
            <li>URL hosting Anda (jika di-host online)</li>
          </ul>
        </li>
        <li>Salin <strong>Client ID</strong> dan <strong>API Key</strong></li>
        <li>Masukkan ke form di bawah ini</li>
      </ol>
      
      <p style="margin:10px 0;color:#666;font-size:14px;">
        üìö <a href="https://developers.google.com/drive/api/guides/enable-drive-api" target="_blank" style="color:#4285f4;">Tutorial Lengkap Google Drive API</a>
      </p>
    </div>
    
    <div class="input-group">
      <label>Google Client ID *</label>
      <input type="text" id="gdrive-client-id" placeholder="123456789.apps.googleusercontent.com">
    </div>
    
    <div class="input-group">
      <label>Google API Key *</label>
      <input type="text" id="gdrive-api-key" placeholder="AIzaSy...">
    </div>
    
    <div class="input-group">
      <label>Email Guru (opsional)</label>
      <input type="email" id="email-guru" placeholder="guru@example.com">
      <small style="color:#666;font-size:12px;">File akan otomatis di-share ke email ini</small>
    </div>
    
    <div class="input-group">
      <label>Folder ID Google Drive (opsional)</label>
      <input type="text" id="gdrive-folder-id" placeholder="1a2B3c4D5e...">
      <small style="color:#666;font-size:12px;">Kosongkan untuk menyimpan di root folder</small>
    </div>
    
    <div class="btn-group">
      <button class="btn" onclick="saveGDriveConfig()" style="background:#4285f4;">üíæ Simpan Konfigurasi</button>
      <button class="btn ghost" onclick="closeModal('gdriveSetupModal')">Batal</button>
    </div>
    
    <div style="background:#e8f5e9;border-left:4px solid #4caf50;padding:15px;border-radius:8px;margin:15px 0;">
      <p style="margin:0;color:#2e7d32;font-size:13px;line-height:1.6;">
        <strong>üí° Tips:</strong> Jika tidak ingin menggunakan Google Drive API, Anda bisa menggunakan opsi "Kirim via Email" untuk mengirim file PDF ke guru.
      </p>
    </div>
  </div>
</div>

<script>
// ============================================
// GLOBAL VARIABLES & INITIALIZATION
// ============================================

var currentSlide = 0;
var dataPasangan = {};
var pilihanPutra = null;
var ciriTerpilih = [];

// ============================================
// NAVIGATION FUNCTIONS
// ============================================

function show(id) {
  try {
    document.querySelectorAll('.slide').forEach(s => s.classList.remove('active'));
    var element = document.getElementById(id);
    if (element) {
      element.classList.add('active');
      window.scrollTo(0, 0);
      
      // Update current slide
      var slides = document.querySelectorAll('.slide');
      slides.forEach(function(slide, index) {
        if (slide.id === id) {
          currentSlide = index;
        }
      });
      
      // Generate ringkasan jika di slide ringkasan-akhir
      if (id === 'ringkasan-akhir') {
        generateRingkasanAkhir();
      }
    } else {
      console.error('Slide not found:', id);
    }
  } catch (error) {
    console.error('Error in show():', error);
  }
}

function nextSlide() {
  var slides = document.querySelectorAll('.slide');
  if (currentSlide < slides.length - 1) {
    currentSlide++;
    slides.forEach(function(slide, index) {
      slide.classList.remove('active');
      if (index === currentSlide) {
        slide.classList.add('active');
      }
    });
    window.scrollTo(0, 0);
  }
}

function prevSlide() {
  var slides = document.querySelectorAll('.slide');
  if (currentSlide > 0) {
    currentSlide--;
    slides.forEach(function(slide, index) {
      slide.classList.remove('active');
      if (index === currentSlide) {
        slide.classList.add('active');
      }
    });
    window.scrollTo(0, 0);
  }
}

// ============================================
// DOM READY - INITIALIZE ALL EVENT LISTENERS
// ============================================

document.addEventListener('DOMContentLoaded', function() {
  console.log('DOM Content Loaded');
  
  // Initialize dengan 1 anggota
  tambahAnggota();
  
  // Event listener untuk simpan kelompok
  var btnSimpanKelompok = document.getElementById('btnSimpanKelompok');
  if (btnSimpanKelompok) {
    btnSimpanKelompok.addEventListener('click', simpanDataKelompok);
  }
  
  // Setup atlet buttons untuk Fase 3.3
  setupAtletButtons();
  
  // Initialize session
  loadSessionFromStorage();
  if (!sessionData.startTime) {
    initializeSession();
  }
});

// ============================================
// IDENTITAS KELOMPOK
// ============================================

function tambahAnggota() {
  try {
    var container = document.getElementById('anggotaContainer');
    if (!container) return;
    
    if (container.querySelectorAll('.anggota-input').length >= 5) {
      alert('‚ö†Ô∏è Maksimal 5 anggota per kelompok.');
      return;
    }

    var inputDiv = document.createElement('div');
    inputDiv.className = 'anggota-input';
    inputDiv.innerHTML = '<input type="text" class="anggota-input-field" placeholder="Nama anggota..."><select class="tanggung-jawab-select" style="padding:10px;border-radius:8px;border:2px solid rgba(0,0,0,0.1);background:#fff;font-family:\'Bagel Fat One\',cursive;font-size:14px;min-width:150px"><option value="Ketua Kelompok">Ketua Kelompok</option><option value="Wakil Ketua">Wakil Ketua</option><option value="Sekretaris">Sekretaris</option><option value="Anggota Aktif">Anggota Aktif</option><option value="Anggota">Anggota</option></select><button type="button" onclick="removeAnggota(this)">‚ùå</button>';
    container.appendChild(inputDiv);
  } catch (error) {
    console.error('Error in tambahAnggota():', error);
  }
}

function removeAnggota(btn) {
  try {
    var container = document.getElementById('anggotaContainer');
    if (container && container.querySelectorAll('.anggota-input').length <= 1) {
      alert('‚ö†Ô∏è Minimal ada 1 anggota kelompok.');
      return;
    }
    btn.parentElement.remove();
  } catch (error) {
    console.error('Error in removeAnggota():', error);
  }
}

function simpanDataKelompok() {
  try {
    var namaKelompok = document.getElementById('namaKelompok');
    var feedbackKelompok = document.getElementById('feedbackKelompok');
    
    if (!namaKelompok || !feedbackKelompok) {
      console.error('Elements not found');
      return;
    }
    
    var namaKelompokValue = namaKelompok.value.trim();
    var anggotaContainers = document.querySelectorAll('.anggota-input');
    var anggota = Array.from(anggotaContainers).map(function(container) { 
      var namaInput = container.querySelector('.anggota-input-field');
      var tanggungJawabSelect = container.querySelector('.tanggung-jawab-select');
      var nama = namaInput?.value.trim();
      var tanggungJawab = tanggungJawabSelect?.value || 'Anggota';
      return nama ? { nama: nama, tanggungJawab: tanggungJawab } : null;
    }).filter(function(a) { return a; });

    if (!namaKelompokValue) {
      feedbackKelompok.textContent = '‚ö†Ô∏è Nama kelompok tidak boleh kosong!';
      feedbackKelompok.className = 'feedback-box warning';
      feedbackKelompok.style.display = 'block';
      return;
    }

    if (anggota.length === 0) {
      feedbackKelompok.textContent = '‚ö†Ô∏è Minimal ada 1 anggota kelompok!';
      feedbackKelompok.className = 'feedback-box warning';
      feedbackKelompok.style.display = 'block';
      return;
    }

    var resultData = {
      namaKelompok: namaKelompokValue,
      anggota: anggota,
      timestamp: new Date().toISOString()
    };

    localStorage.setItem('dataKelompok', JSON.stringify(resultData));

    // Simpan solusi awal jika ada
    var solusiAwal = document.getElementById('solusiAwalPertemuan5')?.value.trim();
    if (solusiAwal) {
      localStorage.setItem('solusiAwalPertemuan5', solusiAwal);
    }

    feedbackKelompok.textContent = '‚úÖ Data kelompok berhasil disimpan!';
    feedbackKelompok.className = 'feedback-box success';
    feedbackKelompok.style.display = 'block';

    console.log('Data saved:', resultData);
    
    // Auto-enable next button after 1 second
    setTimeout(function() {
      var nextBtn = document.querySelector('button[onclick="show(\'discovery-korespondensi\')"]');
      if (nextBtn) {
        nextBtn.style.opacity = '1';
        nextBtn.style.pointerEvents = 'auto';
      }
    }, 500);
  } catch (error) {
    console.error('Error in simpanDataKelompok():', error);
    alert('‚ö†Ô∏è Terjadi kesalahan saat menyimpan data.');
  }
}

// ======== FASE 3: INVESTIGASI & ANALISIS ========

// ===== FASE 3.1: DISCOVERY - Submit Hipotesis =====
function submitHipotesis() {
  var hipotesis = document.getElementById('hipotesisKorespondensi').value.trim();
  
  if (!hipotesis) {
    alert('‚ö†Ô∏è Silakan tulis hipotesis kalian terlebih dahulu!');
    return;
  }
  
  // Simpan hipotesis
  var dataKelompok = JSON.parse(localStorage.getItem('dataKelompok') || '{}');
  localStorage.setItem('hipotesisKorespondensi_' + (dataKelompok.namaKelompok || 'kelompok'), hipotesis);
  
  // Tampilkan pengertian yang benar
  document.getElementById('pengertianBenar').style.display = 'block';
  
  // Scroll ke pengertian
  document.getElementById('pengertianBenar').scrollIntoView({ behavior: 'smooth', block: 'start' });
  
  // Beri feedback
  alert('‚úÖ Hipotesis kalian telah tersimpan! Sekarang bandingkan dengan pengertian yang benar di bawah.');
}

// ===== FASE 3.1: DISCOVERY - Penemuan Korespondensi Satu-Satu =====
function pilihAnalisis(btn) {
  document.querySelectorAll('.analisis-btn').forEach(b => b.classList.remove('dipilih'));
  btn.classList.add('dipilih');
}

// ===== FASE 3.4: PERUMUSAN PENGERTIAN BERDASARKAN HASIL KERJA =====
function ringkasanHasilMatching() {
  var html = '';
  var count = 0;
  for (var putra in dataPasangan) {
    if (dataPasangan.hasOwnProperty(putra)) {
      count++;
      html += '<p style="margin:4px 0;font-size:14px">‚Ä¢ ' + putra + ' ‚Üî ' + dataPasangan[putra] + '</p>';
    }
  }
  
  if (count === 4) {
    html += '<p style="margin:12px 0;color:#4caf50;font-weight:700">‚úì Semua 4 pasangan telah terbentuk!</p>';
  }
  
  return html;
}

function pilihCiri(checkbox) {
  if (checkbox.checked) {
    ciriTerpilih.push(checkbox.value);
  } else {
    ciriTerpilih = ciriTerpilih.filter(c => c !== checkbox.value);
  }
}

function cekPengertianSiswa() {
  var pengertian = document.getElementById('pengertianSiswa').value.trim();
  var feedback = document.getElementById('feedbackPengertian');
  feedback.innerHTML = '';

  // Validasi: pengertian harus ada
  if (!pengertian) {
    feedback.innerHTML = '<p style="color:#c17070">‚ùå Tuliskan pengertian dengan kata-katamu sendiri ya!</p>';
    return;
  }

  // Validasi: minimal harus mengandung kata kunci
  var katakunci = ['satu', 'tepat', 'berpasang', 'setiap', 'himpunan'];
  var ketemu = katakunci.some(kata => pengertian.toLowerCase().includes(kata));

  if (!ketemu) {
    feedback.innerHTML = '<p style="color:#d4a574">‚ö†Ô∏è Pengertianmu sudah ada, tapi coba gunakan kata kunci: "satu", "tepat", "berpasangan", "setiap anggota", "himpunan"</p>';
    return;
  }

  // Validasi: harus memilih ciri 1, 2, 3, dan 4
  var ciriBenar = ['ciri1', 'ciri2', 'ciri3', 'ciri4'];
  var semuaCiri = ciriBenar.every(ciri => ciriTerpilih.includes(ciri));

  if (!semuaCiri) {
    feedback.innerHTML = '<p style="color:#d4a574">‚ö†Ô∏è Cek kembali pilihan ciri-ciri! Semua 4 ciri merupakan karakteristik korespondensi satu-satu.</p>';
    return;
  }

  // Berhasil!
  feedback.innerHTML = '<p style="color:#7ab89a">‚úÖ Sempurna! Pengertianmu sudah tepat!</p><p style="color:#6fa889;margin-top:8px"><strong>Kesimpulan:</strong> Korespondensi satu-satu adalah relasi yang memasangkan setiap anggota himpunan A dengan TEPAT SATU anggota himpunan B, dan sebaliknya.</p>';
  
  // Simpan hasil
  localStorage.setItem('pengertianSiswa_' + namaKelompok, pengertian);
  
  // Tampilkan tombol lanjut
  document.getElementById('btnLanjutAnalisis2').style.display = 'block';
}

// Saat halaman load, tampilkan ringkasan matching di slide Perumusan
window.addEventListener('DOMContentLoaded', () => {
  // Update ringkasan saat pindah ke slide perumusan
  var slidePerumusan = document.getElementById('perumusan-pengertian');
  if (slidePerumusan) {
    var ringkasanDiv = slidePerumusan.querySelector('#ringkasanMatching');
    if (ringkasanDiv) {
      ringkasanDiv.innerHTML = ringkasanHasilMatching();
    }
  }
  setupAtletButtons();
});

// Modifikasi function show yang ada untuk update ringkasan
var originalShow = show;
show = function(id) {
  originalShow(id);
  
  // Saat ke slide perumusan, update ringkasan
  if (id === 'perumusan-pengertian') {
    var ringkasanDiv = document.getElementById('ringkasanMatching');
    if (ringkasanDiv) {
      ringkasanDiv.innerHTML = ringkasanHasilMatching();
    }
  }
  
  // Saat ke Fase 4, generate visualisasi
  if (id === 'diagram-panah') {
    generateDiagramPanah();
  }
  if (id === 'pasangan-berurutan') {
    generatePasanganBerurutan();
  }
  if (id === 'tabel-korespondensi') {
    generateTabelKorespondensi();
  }
  if (id === 'ringkasan-akhir') {
    generateRingkasanAkhir();
  }
};

function cekPemahamanKorespondensi() {
  var jawabanContoh = null;
  document.querySelectorAll('.analisis-btn').forEach(btn => {
    if (btn.classList.contains('dipilih')) {
      jawabanContoh = btn.dataset.jawaban;
    }
  });
  var ciri = document.getElementById('ciriKorespondensi').value.trim();

  var feedback = document.getElementById('feedbackPenemuan');
  feedback.innerHTML = '';

  // Validasi: harus pilih contoh 1 atau 3
  if (!jawabanContoh || (jawabanContoh !== 'contoh1' && jawabanContoh !== 'contoh3')) {
    feedback.innerHTML = '<p style="color:#d32f2f">‚ùå Perhatikan kembali! Contoh 1 dan Contoh 3 menunjukkan relasi "satu-satu". Contoh 2 BUKAN satu-satu karena satu siswa ke banyak mata pelajaran.</p>';
    return;
  }

  // Validasi: ciri harus ada
  if (!ciri) {
    feedback.innerHTML = '<p style="color:#d32f2f">‚ùå Tuliskan ciri-ciri yang kamu temukan ya!</p>';
    return;
  }

  // Validasi: ciri harus mengandung kata kunci
  var katakunci = ['satu', 'tepat', 'unik', 'pasang', 'berpasang', 'setiap', 'sama banyak'];
  var ketemu = katakunci.some(kata => ciri.toLowerCase().includes(kata));

  if (!ketemu) {
    feedback.innerHTML = '<p style="color:#d4a574">‚ö†Ô∏è Ciri-cirimu sudah bagus, tapi coba tambahkan: Setiap anggota himpunan A berpasangan dengan TEPAT SATU anggota himpunan B, dan sebaliknya.</p>';
    return;
  }

  // Berhasil!
  feedback.innerHTML = '<p style="color:#388e3c">‚úÖ Sempurna! Kamu telah menemukan pengertian korespondensi satu-satu!</p><p style="color:#1b5e20;margin-top:8px"><strong>Kesimpulan:</strong> Korespondensi satu-satu adalah relasi yang memasangkan setiap anggota himpunan A dengan TEPAT SATU anggota himpunan B, dan sebaliknya setiap anggota himpunan B berpasangan dengan TEPAT SATU anggota himpunan A.</p>';
  
  // Simpan hasil discovery
  localStorage.setItem('ciriKorespondensi_' + namaKelompok, ciri);
  
  // Tampilkan tombol lanjut
  document.getElementById('btnLanjutIdentifikasi').style.display = 'block';
}

// Setup tombol atlet
// Atlet buttons initialized in main DOMContentLoaded

function setupAtletButtons() {
  try {
    console.log('setupAtletButtons called');
  } catch (error) {
    console.error('Error in setupAtletButtons:', error);
  }
}

// Handler untuk klik pemain putra
function clickAtletPutra(nama) {
  console.log('clickAtletPutra:', nama);
  
  // Jika sudah dipilih, reset
  if (pilihanPutra === nama) {
    pilihanPutra = null;
    document.querySelectorAll('.atlet-btn').forEach(b => b.classList.remove('dipilih'));
    console.log('Reset pilihan');
    return;
  }
  
  // Set pilihan putra
  pilihanPutra = nama;
  console.log('pilihanPutra now:', pilihanPutra);
  
  document.querySelectorAll('.atlet-btn').forEach(b => b.classList.remove('dipilih'));
  document.querySelectorAll('.atlet-btn').forEach(b => {
    if (b.textContent.includes(nama)) {
      b.classList.add('dipilih');
      b.style.background = '#9b6b5a';
    }
  });
}

// Handler untuk klik pemain putri
function clickAtletPutri(nama) {
  console.log('clickAtletPutri:', nama, 'pilihanPutra:', pilihanPutra);
  
  if (!pilihanPutra) {
    alert('‚ö†Ô∏è Pilih pemain putra terlebih dahulu!');
    return;
  }

  // Check apakah sudah berpasangan
  if (dataPasangan[pilihanPutra]) {
    alert(`‚ö†Ô∏è ${pilihanPutra} sudah berpasangan dengan ${dataPasangan[pilihanPutra]}`);
    return;
  }

  // Check apakah atlet putri sudah berpasangan
  const sudahBerpasangan = Object.values(dataPasangan).includes(nama);
  if (sudahBerpasangan) {
    alert(`‚ö†Ô∏è ${nama} sudah berpasangan!`);
    return;
  }

  // Buat pasangan
  dataPasangan[pilihanPutra] = nama;
  console.log('Pasangan dibuat:', dataPasangan);
  
  // Update UI
  updateStatusPasangan();
  updateHasilPasangan();
  
  // Reset pilihan
  pilihanPutra = null;
  document.querySelectorAll('.atlet-btn').forEach(b => {
    b.classList.remove('dipilih');
    b.style.background = '#b89888';
    
    if (dataPasangan[b.textContent.trim().substring(2)]) {
      b.classList.add('terpasang');
      b.style.background = '#7a6b5a';
    }
  });
  
  // Mark putri sebagai terpasang
  document.querySelectorAll('.atlet-btn-putri').forEach(b => {
    if (Object.values(dataPasangan).includes(b.textContent.trim().substring(2))) {
      b.classList.add('terpasang');
      b.style.background = '#8a8a8b';
    }
  });
}

function updateStatusPasangan() {
  const total = Object.keys(dataPasangan).length;
  document.getElementById('statusPasangan').textContent = `${total}/4 pemain putra sudah berpasangan`;
  
  if (total === 4) {
    document.getElementById('btnLanjutAnalisis').style.display = 'block';
  }
}

function updateHasilPasangan() {
  const hasilDiv = document.getElementById('hasilPasangan');
  
  if (Object.keys(dataPasangan).length === 0) {
    hasilDiv.innerHTML = '<p style="color:#999;text-align:center;margin:0">Belum ada pasangan. Klik atlet untuk memulai!</p>';
    return;
  }

  let html = '<div style="display:flex;flex-direction:column;gap:8px">';
  Object.entries(dataPasangan).forEach(([putra, putri]) => {
    html += `<div style="background:#f5f5f5;padding:8px;border-radius:4px;font-weight:700">üë® ${putra} ‚ÜîÔ∏è üë© ${putri}</div>`;
  });
  html += '</div>';
  
  hasilDiv.innerHTML = html;
}

function cekJawabanAnalisis() {
  const p1 = parseInt(document.getElementById('pilihan1').value) || 0;
  const p2 = parseInt(document.getElementById('pilihan2').value) || 0;
  const p3 = parseInt(document.getElementById('pilihan3').value) || 0;
  const p4 = parseInt(document.getElementById('pilihan4').value) || 0;
  const total = parseInt(document.getElementById('totalPasangan').value) || 0;

  const feedbackDiv = document.getElementById('feedbackAnalisis');

  if (p1 === 0 || p2 === 0 || p3 === 0 || p4 === 0 || total === 0) {
    feedbackDiv.textContent = '‚ö†Ô∏è Mohon lengkapi semua jawaban!';
    feedbackDiv.className = 'feedback-box warning';
    feedbackDiv.style.display = 'block';
    return;
  }

  let benar = 0;
  if (p1 === 4) benar++;
  if (p2 === 3) benar++;
  if (p3 === 2) benar++;
  if (p4 === 1) benar++;
  if (total === 24) benar++;

  if (benar === 5) {
    feedbackDiv.textContent = 'üéâ Sempurna! Semua jawaban benar! Total pasangan = 4! = 24';
    feedbackDiv.className = 'feedback-box success';
    document.getElementById('btnLanjutValidasi').style.display = 'block';
  } else {
    feedbackDiv.textContent = `‚ö†Ô∏è ${benar}/5 jawaban benar. Periksa kembali perhitunganmu!`;
    feedbackDiv.className = 'feedback-box warning';
  }
  
  feedbackDiv.style.display = 'block';
}

// ======== FASE 4: PENYAJIAN HASIL KARYA ========

// 4.1: Generate Diagram Panah
function generateDiagramPanah() {
  var diagramA = document.getElementById('diagramA');
  var diagramB = document.getElementById('diagramB');
  var diagramPanah = document.getElementById('diagramPanah');
  
  if (!diagramA || !diagramB || !diagramPanah) return;
  
  // Clear existing
  diagramA.innerHTML = '';
  diagramB.innerHTML = '';
  diagramPanah.innerHTML = '';
  
  // Generate items
  for (var putra in dataPasangan) {
    if (dataPasangan.hasOwnProperty(putra)) {
      var putri = dataPasangan[putra];
      
      // Item A
      var itemA = document.createElement('div');
      itemA.style.cssText = 'background:#e8dcc8;padding:8px 12px;border-radius:6px;text-align:center;font-size:14px;color:#2a2420;font-weight:700';
      itemA.textContent = 'üë® ' + putra;
      diagramA.appendChild(itemA);
      
      // Panah
      var arrow = document.createElement('div');
      arrow.style.cssText = 'font-size:24px;color:#4caf50;text-align:center';
      arrow.textContent = '‚Üí';
      diagramPanah.appendChild(arrow);
      
      // Item B
      var itemB = document.createElement('div');
      itemB.style.cssText = 'background:#e8dcc8;padding:8px 12px;border-radius:6px;text-align:center;font-size:14px;color:#2a2420;font-weight:700';
      itemB.textContent = 'üë© ' + putri;
      diagramB.appendChild(itemB);
    }
  }
}

// 4.2: Generate Pasangan Berurutan
function generatePasanganBerurutan() {
  var container = document.getElementById('pasanganBerurutanText');
  if (!container) return;
  
  var pasangan = [];
  for (var putra in dataPasangan) {
    if (dataPasangan.hasOwnProperty(putra)) {
      pasangan.push('(' + putra + ', ' + dataPasangan[putra] + ')');
    }
  }
  
  var text = '{ ' + pasangan.join(', ') + ' }';
  container.textContent = text;
  
  // Update jumlah
  document.getElementById('jumlahA').textContent = Object.keys(dataPasangan).length;
  document.getElementById('jumlahB').textContent = Object.keys(dataPasangan).length;
  document.getElementById('jumlahPasangan').textContent = pasangan.length;
}

// 4.3: Generate Tabel Korespondensi (24 kemungkinan)
function generateTabelKorespondensi() {
  var tabel = document.getElementById('tabelKorespondensi');
  if (!tabel) return;
  
  // Get all pemain
  var pemainPutra = Object.keys(dataPasangan);
  var pemainPutri = Object.values(dataPasangan);
  
  if (pemainPutra.length !== 4 || pemainPutri.length !== 4) {
    tabel.innerHTML = '<tr><td style="padding:20px;text-align:center;color:#d32f2f">‚ö†Ô∏è Mohon lengkapi semua pasangan terlebih dahulu!</td></tr>';
    return;
  }
  
  // Generate all permutations of pemainPutri
  var permutations = generatePermutations(pemainPutri);
  
  // Create table
  var html = '<thead><tr style="background:#6b5542;color:#f5f0e8">';
  html += '<th style="padding:10px;border:1px solid #8b6b5a">No</th>';
  for (var i = 0; i < pemainPutra.length; i++) {
    html += '<th style="padding:10px;border:1px solid #8b6b5a">' + pemainPutra[i] + '</th>';
  }
  html += '</tr></thead><tbody>';
  
  for (var p = 0; p < permutations.length; p++) {
    var isUserChoice = true;
    for (var i = 0; i < pemainPutra.length; i++) {
      if (dataPasangan[pemainPutra[i]] !== permutations[p][i]) {
        isUserChoice = false;
        break;
      }
    }
    
    var rowStyle = isUserChoice ? 'background:#c8d8c8;font-weight:700;border:3px solid #4caf50' : 'background:#f9f5f0';
    html += '<tr style="' + rowStyle + '">';
    html += '<td style="padding:8px;border:1px solid #8b6b5a;text-align:center;color:#2a2420">' + (p + 1) + '</td>';
    for (var i = 0; i < permutations[p].length; i++) {
      html += '<td style="padding:8px;border:1px solid #8b6b5a;text-align:center;color:#2a2420">' + permutations[p][i] + '</td>';
    }
    html += '</tr>';
  }
  
  html += '</tbody>';
  tabel.innerHTML = html;
  
  // Update pasangan kalian
  var pasanganKalianDiv = document.getElementById('pasanganKalian');
  if (pasanganKalianDiv) {
    var html2 = '';
    for (var i = 0; i < pemainPutra.length; i++) {
      html2 += '<p style="margin:4px 0;font-size:14px;color:#2a2420"><strong>' + pemainPutra[i] + '</strong> ‚Üî <strong>' + dataPasangan[pemainPutra[i]] + '</strong></p>';
    }
    pasanganKalianDiv.innerHTML = html2;
  }
}

// Helper: Generate all permutations
function generatePermutations(arr) {
  if (arr.length === 0) return [[]];
  if (arr.length === 1) return [arr];
  
  var result = [];
  for (var i = 0; i < arr.length; i++) {
    var current = arr[i];
    var remaining = arr.slice(0, i).concat(arr.slice(i + 1));
    var perms = generatePermutations(remaining);
    for (var j = 0; j < perms.length; j++) {
      result.push([current].concat(perms[j]));
    }
  }
  return result;
}

// 4.4: Simpan Kesimpulan
function simpanKesimpulan() {
  var jawaban1 = document.getElementById('jawabanKesimpulan1').value.trim();
  var jawaban2 = document.getElementById('jawabanKesimpulan2').value.trim();
  var jawaban3 = document.getElementById('jawabanKesimpulan3').value.trim();
  
  var feedback = document.getElementById('feedbackKesimpulan');
  
  if (!jawaban1 || !jawaban2 || !jawaban3) {
    feedback.textContent = '‚ö†Ô∏è Mohon isi semua pertanyaan refleksi!';
    feedback.className = 'feedback-box warning';
    feedback.style.display = 'block';
    return;
  }
  
  // Simpan ke localStorage
  var kesimpulan = {
    jawaban1: jawaban1,
    jawaban2: jawaban2,
    jawaban3: jawaban3,
    timestamp: new Date().toISOString()
  };
  
  localStorage.setItem('kesimpulanKelompok', JSON.stringify(kesimpulan));
  
  recordActivity('INPUT', 'Menyimpan kesimpulan pembelajaran', kesimpulan);
  
  feedback.textContent = '‚úÖ Kesimpulan berhasil disimpan!';
  feedback.className = 'feedback-box success';
  feedback.style.display = 'block';
}

// ======== BAGIAN G: REFLEKSI INDIVIDU ========
function simpanRefleksiIndividu() {
  var refleksi7 = document.getElementById('refleksi7').value.trim();
  var refleksi8 = document.getElementById('refleksi8').value.trim();
  var refleksi9 = document.getElementById('refleksi9').value.trim();
  
  var feedback = document.getElementById('feedbackRefleksi');
  
  if (!refleksi7 || !refleksi8 || !refleksi9) {
    feedback.textContent = '‚ö†Ô∏è Mohon isi semua pertanyaan refleksi individu!';
    feedback.className = 'feedback-box warning';
    feedback.style.display = 'block';
    return;
  }
  
  // Simpan ke localStorage
  var refleksiIndividu = {
    refleksi7: refleksi7,
    refleksi8: refleksi8,
    refleksi9: refleksi9,
    timestamp: new Date().toISOString()
  };
  
  localStorage.setItem('refleksiIndividuPertemuan5', JSON.stringify(refleksiIndividu));
  
  recordActivity('INPUT', 'Menyimpan refleksi individu', refleksiIndividu);
  
  feedback.textContent = '‚úÖ Refleksi individu berhasil disimpan! Terima kasih telah merenungkan pembelajaran Anda dengan mendalam.';
  feedback.className = 'feedback-box success';
  feedback.style.display = 'block';
}

// ======== FASE 4: PENYAJIAN HASIL KARYA (GALLERY WALK) ========
const btnSimpanPenyajianKorespondensi = document.getElementById('btnSimpanPenyajianKorespondensi');
const btnKirimKomentarKorespondensi = document.getElementById('btnKirimKomentarKorespondensi');
const feedbackPenyajianKorespondensi = document.getElementById('feedbackPenyajianKorespondensi');
const komentarListKorespondensi = document.getElementById('komentarListKorespondensi');

// Load komentar dari localStorage
let daftarKomentarKorespondensi = JSON.parse(localStorage.getItem('komentarPeerReviewKorespondensi') || '[]');

function tampilkanKomentarKorespondensi() {
  if (daftarKomentarKorespondensi.length === 0) {
    komentarListKorespondensi.innerHTML = '<p style="color:#999;font-style:italic">Belum ada saran. Jadilah yang pertama!</p>';
    return;
  }
  
  komentarListKorespondensi.innerHTML = daftarKomentarKorespondensi.map((k, idx) => `
    <div class="komentar-item">
      <div class="komentar-header">
        <span class="komentar-kelompok">üë• ${k.kelompok}</span>
        <span class="komentar-waktu">${k.waktu}</span>
      </div>
      <div class="komentar-isi">${k.komentar}</div>
    </div>
  `).join('');
}

// Simpan pilihan penyajian
btnSimpanPenyajianKorespondensi?.addEventListener('click', () => {
  const bentukPenyajian = document.querySelector('input[name="bentukPenyajianKorespondensi"]:checked')?.value;
  const deskripsi = document.getElementById('deskripsiPenyajianKorespondensi')?.value.trim();
  
  if (!deskripsi || deskripsi.length < 20) {
    feedbackPenyajianKorespondensi.innerHTML = '<div style="padding:12px;border-radius:8px;background:#fef3c7;border-left:4px solid #f7b500;color:#78350f;font-weight:600">‚ö†Ô∏è Jelaskan dulu mengapa memilih bentuk penyajian ini (minimal 20 karakter)!</div>';
    return;
  }
  
  const penyajian = {
    bentuk: bentukPenyajian,
    deskripsi: deskripsi,
    timestamp: new Date().toLocaleString('id-ID')
  };
  
  localStorage.setItem('penyajianKorespondensiKelompok', JSON.stringify(penyajian));
  
  feedbackPenyajianKorespondensi.innerHTML = `
    <div style="padding:12px;border-radius:8px;background:#d1fae5;border-left:4px solid #10b981;color:#065f46;font-weight:600">
      ‚úÖ Penyajian tersimpan! Kelompokmu memilih: <strong>${bentukPenyajian}</strong>
      <br><small>Sekarang kelompok lain bisa memberikan saran di Gallery Walk!</small>
    </div>
  `;
});

// Kirim komentar
btnKirimKomentarKorespondensi?.addEventListener('click', () => {
  const namaKelompok = document.getElementById('namaKelompokKomentarKorespondensi')?.value.trim();
  const komentar = document.getElementById('komentarPeerReviewKorespondensi')?.value.trim();
  
  if (!namaKelompok) {
    alert('‚ö†Ô∏è Tulis nama kelompokmu dulu!');
    return;
  }
  
  if (!komentar || komentar.length < 15) {
    alert('‚ö†Ô∏è Saran terlalu singkat! Berikan masukan yang membangun (minimal 15 karakter)');
    return;
  }
  
  const komentarBaru = {
    kelompok: namaKelompok,
    komentar: komentar,
    waktu: new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' })
  };
  
  daftarKomentarKorespondensi.push(komentarBaru);
  localStorage.setItem('komentarPeerReviewKorespondensi', JSON.stringify(daftarKomentarKorespondensi));
  
  // Reset input
  document.getElementById('komentarPeerReviewKorespondensi').value = '';
  
  // Tampilkan komentar
  tampilkanKomentarKorespondensi();
  
  // Notifikasi sukses
  alert(`‚úÖ Saran dari "${namaKelompok}" berhasil dikirim!`);
});

// Load komentar saat halaman dibuka
if (komentarListKorespondensi) {
  tampilkanKomentarKorespondensi();
}

// ============================================
// GENERATE RINGKASAN AKHIR
// ============================================

function generateRingkasanAkhir() {
  try {
    var container = document.getElementById('ringkasanKelompok');
    if (!container) {
      console.warn('ringkasanKelompok container not found');
      return;
    }
    
    var dataKelompok = JSON.parse(localStorage.getItem('dataKelompok') || '{}');
    
    var html = '<p style="color:#2a2420;font-size:15px;margin:4px 0"><strong>Nama Kelompok:</strong> ' + (dataKelompok.namaKelompok || '-') + '</p>';
    html += '<p style="color:#2a2420;font-size:15px;margin:4px 0"><strong>Anggota:</strong></p>';
    html += '<ul style="color:#2a2420;font-size:14px;margin:8px 0;padding-left:20px">';
    if (dataKelompok.anggota && dataKelompok.anggota.length > 0) {
      for (var i = 0; i < dataKelompok.anggota.length; i++) {
        html += '<li>' + dataKelompok.anggota[i] + '</li>';
      }
    } else {
      html += '<li>-</li>';
    }
    html += '</ul>';
    
    html += '<p style="color:#2a2420;font-size:15px;margin:4px 0"><strong>Pasangan yang Dibentuk:</strong></p>';
    html += '<div style="background:#f9f5f0;padding:12px;border-radius:6px;margin:8px 0">';
    
    var hasPasangan = false;
    for (var putra in dataPasangan) {
      if (dataPasangan.hasOwnProperty(putra)) {
        html += '<p style="margin:4px 0;font-size:14px;color:#2a2420">üë® ' + putra + ' ‚Üî üë© ' + dataPasangan[putra] + '</p>';
        hasPasangan = true;
      }
    }
    
    if (!hasPasangan) {
      html += '<p style="margin:4px 0;font-size:14px;color:#999;font-style:italic">Belum ada pasangan yang dibentuk</p>';
    }
    
    html += '</div>';
    
    container.innerHTML = html;
    console.log('Ringkasan akhir generated successfully');
  } catch (error) {
    console.error('Error in generateRingkasanAkhir():', error);
  }
}

// ============================================
// KONFIGURASI EMAIL & GOOGLE DRIVE API
// ============================================

// KONFIGURASI EMAIL GURU (WAJIB DIISI!)
// Ganti dengan email guru yang akan menerima hasil pembelajaran
var EMAIL_GURU = 'guru@example.com'; // <-- GANTI INI!

// KONFIGURASI EMAILJS (Opsional - untuk email otomatis)
// Daftar gratis di https://www.emailjs.com
var EMAILJS_PUBLIC_KEY = 'YOUR_EMAILJS_PUBLIC_KEY'; // <-- Isi jika pakai EmailJS
var EMAILJS_SERVICE_ID = 'YOUR_SERVICE_ID';
var EMAILJS_TEMPLATE_ID = 'YOUR_TEMPLATE_ID';

// KONFIGURASI GOOGLE DRIVE
// Setup: https://console.cloud.google.com/
// 1. Buat project baru
// 2. Enable Google Drive API
// 3. Buat OAuth 2.0 Client ID (Web application)
// 4. Tambahkan Authorized JavaScript origins: file:// dan http://localhost
// 5. Copy Client ID dan API Key ke bawah

// METODE LAMA (Kompleks - butuh OAuth setup):
var GOOGLE_CLIENT_ID = 'YOUR_CLIENT_ID_HERE.apps.googleusercontent.com';
var GOOGLE_API_KEY = 'YOUR_API_KEY_HERE';
var GOOGLE_DISCOVERY_DOCS = ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest'];
var GOOGLE_SCOPES = 'https://www.googleapis.com/auth/drive.file';

// ID Folder Google Drive tujuan (dapatkan dari URL folder)
// Contoh URL: https://drive.google.com/drive/folders/1ABC-xyz123
// Maka GDRIVE_FOLDER_ID = '1ABC-xyz123'
var GDRIVE_FOLDER_ID = '';

// ============================================
// METODE BARU (MUDAH - via Google Form Upload)
// ============================================
// Link Google Form untuk upload hasil PDF
// Cara buat:
// 1. Buat Google Form baru di https://forms.google.com/
// 2. Tambah pertanyaan:
//    - Nama Kelompok (Short answer)
//    - Nama Anggota (Long answer)
//    - Upload File PDF (File upload)
// 3. Setting ‚Üí Responses ‚Üí pilih folder tujuan
// 4. Copy link form, paste di bawah:

var GOOGLE_FORM_UPLOAD_URL = 'https://forms.gle/VCpiupYuSjkYAy767';  // ‚úÖ SUDAH DIISI!

var gapiInited = false;
var gisInited = false;
var tokenClient;
var accessToken = null;
var currentPdfBlob = null;

// ============================================
// SISTEM PEREKAMAN AKTIVITAS SISWA
// ============================================

var sessionData = {
  sessionId: generateSessionId(),
  startTime: null,
  endTime: null,
  studentInfo: {},
  activities: [],
  currentSlide: 0,
  slideHistory: [],
  answers: {},
  duration: 0
};

// Generate unique session ID
function generateSessionId() {
  return 'SESSION_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
}

// Initialize session recording
function initializeSession() {
  sessionData.startTime = new Date();
  saveSessionToStorage();
  document.getElementById('recordingIndicator').style.display = 'flex';
  recordActivity('SESSION_START', 'Memulai pembelajaran');
}

// Record activity
function recordActivity(type, description, data) {
  var activity = {
    timestamp: new Date().toISOString(),
    type: type,
    description: description,
    data: data || {},
    slideNumber: currentSlide + 1
  };
  
  sessionData.activities.push(activity);
  saveSessionToStorage();
  
  console.log('üìù Activity Recorded:', activity);
}

// Save session to localStorage
function saveSessionToStorage() {
  localStorage.setItem('currentSession', JSON.stringify(sessionData));
}

// Load session from localStorage
function loadSessionFromStorage() {
  var saved = localStorage.getItem('currentSession');
  if (saved) {
    var loaded = JSON.parse(saved);
    // Merge with current session
    sessionData = Object.assign(sessionData, loaded);
  }
}

// Calculate session duration
function calculateDuration() {
  if (sessionData.startTime) {
    var start = new Date(sessionData.startTime);
    var end = new Date();
    var diff = end - start;
    
    var hours = Math.floor(diff / 3600000);
    var minutes = Math.floor((diff % 3600000) / 60000);
    var seconds = Math.floor((diff % 60000) / 1000);
    
    return {
      total: diff,
      hours: hours,
      minutes: minutes,
      seconds: seconds,
      formatted: hours + ' jam ' + minutes + ' menit ' + seconds + ' detik'
    };
  }
  return null;
}

// ============================================
// FUNGSI KIRIM KE GURU
// ============================================

// Kirim langsung ke guru (METODE UTAMA - PALING MUDAH)
function kirimKeGuru() {
  try {
    // Validasi data
    var dataKelompok = JSON.parse(localStorage.getItem('dataKelompok') || '{}');
    if (!dataKelompok.namaKelompok) {
      alert('‚ö†Ô∏è Silakan isi data kelompok terlebih dahulu!');
      show('identitas-kelompok');
      return;
    }
    
    // Validasi email guru
    if (!EMAIL_GURU || EMAIL_GURU === 'guru@example.com') {
      alert('‚ö†Ô∏è Email guru belum disetup!\n\nKlik "Setup Email Guru" terlebih dahulu.');
      showEmailSetup();
      return;
    }
    
    // End session
    sessionData.endTime = new Date();
    var duration = calculateDuration();
    sessionData.duration = duration ? duration.formatted : '0 menit';
    
    recordActivity('KIRIM_GURU', 'Mengirim hasil ke guru');
    
    // Tampilkan pilihan metode kirim
    showMetodePengiriman();
    
  } catch (error) {
    console.error('Error in kirimKeGuru():', error);
    alert('‚ö†Ô∏è Terjadi kesalahan. Silakan coba lagi.');
  }
}

// Show metode pengiriman
function showMetodePengiriman() {
  // Cek apakah Google Form sudah dikonfigurasi
  var gformConfigured = (GOOGLE_FORM_UPLOAD_URL !== 'https://forms.gle/YOUR_FORM_ID_HERE');
  
  if (gformConfigured) {
    // Google Form sudah setup - ini metode termudah!
    var metode = confirm('PILIH METODE PENGIRIMAN:\n\n' +
                         'OK = Download PDF + Upload via Google Form (MUDAH!)\n' +
                         'Cancel = Download PDF saja (kirim manual)');
    
    if (metode) {
      // Download PDF dan buka Google Form
      downloadPDFAndOpenForm();
    } else {
      // Download PDF saja
      downloadHasil();
    }
  } else {
    // Google Form belum setup, cek Google Drive API
    var gdriveConfigured = (GOOGLE_CLIENT_ID !== 'YOUR_CLIENT_ID_HERE.apps.googleusercontent.com' && 
                            GOOGLE_API_KEY !== 'YOUR_API_KEY_HERE');
    
    if (gdriveConfigured) {
      var metode = confirm('PILIH METODE PENGIRIMAN:\n\n' +
                           'OK = Upload ke Google Drive (otomatis via API)\n' +
                           'Cancel = Download PDF (manual)');
      
      if (metode) {
        uploadToGoogleDrive();
      } else {
        downloadHasil();
      }
    } else {
      // Tidak ada yang dikonfigurasi - download PDF
      alert('üìÑ PDF akan di-download.\n\n' +
            'Setelah download, kirim ke guru via:\n' +
            '‚Ä¢ Email (attach PDF)\n' +
            '‚Ä¢ WhatsApp\n' +
            '‚Ä¢ Google Classroom\n\n' +
            'üí° TIP: Setup Google Form untuk upload otomatis!\n' +
            '   (Lihat SETUP_GOOGLE_FORM.md)');
      downloadHasil();
    }
  }
}

// Download PDF dan tampilkan modal Google Form
async function downloadPDFAndOpenForm() {
  try {
    // Generate dan download PDF (tunggu sampai selesai)
    await downloadHasil();
    
    // Tunggu sebentar untuk memastikan download selesai, lalu tampilkan modal
    setTimeout(function() {
      showGFormModal();
      recordActivity('GOOGLE_FORM_MODAL_SHOWN', 'Menampilkan modal Google Form');
    }, 1000);
  } catch (error) {
    console.error('Error in downloadPDFAndOpenForm():', error);
    alert('‚ö†Ô∏è Terjadi error saat generate PDF. Coba lagi!');
  }
}

// Tampilkan modal Google Form
function showGFormModal() {
  var modal = document.getElementById('gformModal');
  var link = document.getElementById('gformLink');
  
  // Set link ke Google Form
  link.href = GOOGLE_FORM_UPLOAD_URL;
  
  // Tampilkan modal
  modal.style.display = 'block';
  
  console.log('Google Form modal shown with link:', GOOGLE_FORM_UPLOAD_URL);
}

// Tutup modal Google Form
function closeGFormModal() {
  var modal = document.getElementById('gformModal');
  modal.style.display = 'none';
  recordActivity('GOOGLE_FORM_MODAL_CLOSED', 'Menutup modal Google Form');
}

// Kirim via EmailJS (Otomatis)
function kirimViaEmailJS() {
  // Check if EmailJS configured
  if (EMAILJS_PUBLIC_KEY === 'YOUR_EMAILJS_PUBLIC_KEY' || EMAIL_GURU === 'guru@example.com') {
    alert('‚ö†Ô∏è EmailJS belum dikonfigurasi!\n\nSilakan:\n1. Setup EmailJS (lihat panduan)\n2. Atau gunakan metode FormSubmit');
    showEmailSetup();
    return;
  }
  
  // Check if EmailJS loaded
  if (typeof emailjs === 'undefined') {
    alert('‚ö†Ô∏è Library EmailJS belum dimuat. Refresh halaman dan coba lagi.');
    return;
  }
  
  // Initialize EmailJS
  emailjs.init(EMAILJS_PUBLIC_KEY);
  
  // Prepare data
  var dataKelompok = JSON.parse(localStorage.getItem('dataKelompok') || '{}');
  var kesimpulan = JSON.parse(localStorage.getItem('kesimpulanKelompok') || '{}');
  
  var emailData = {
    to_email: EMAIL_GURU,
    nama_kelompok: dataKelompok.namaKelompok || '-',
    anggota: dataKelompok.anggota ? dataKelompok.anggota.join(', ') : '-',
    durasi: sessionData.duration || '0 menit',
    tanggal: new Date().toLocaleDateString('id-ID'),
    waktu: new Date().toLocaleTimeString('id-ID'),
    jawaban1: kesimpulan.jawaban1 || '-',
    jawaban2: kesimpulan.jawaban2 || '-',
    jawaban3: kesimpulan.jawaban3 || '-',
    pasangan: JSON.stringify(dataPasangan, null, 2)
  };
  
  // Show loading
  var statusDiv = document.getElementById('kirimStatus');
  if (statusDiv) {
    statusDiv.className = 'status-message info';
    statusDiv.textContent = '‚è≥ Mengirim email ke guru...';
    statusDiv.style.display = 'block';
  }
  
  // Send email
  emailjs.send(EMAILJS_SERVICE_ID, EMAILJS_TEMPLATE_ID, emailData)
    .then(function(response) {
      console.log('Email sent!', response);
      recordActivity('EMAIL_SUCCESS', 'Email berhasil dikirim ke guru');
      
      if (statusDiv) {
        statusDiv.className = 'status-message success';
        statusDiv.textContent = '‚úÖ Hasil pembelajaran berhasil dikirim ke guru!\n' + EMAIL_GURU;
      }
      
      alert('‚úÖ Hasil pembelajaran berhasil dikirim ke guru!\n\nEmail: ' + EMAIL_GURU);
    }, function(error) {
      console.error('Email error:', error);
      recordActivity('EMAIL_ERROR', 'Gagal kirim email: ' + JSON.stringify(error));
      
      if (statusDiv) {
        statusDiv.className = 'status-message error';
        statusDiv.textContent = '‚ùå Gagal kirim email. Gunakan metode FormSubmit.';
      }
      
      alert('‚ùå Gagal kirim email.\n\nSilakan gunakan metode FormSubmit atau hubungi guru.');
    });
}

// Kirim via FormSubmit (Tanpa setup, buka form HTML)
function kirimViaFormSubmit() {
  if (EMAIL_GURU === 'guru@example.com') {
    alert('‚ö†Ô∏è Email guru belum diisi!\n\nSilakan setup email guru terlebih dahulu.');
    showEmailSetup();
    return;
  }
  
  // Prepare data
  var dataKelompok = JSON.parse(localStorage.getItem('dataKelompok') || '{}');
  var kesimpulan = JSON.parse(localStorage.getItem('kesimpulanKelompok') || '{}');
  var duration = calculateDuration();
  
  // Create form data sebagai HTML yang rapi
  var htmlContent = '<h2>Hasil Pembelajaran - Korespondensi Satu-Satu</h2>';
  htmlContent += '<hr>';
  htmlContent += '<h3>Data Kelompok</h3>';
  htmlContent += '<p><strong>Nama Kelompok:</strong> ' + (dataKelompok.namaKelompok || '-') + '</p>';
  htmlContent += '<p><strong>Anggota:</strong></p><ul>';
  if (dataKelompok.anggota && dataKelompok.anggota.length > 0) {
    for (var i = 0; i < dataKelompok.anggota.length; i++) {
      htmlContent += '<li>' + dataKelompok.anggota[i] + '</li>';
    }
  }
  htmlContent += '</ul>';
  
  htmlContent += '<h3>Informasi Sesi</h3>';
  htmlContent += '<p><strong>Tanggal:</strong> ' + new Date().toLocaleDateString('id-ID') + '</p>';
  htmlContent += '<p><strong>Durasi:</strong> ' + (duration ? duration.formatted : '0 menit') + '</p>';
  
  htmlContent += '<h3>Pasangan yang Dibentuk</h3>';
  htmlContent += '<ul>';
  for (var putra in dataPasangan) {
    if (dataPasangan.hasOwnProperty(putra)) {
      htmlContent += '<li>' + putra + ' ‚Üî ' + dataPasangan[putra] + '</li>';
    }
  }
  htmlContent += '</ul>';
  
  htmlContent += '<h3>Kesimpulan & Refleksi</h3>';
  htmlContent += '<p><strong>1. Berapa banyak pasangan yang dapat dibentuk?</strong></p>';
  htmlContent += '<p>' + (kesimpulan.jawaban1 || '-') + '</p>';
  htmlContent += '<p><strong>2. Apa yang dipahami tentang korespondensi satu-satu?</strong></p>';
  htmlContent += '<p>' + (kesimpulan.jawaban2 || '-') + '</p>';
  htmlContent += '<p><strong>3. Contoh lain dalam kehidupan sehari-hari:</strong></p>';
  htmlContent += '<p>' + (kesimpulan.jawaban3 || '-') + '</p>';
  
  // Buat form dan submit
  var form = document.createElement('form');
  form.action = 'https://formsubmit.co/' + EMAIL_GURU;
  form.method = 'POST';
  form.target = '_blank';
  
  // Add fields
  var fields = [
    { name: '_subject', value: 'Hasil Pembelajaran - ' + (dataKelompok.namaKelompok || 'Kelompok') },
    { name: '_template', value: 'table' },
    { name: '_captcha', value: 'false' },
    { name: 'Nama_Kelompok', value: dataKelompok.namaKelompok || '-' },
    { name: 'Anggota', value: dataKelompok.anggota ? dataKelompok.anggota.join(', ') : '-' },
    { name: 'Tanggal', value: new Date().toLocaleDateString('id-ID') },
    { name: 'Durasi', value: duration ? duration.formatted : '0 menit' },
    { name: 'Detail_Lengkap', value: htmlContent }
  ];
  
  fields.forEach(function(field) {
    var input = document.createElement('input');
    input.type = 'hidden';
    input.name = field.name;
    input.value = field.value;
    form.appendChild(input);
  });
  
  document.body.appendChild(form);
  form.submit();
  document.body.removeChild(form);
  
  recordActivity('FORMSUBMIT', 'Membuka FormSubmit untuk kirim ke guru');
  
  alert('üìß Tab baru akan terbuka untuk verifikasi email.\n\n' +
        'Silakan:\n' +
        '1. Isi captcha jika diminta\n' +
        '2. Klik "Submit"\n' +
        '3. Email akan terkirim ke guru: ' + EMAIL_GURU);
}

// ============================================
// GOOGLE DRIVE UPLOAD
// ============================================

var gapiInited = false;
var gisInited = false;
var tokenClient;
var accessToken = null;

// Initialize Google API
function gapiLoaded() {
  gapi.load('client', initializeGapiClient);
}

async function initializeGapiClient() {
  try {
    await gapi.client.init({
      apiKey: GOOGLE_API_KEY,
      discoveryDocs: GOOGLE_DISCOVERY_DOCS,
    });
    gapiInited = true;
    console.log('Google API initialized');
  } catch (error) {
    console.error('Error initializing GAPI:', error);
  }
}

function gisLoaded() {
  tokenClient = google.accounts.oauth2.initTokenClient({
    client_id: GOOGLE_CLIENT_ID,
    scope: GOOGLE_SCOPES,
    callback: '', // defined later
  });
  gisInited = true;
  console.log('GIS initialized');
}

// Upload ke Google Drive
function uploadToGoogleDrive() {
  // Check if configured
  if (GOOGLE_CLIENT_ID === 'YOUR_CLIENT_ID_HERE.apps.googleusercontent.com' || 
      GOOGLE_API_KEY === 'YOUR_API_KEY_HERE') {
    alert('‚ö†Ô∏è Google Drive belum dikonfigurasi!\n\n' +
          'Untuk setup:\n' +
          '1. Buka file HTML ini\n' +
          '2. Cari bagian KONFIGURASI GOOGLE DRIVE\n' +
          '3. Isi GOOGLE_CLIENT_ID dan GOOGLE_API_KEY\n' +
          '4. Isi GDRIVE_FOLDER_ID (ID folder tujuan)\n\n' +
          'Panduan lengkap ada di file PANDUAN_GOOGLE_DRIVE_SETUP.md\n\n' +
          'Untuk sekarang, gunakan metode Email saja.');
    kirimViaFormSubmit();
    return;
  }
  
  // Check if API loaded
  if (!gapiInited || !gisInited) {
    alert('‚ö†Ô∏è Google Drive API belum siap.\n\nSilakan:\n1. Refresh halaman\n2. Tunggu beberapa detik\n3. Coba lagi');
    return;
  }
  
  // Request authorization
  tokenClient.callback = async (resp) => {
    if (resp.error !== undefined) {
      console.error('Auth error:', resp);
      alert('‚ö†Ô∏è Gagal login ke Google.\n\nGunakan metode Email saja.');
      kirimViaFormSubmit();
      return;
    }
    
    accessToken = gapi.auth.getToken().access_token;
    
    // Generate PDF blob
    generatePDFForGDrive(async (pdfBlob) => {
      if (!pdfBlob) {
        alert('‚ö†Ô∏è Gagal generate PDF.');
        return;
      }
      
      // Upload to Google Drive
      await uploadFileToGDrive(pdfBlob);
    });
  };
  
  // Check if already has token
  if (gapi.client.getToken() === null) {
    // Prompt for authorization
    tokenClient.requestAccessToken({prompt: 'consent'});
  } else {
    // Skip display of account chooser
    tokenClient.requestAccessToken({prompt: ''});
  }
}

// Generate PDF untuk Google Drive
function generatePDFForGDrive(callback) {
  try {
    var { jsPDF } = window.jspdf;
    var doc = new jsPDF();
    
    // Get data
    var dataKelompok = JSON.parse(localStorage.getItem('dataKelompok') || '{}');
    var kesimpulan = JSON.parse(localStorage.getItem('kesimpulanKelompok') || '{}');
    var duration = calculateDuration();
    
    var yPos = 20;
    
    // Title
    doc.setFontSize(18);
    doc.setFont(undefined, 'bold');
    doc.text('Hasil Pembelajaran', 105, yPos, { align: 'center' });
    yPos += 10;
    
    doc.setFontSize(14);
    doc.text('Korespondensi Satu-Satu', 105, yPos, { align: 'center' });
    yPos += 15;
    
    // Data Kelompok
    doc.setFontSize(12);
    doc.setFont(undefined, 'bold');
    doc.text('Data Kelompok:', 20, yPos);
    yPos += 7;
    
    doc.setFont(undefined, 'normal');
    doc.text('Nama Kelompok: ' + (dataKelompok.namaKelompok || '-'), 20, yPos);
    yPos += 7;
    
    doc.text('Anggota:', 20, yPos);
    yPos += 7;
    
    if (dataKelompok.anggota && dataKelompok.anggota.length > 0) {
      dataKelompok.anggota.forEach((nama, i) => {
        doc.text((i + 1) + '. ' + nama, 25, yPos);
        yPos += 6;
      });
    }
    yPos += 5;
    
    // Session Info
    doc.text('Tanggal: ' + new Date().toLocaleDateString('id-ID'), 20, yPos);
    yPos += 6;
    doc.text('Durasi: ' + (duration ? duration.formatted : '0 menit'), 20, yPos);
    yPos += 10;
    
    // Pasangan
    doc.setFont(undefined, 'bold');
    doc.text('Pasangan yang Dibentuk:', 20, yPos);
    yPos += 7;
    
    doc.setFont(undefined, 'normal');
    var hasPasangan = false;
    for (var putra in dataPasangan) {
      if (dataPasangan.hasOwnProperty(putra)) {
        doc.text(putra + ' \u2194 ' + dataPasangan[putra], 25, yPos);
        yPos += 6;
        hasPasangan = true;
      }
    }
    
    if (!hasPasangan) {
      doc.text('Belum ada pasangan', 25, yPos);
      yPos += 6;
    }
    yPos += 5;
    
    // Kesimpulan
    if (yPos > 250) {
      doc.addPage();
      yPos = 20;
    }
    
    doc.setFont(undefined, 'bold');
    doc.text('Kesimpulan & Refleksi:', 20, yPos);
    yPos += 7;
    
    doc.setFont(undefined, 'normal');
    doc.text('1. Berapa banyak pasangan?', 20, yPos);
    yPos += 6;
    
    var lines1 = doc.splitTextToSize(kesimpulan.jawaban1 || '-', 170);
    lines1.forEach(line => {
      if (yPos > 280) {
        doc.addPage();
        yPos = 20;
      }
      doc.text(line, 25, yPos);
      yPos += 6;
    });
    yPos += 3;
    
    doc.text('2. Apa yang dipahami?', 20, yPos);
    yPos += 6;
    
    var lines2 = doc.splitTextToSize(kesimpulan.jawaban2 || '-', 170);
    lines2.forEach(line => {
      if (yPos > 280) {
        doc.addPage();
        yPos = 20;
      }
      doc.text(line, 25, yPos);
      yPos += 6;
    });
    yPos += 3;
    
    doc.text('3. Contoh lain:', 20, yPos);
    yPos += 6;
    
    var lines3 = doc.splitTextToSize(kesimpulan.jawaban3 || '-', 170);
    lines3.forEach(line => {
      if (yPos > 280) {
        doc.addPage();
        yPos = 20;
      }
      doc.text(line, 25, yPos);
      yPos += 6;
    });
    
    // Convert to blob
    var pdfBlob = doc.output('blob');
    callback(pdfBlob);
    
  } catch (error) {
    console.error('Error generating PDF:', error);
    callback(null);
  }
}

// Upload file ke Google Drive
async function uploadFileToGDrive(fileBlob) {
  try {
    var dataKelompok = JSON.parse(localStorage.getItem('dataKelompok') || '{}');
    var fileName = 'Hasil_Pembelajaran_' + (dataKelompok.namaKelompok || 'Kelompok') + '_' + 
                   new Date().toISOString().slice(0,10) + '.pdf';
    
    var metadata = {
      name: fileName,
      mimeType: 'application/pdf'
    };
    
    // If folder ID specified, upload to that folder
    if (GDRIVE_FOLDER_ID) {
      metadata.parents = [GDRIVE_FOLDER_ID];
    }
    
    var form = new FormData();
    form.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
    form.append('file', fileBlob);
    
    var response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
      method: 'POST',
      headers: new Headers({ 'Authorization': 'Bearer ' + accessToken }),
      body: form
    });
    
    var result = await response.json();
    
    if (result.id) {
      recordActivity('GDRIVE_SUCCESS', 'File uploaded to Google Drive: ' + result.id);
      
      // Buat link shareable
      var fileUrl = 'https://drive.google.com/file/d/' + result.id + '/view';
      
      // Kirim email notifikasi otomatis dengan link PDF
      kirimEmailNotifikasiPDF(fileName, fileUrl, dataKelompok);
      
      alert('‚úÖ BERHASIL!\n\n' +
            'üìÅ PDF tersimpan di Google Drive: ' + fileName + '\n\n' +
            'üìß Email notifikasi dengan link PDF sudah dikirim ke guru!\n\n' +
            'File ID: ' + result.id);
    } else {
      throw new Error('Upload failed: ' + JSON.stringify(result));
    }
    
  } catch (error) {
    console.error('Error uploading to Google Drive:', error);
    recordActivity('GDRIVE_ERROR', 'Upload failed: ' + error.message);
    
    alert('‚ö†Ô∏è Gagal upload ke Google Drive.\n\n' +
          'Error: ' + error.message + '\n\n' +
          'Gunakan metode Email saja.');
    kirimViaFormSubmit();
  }
}

// Kirim email notifikasi dengan link PDF Google Drive
function kirimEmailNotifikasiPDF(fileName, fileUrl, dataKelompok) {
  try {
    var kesimpulan = JSON.parse(localStorage.getItem('kesimpulanKelompok') || '{}');
    var duration = calculateDuration();
    
    // Buat HTML content untuk email
    var htmlContent = '<h2>üìÑ Hasil Pembelajaran - PDF Tersedia</h2>';
    htmlContent += '<hr>';
    htmlContent += '<p><strong>Nama Kelompok:</strong> ' + (dataKelompok.namaKelompok || '-') + '</p>';
    htmlContent += '<p><strong>Anggota:</strong></p><ul>';
    if (dataKelompok.anggota && dataKelompok.anggota.length > 0) {
      dataKelompok.anggota.forEach(function(nama) {
        htmlContent += '<li>' + nama + '</li>';
      });
    }
    htmlContent += '</ul>';
    
    htmlContent += '<p><strong>Tanggal:</strong> ' + new Date().toLocaleDateString('id-ID') + '</p>';
    htmlContent += '<p><strong>Durasi:</strong> ' + (duration ? duration.formatted : '0 menit') + '</p>';
    
    htmlContent += '<hr>';
    htmlContent += '<h3>üì• Download Hasil PDF:</h3>';
    htmlContent += '<p style="font-size:18px;"><a href="' + fileUrl + '" target="_blank" style="background:#4CAF50;color:white;padding:15px 30px;text-decoration:none;border-radius:5px;display:inline-block;">üìÑ Download PDF - ' + fileName + '</a></p>';
    
    htmlContent += '<hr>';
    htmlContent += '<p><strong>Ringkasan Singkat:</strong></p>';
    htmlContent += '<p><em>Pasangan yang dibentuk: ' + Object.keys(dataPasangan).length + ' pasangan</em></p>';
    
    // Buat form dan submit
    var form = document.createElement('form');
    form.action = 'https://formsubmit.co/' + EMAIL_GURU;
    form.method = 'POST';
    form.target = '_blank';
    
    // Add fields
    var fields = [
      { name: '_subject', value: 'üìÑ Hasil Pembelajaran PDF - ' + (dataKelompok.namaKelompok || 'Kelompok') },
      { name: '_template', value: 'table' },
      { name: '_captcha', value: 'false' },
      { name: 'Nama_Kelompok', value: dataKelompok.namaKelompok || '-' },
      { name: 'Anggota', value: dataKelompok.anggota ? dataKelompok.anggota.join(', ') : '-' },
      { name: 'Tanggal', value: new Date().toLocaleDateString('id-ID') },
      { name: 'Nama_File_PDF', value: fileName },
      { name: 'Link_Download_PDF', value: fileUrl },
      { name: 'Pesan', value: htmlContent }
    ];
    
    fields.forEach(function(field) {
      var input = document.createElement('input');
      input.type = 'hidden';
      input.name = field.name;
      input.value = field.value;
      form.appendChild(input);
    });
    
    document.body.appendChild(form);
    form.submit();
    document.body.removeChild(form);
    
    recordActivity('EMAIL_NOTIFICATION', 'Email notifikasi PDF sent');
    
  } catch (error) {
    console.error('Error sending email notification:', error);
  }
}

// Download hasil dengan PDF
async function downloadHasil() {
  try {
    // Validasi data kelompok
    var dataKelompok = JSON.parse(localStorage.getItem('dataKelompok') || '{}');
    if (!dataKelompok.namaKelompok) {
      alert('‚ö†Ô∏è Silakan isi data kelompok terlebih dahulu!');
      show('identitas-kelompok');
      return;
    }
    
    // End session
    sessionData.endTime = new Date();
    var duration = calculateDuration();
    sessionData.duration = duration ? duration.formatted : '0 menit';
    
    recordActivity('GENERATE_PDF', 'Menggenerate laporan PDF');
    
    // Check if jsPDF is loaded
    if (typeof window.jspdf === 'undefined') {
      alert('‚ö†Ô∏è Library PDF belum dimuat.\n\nSilakan:\n1. Refresh halaman\n2. Atau gunakan "Kirim ke Guru" untuk kirim langsung via email');
      return;
    }
    
    // Show loading
    alert('‚è≥ Generating PDF dengan screenshot...\n\nMohon tunggu sebentar...');
    
    var filename = await generatePDFReport();
    
    if (filename) {
      alert('‚úÖ PDF BERHASIL DIDOWNLOAD!\n\n' +
            'üìÑ File: ' + filename + '\n\n' +
            'üìß CARA KIRIM KE GURU:\n\n' +
            '1. VIA EMAIL MANUAL:\n' +
            '   - Buka email Anda\n' +
            '   - Attach file PDF yang baru didownload\n' +
            '   - Kirim ke: ' + (EMAIL_GURU || 'email guru') + '\n\n' +
            '2. VIA GOOGLE CLASSROOM:\n' +
            '   - Upload PDF sebagai assignment\n\n' +
            '3. VIA WHATSAPP:\n' +
            '   - Attach PDF dan kirim ke guru\n\n' +
            'üí° TIP: Setup Google Form untuk upload otomatis!\n' +
            '   (Lihat file SETUP_GOOGLE_FORM.md)');
    }
    
  } catch (error) {
    console.error('Error in downloadHasil():', error);
    alert('‚ö†Ô∏è Terjadi kesalahan saat membuat PDF.\n\nError: ' + error.message);
  }
}

// Screenshot-based PDF generation
async function generatePDFReport(){
  const { jsPDF } = window.jspdf;
  if(!jsPDF) throw new Error('jsPDF library belum dimuat');
  
  const namaKelompok = document.getElementById('namaKelompok')?.value || 'Kelompok';
  console.log('üé¨ Mulai screenshot semua slide...');
  
  try {
    const pdf = new jsPDF('p', 'mm', 'a4');
    const imgWidth = 210;
    const pageHeight = 297;
    let pageCount = 0;
    
    const slides = document.querySelectorAll('.slide');
    console.log('üìÑ Total slides ditemukan:', slides.length);
    
    for (let i = 0; i < slides.length; i++) {
      const slide = slides[i];
      slide.style.display = 'block';
      slide.classList.add('active');
      
      await new Promise(r => setTimeout(r, 150));
      
      try {
        const canvas = await html2canvas(slide, {
          scale: 4,
          useCORS: true,
          allowTaint: true,
          backgroundColor: '#ffffff',
          logging: false,
          windowHeight: slide.scrollHeight,
          imageTimeout: 8000,
          removeContainer: true,
          proxy: null
        });
        
        const ctx = canvas.getContext('2d');
        const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
        const data = imageData.data;
        
        for (let i = 0; i < data.length; i += 4) {
          const r = data[i];
          const g = data[i+1];
          const b = data[i+2];
          const lum = (r * 0.299 + g * 0.587 + b * 0.114) / 255;
          
          if (lum < 0.7) {
            data[i] = Math.max(0, r - 40);
            data[i+1] = Math.max(0, g - 40);
            data[i+2] = Math.max(0, b - 40);
          } else {
            data[i] = Math.min(255, r + 15);
            data[i+1] = Math.min(255, g + 15);
            data[i+2] = Math.min(255, b + 15);
          }
        }
        
        for (let i = 0; i < data.length; i += 4) {
          const r = data[i];
          const g = data[i+1];
          const b = data[i+2];
          const max = Math.max(r, g, b);
          const min = Math.min(r, g, b);
          const l = (max + min) / 2;
          
          if (max !== min) {
            let s = l > 128 ? (max - min) / (510 - max - min) : (max - min) / (max + min);
            s = Math.min(1, s * 1.4);
            
            const h = max === r ? (((g - b) / (max - min)) % 6) / 6 :
                      max === g ? ((b - r) / (max - min) + 2) / 6 :
                      ((r - g) / (max - min) + 4) / 6;
            
            const c = (1 - Math.abs(2 * l / 255 - 1)) * s * 255;
            const x = c * (1 - Math.abs((h * 6) % 2 - 1));
            const m = l / 2 - c / 2;
            
            let nr = 0, ng = 0, nb = 0;
            if (h < 1/6) { nr = c; ng = x; }
            else if (h < 2/6) { nr = x; ng = c; }
            else if (h < 3/6) { ng = c; nb = x; }
            else if (h < 4/6) { ng = x; nb = c; }
            else if (h < 5/6) { nr = x; nb = c; }
            else { nr = c; nb = x; }
            
            data[i] = Math.round((nr + m) * 1.1);
            data[i+1] = Math.round((ng + m) * 1.1);
            data[i+2] = Math.round((nb + m) * 1.1);
          }
        }
        
        ctx.putImageData(imageData, 0, 0);
        
        const slideHeight = (canvas.height * imgWidth) / canvas.width;
        const scaleToFit = pageHeight / slideHeight;
        
        let finalWidth = imgWidth;
        let finalHeight = slideHeight;
        
        if (slideHeight > pageHeight - 5) {
          finalWidth = imgWidth * scaleToFit;
          finalHeight = slideHeight * scaleToFit;
        }
        
        const imgData = canvas.toDataURL('image/jpeg', 1.0);
        
        if (pageCount > 0) {
          pdf.addPage();
        }
        
        const xPos = (imgWidth - finalWidth) / 2;
        const yPos = (pageHeight - finalHeight) / 2;
        
        pdf.addImage(imgData, 'JPEG', xPos, yPos, finalWidth, finalHeight);
        pageCount++;
        
        console.log(`‚úÖ Slide ${i + 1}/${slides.length} ‚Üí Halaman ${pageCount}`);
      } catch(slideErr) {
        console.warn(`‚ö†Ô∏è Slide ${i + 1} error:`, slideErr.message);
      }
      
      slide.style.display = 'none';
      slide.classList.remove('active');
    }
    
    const filename = `Hasil_Pertemuan_${namaKelompok.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`;
    pdf.save(filename);
    console.log('‚úÖ PDF berhasil dibuat:', filename, `(${pageCount} halaman)`);
    return filename;
  } catch(err) {
    console.error('‚ùå Error saat screenshot:', err);
    throw err;
  }
}

// Generate PDF Report (old version - fallback)
function generatePDFReport_OLD() {
  var { jsPDF } = window.jspdf;
  var doc = new jsPDF();
  
  var pageWidth = doc.internal.pageSize.getWidth();
  var pageHeight = doc.internal.pageSize.getHeight();
  var margin = 20;
  var yPos = margin;
  var lineHeight = 7;
  
  // Helper function to add new page if needed
  function checkNewPage(heightNeeded) {
    if (yPos + heightNeeded > pageHeight - margin) {
      doc.addPage();
      yPos = margin;
      return true;
    }
    return false;
  }
  
  // Helper function to wrap text
  function addWrappedText(text, x, y, maxWidth, lineHeight) {
    var lines = doc.splitTextToSize(text, maxWidth);
    for (var i = 0; i < lines.length; i++) {
      checkNewPage(lineHeight);
      doc.text(lines[i], x, yPos);
      yPos += lineHeight;
    }
  }
  
  // HEADER
  doc.setFontSize(18);
  doc.setFont(undefined, 'bold');
  doc.text('LAPORAN AKTIVITAS PEMBELAJARAN', pageWidth / 2, yPos, { align: 'center' });
  yPos += 10;
  
  doc.setFontSize(14);
  doc.text('Pertemuan 5: Relasi dan Fungsi', pageWidth / 2, yPos, { align: 'center' });
  yPos += 12;
  
  // Session Info
  doc.setFontSize(10);
  doc.setFont(undefined, 'normal');
  doc.text('Session ID: ' + sessionData.sessionId, margin, yPos);
  yPos += lineHeight;
  
  if (sessionData.startTime) {
    doc.text('Waktu Mulai: ' + new Date(sessionData.startTime).toLocaleString('id-ID'), margin, yPos);
    yPos += lineHeight;
  }
  
  if (sessionData.endTime) {
    doc.text('Waktu Selesai: ' + new Date(sessionData.endTime).toLocaleString('id-ID'), margin, yPos);
    yPos += lineHeight;
  }
  
  doc.text('Durasi Pembelajaran: ' + sessionData.duration, margin, yPos);
  yPos += lineHeight + 5;
  
  // Student Info
  var dataKelompok = JSON.parse(localStorage.getItem('dataKelompok') || '{}');
  
  doc.setFontSize(12);
  doc.setFont(undefined, 'bold');
  checkNewPage(15);
  doc.text('INFORMASI SISWA', margin, yPos);
  yPos += lineHeight;
  
  doc.setFontSize(10);
  doc.setFont(undefined, 'normal');
  doc.text('Nama Kelompok: ' + (dataKelompok.namaKelompok || '-'), margin, yPos);
  yPos += lineHeight;
  
  if (dataKelompok.anggota && dataKelompok.anggota.length > 0) {
    doc.text('Anggota Kelompok:', margin, yPos);
    yPos += lineHeight;
    for (var i = 0; i < dataKelompok.anggota.length; i++) {
      checkNewPage(lineHeight);
      doc.text('  ' + (i + 1) + '. ' + dataKelompok.anggota[i], margin + 5, yPos);
      yPos += lineHeight;
    }
  }
  yPos += 5;
  
  // Pasangan yang dibentuk
  if (Object.keys(dataPasangan).length > 0) {
    doc.setFontSize(12);
    doc.setFont(undefined, 'bold');
    checkNewPage(15);
    doc.text('PASANGAN YANG DIBENTUK', margin, yPos);
    yPos += lineHeight;
    
    doc.setFontSize(10);
    doc.setFont(undefined, 'normal');
    for (var putra in dataPasangan) {
      if (dataPasangan.hasOwnProperty(putra)) {
        checkNewPage(lineHeight);
        doc.text(putra + ' <-> ' + dataPasangan[putra], margin, yPos);
        yPos += lineHeight;
      }
    }
    yPos += 5;
  }
  
  // Kesimpulan
  var kesimpulan = JSON.parse(localStorage.getItem('kesimpulanKelompok') || '{}');
  if (kesimpulan.jawaban1 || kesimpulan.jawaban2 || kesimpulan.jawaban3) {
    doc.setFontSize(12);
    doc.setFont(undefined, 'bold');
    checkNewPage(15);
    doc.text('KESIMPULAN & REFLEKSI', margin, yPos);
    yPos += lineHeight + 3;
    
    doc.setFontSize(10);
    
    if (kesimpulan.jawaban1) {
      doc.setFont(undefined, 'bold');
      checkNewPage(lineHeight);
      doc.text('1. Apa yang kamu pelajari hari ini?', margin, yPos);
      yPos += lineHeight;
      doc.setFont(undefined, 'normal');
      addWrappedText(kesimpulan.jawaban1, margin + 5, yPos, pageWidth - 2 * margin - 5, lineHeight);
      yPos += 3;
    }
    
    if (kesimpulan.jawaban2) {
      doc.setFont(undefined, 'bold');
      checkNewPage(lineHeight);
      doc.text('2. Bagaimana kamu bisa menerapkan konsep ini?', margin, yPos);
      yPos += lineHeight;
      doc.setFont(undefined, 'normal');
      addWrappedText(kesimpulan.jawaban2, margin + 5, yPos, pageWidth - 2 * margin - 5, lineHeight);
      yPos += 3;
    }
    
    if (kesimpulan.jawaban3) {
      doc.setFont(undefined, 'bold');
      checkNewPage(lineHeight);
      doc.text('3. Apa yang masih membingungkan?', margin, yPos);
      yPos += lineHeight;
      doc.setFont(undefined, 'normal');
      addWrappedText(kesimpulan.jawaban3, margin + 5, yPos, pageWidth - 2 * margin - 5, lineHeight);
      yPos += 3;
    }
    yPos += 5;
  }
  
  // Activity Log
  if (sessionData.activities.length > 0) {
    doc.setFontSize(12);
    doc.setFont(undefined, 'bold');
    checkNewPage(15);
    doc.text('LOG AKTIVITAS', margin, yPos);
    yPos += lineHeight + 3;
    
    doc.setFontSize(9);
    doc.setFont(undefined, 'normal');
    
    var maxActivities = Math.min(sessionData.activities.length, 30); // Limit to last 30 activities
    var startIndex = Math.max(0, sessionData.activities.length - maxActivities);
    
    for (var i = startIndex; i < sessionData.activities.length; i++) {
      var act = sessionData.activities[i];
      var time = new Date(act.timestamp).toLocaleTimeString('id-ID');
      var logText = '[' + time + '] Slide ' + act.slideNumber + ': ' + act.description;
      
      checkNewPage(lineHeight);
      addWrappedText(logText, margin, yPos, pageWidth - 2 * margin, lineHeight - 1);
    }
  }
  
  // Footer
  var totalPages = doc.internal.getNumberOfPages();
  for (var i = 1; i <= totalPages; i++) {
    doc.setPage(i);
    doc.setFontSize(8);
    doc.setFont(undefined, 'italic');
    doc.text('Halaman ' + i + ' dari ' + totalPages, pageWidth / 2, pageHeight - 10, { align: 'center' });
    doc.text('Generated: ' + new Date().toLocaleString('id-ID'), pageWidth / 2, pageHeight - 5, { align: 'center' });
  }
  
  // Generate filename
  var namaKelompok = dataKelompok.namaKelompok || 'Kelompok';
  var timestamp = new Date().toISOString().split('T')[0];
  var filename = 'Pembelajaran_' + namaKelompok.replace(/\s+/g, '_') + '_' + timestamp + '.pdf';
  
  // Save PDF blob for upload
  currentPdfBlob = doc.output('blob');
  
  // Save PDF to computer
  doc.save(filename);
  
  recordActivity('PDF_DOWNLOADED', 'PDF berhasil didownload: ' + filename);
  
  alert('‚úÖ PDF BERHASIL DIDOWNLOAD!\n\n' +
        'üìÑ File: ' + filename + '\n\n' +
        'üìß CARA KIRIM KE GURU:\n\n' +
        '1. VIA EMAIL MANUAL:\n' +
        '   - Buka email Anda\n' +
        '   - Attach file PDF yang baru didownload\n' +
        '   - Kirim ke: ' + (EMAIL_GURU || 'email guru') + '\n\n' +
        '2. VIA GOOGLE CLASSROOM:\n' +
        '   - Upload PDF sebagai assignment\n\n' +
        '3. VIA WHATSAPP:\n' +
        '   - Attach PDF dan kirim ke guru\n\n' +
        'üí° TIP: Setup Google Drive untuk upload otomatis!\n' +
        '   (Lihat file SETUP_GOOGLE_DRIVE.md)');
}

// Override existing functions to add recording
var originalNextSlide = nextSlide;
function nextSlide() {
  recordActivity('NAVIGATION', 'Pindah ke slide berikutnya', { from: currentSlide, to: currentSlide + 1 });
  originalNextSlide();
}

var originalPrevSlide = prevSlide;
function prevSlide() {
  recordActivity('NAVIGATION', 'Kembali ke slide sebelumnya', { from: currentSlide, to: currentSlide - 1 });
  originalPrevSlide();
}

// ============================================
// GOOGLE DRIVE INTEGRATION
// ============================================

// Initialize Google API
function gapiLoaded() {
  gapi.load('client', initializeGapiClient);
}

function initializeGapiClient() {
  // Check if API key is set
  if (GOOGLE_API_KEY === 'YOUR_API_KEY_HERE') {
    console.log('Google API Key not configured');
    return;
  }
  
  gapi.client.init({
    apiKey: GOOGLE_API_KEY,
    discoveryDocs: GOOGLE_DISCOVERY_DOCS,
  }).then(function() {
    gapiInited = true;
    console.log('GAPI client initialized');
  }, function(error) {
    console.error('Error initializing GAPI client:', error);
  });
}

function gisLoaded() {
  // Check if Client ID is set
  if (GOOGLE_CLIENT_ID === 'YOUR_CLIENT_ID_HERE.apps.googleusercontent.com') {
    console.log('Google Client ID not configured');
    return;
  }
  
  tokenClient = google.accounts.oauth2.initTokenClient({
    client_id: GOOGLE_CLIENT_ID,
    scope: GOOGLE_SCOPES,
    callback: '', // defined later
  });
  gisInited = true;
  console.log('GIS client initialized');
}

// Show Google Drive setup modal
function showGDriveSetup() {
  var modal = document.getElementById('gdriveSetupModal');
  if (modal) {
    modal.classList.add('active');
  }
}

// Show Email setup modal
function showEmailSetup() {
  var modal = document.getElementById('emailSetupModal');
  if (modal) {
    modal.classList.add('active');
    // Load saved email
    var emailInput = document.getElementById('email-guru-input');
    if (emailInput && EMAIL_GURU) {
      emailInput.value = EMAIL_GURU;
    }
  }
}

// Save Email configuration
function saveEmailConfig() {
  var emailGuru = document.getElementById('email-guru-input').value.trim();
  
  if (!emailGuru) {
    alert('‚ö†Ô∏è Email guru harus diisi!');
    return;
  }
  
  // Validate email format
  var emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if (!emailRegex.test(emailGuru)) {
    alert('‚ö†Ô∏è Format email tidak valid!');
    return;
  }
  
  EMAIL_GURU = emailGuru;
  
  // Save to localStorage
  localStorage.setItem('emailGuruConfig', JSON.stringify({
    emailGuru: emailGuru,
    timestamp: new Date().toISOString()
  }));
  
  // Update display
  updateEmailDisplay();
  
  closeModal('emailSetupModal');
  alert('‚úÖ Email guru berhasil disimpan!\\n\\nEmail: ' + emailGuru + '\\n\\nSiswa sekarang bisa kirim hasil pembelajaran ke email ini.');
}

// Load email configuration
function loadEmailConfig() {
  var saved = localStorage.getItem('emailGuruConfig');
  if (saved) {
    var config = JSON.parse(saved);
    EMAIL_GURU = config.emailGuru || EMAIL_GURU;
  }
  updateEmailDisplay();
}

// Update email display
function updateEmailDisplay() {
  var display = document.getElementById('emailGuruDisplay');
  if (display) {
    if (EMAIL_GURU && EMAIL_GURU !== 'guru@example.com') {
      display.textContent = EMAIL_GURU;
      display.style.color = '#4caf50';
    } else {
      display.textContent = 'Belum diatur (klik Setup Email Guru)';
      display.style.color = '#d32f2f';
    }
  }
}

function closeModal(modalId) {
  var modal = document.getElementById(modalId);
  if (modal) {
    modal.classList.remove('active');
  }
}

// Save Google Drive configuration
function saveGDriveConfig() {
  var clientId = document.getElementById('gdrive-client-id').value.trim();
  var apiKey = document.getElementById('gdrive-api-key').value.trim();
  var emailGuru = document.getElementById('email-guru').value.trim();
  var folderId = document.getElementById('gdrive-folder-id').value.trim();
  
  if (!clientId || !apiKey) {
    alert('‚ö†Ô∏è Client ID dan API Key harus diisi!');
    return;
  }
  
  GOOGLE_CLIENT_ID = clientId;
  GOOGLE_API_KEY = apiKey;
  EMAIL_GURU = emailGuru || EMAIL_GURU;
  GDRIVE_FOLDER_ID = folderId || GDRIVE_FOLDER_ID;
  
  // Save to localStorage
  localStorage.setItem('gdriveConfig', JSON.stringify({
    clientId: clientId,
    apiKey: apiKey,
    emailGuru: emailGuru,
    folderId: folderId
  }));
  
  // Reinitialize
  if (typeof gapi !== 'undefined') {
    gapiLoaded();
  }
  if (typeof google !== 'undefined' && google.accounts) {
    gisLoaded();
  }
  
  closeModal('gdriveSetupModal');
  alert('‚úÖ Konfigurasi Google Drive berhasil disimpan!\n\nSilakan coba upload file ke Google Drive.');
}

// Load saved configuration
function loadGDriveConfig() {
  var saved = localStorage.getItem('gdriveConfig');
  if (saved) {
    var config = JSON.parse(saved);
    GOOGLE_CLIENT_ID = config.clientId || GOOGLE_CLIENT_ID;
    GOOGLE_API_KEY = config.apiKey || GOOGLE_API_KEY;
    EMAIL_GURU = config.emailGuru || EMAIL_GURU;
    GDRIVE_FOLDER_ID = config.folderId || GDRIVE_FOLDER_ID;
    
    // Populate form if exists
    setTimeout(function() {
      var clientIdInput = document.getElementById('gdrive-client-id');
      var apiKeyInput = document.getElementById('gdrive-api-key');
      var emailInput = document.getElementById('email-guru');
      var folderInput = document.getElementById('gdrive-folder-id');
      
      if (clientIdInput) clientIdInput.value = config.clientId || '';
      if (apiKeyInput) apiKeyInput.value = config.apiKey || '';
      if (emailInput) emailInput.value = config.emailGuru || '';
      if (folderInput) folderInput.value = config.folderId || '';
    }, 500);
  }
}

// Upload PDF to Google Drive
function uploadToGoogleDrive() {
  if (!currentPdfBlob) {
    alert('‚ö†Ô∏è Tidak ada file PDF. Silakan generate PDF terlebih dahulu.');
    return;
  }
  
  // Check if API is configured
  if (GOOGLE_CLIENT_ID === 'YOUR_CLIENT_ID_HERE.apps.googleusercontent.com' || 
      GOOGLE_API_KEY === 'YOUR_API_KEY_HERE') {
    // Show setup modal
    showGDriveSetup();
    return;
  }
  
  if (!gapiInited || !gisInited) {
    alert('‚ö†Ô∏è Google API belum siap. Silakan refresh halaman dan coba lagi.');
    return;
  }
  
  // Request access token
  tokenClient.callback = async (resp) => {
    if (resp.error !== undefined) {
      throw (resp);
    }
    accessToken = resp.access_token;
    await performUpload();
  };
  
  if (accessToken === null) {
    // Prompt the user to select a Google Account and ask for consent
    tokenClient.requestAccessToken({ prompt: 'consent' });
  } else {
    // Skip display of account chooser and consent dialog
    tokenClient.requestAccessToken({ prompt: '' });
  }
}

async function performUpload() {
  var statusDiv = document.getElementById('uploadStatus');
  if (statusDiv) {
    statusDiv.className = 'status-message info';
    statusDiv.textContent = '‚è≥ Mengupload ke Google Drive...';
    statusDiv.style.display = 'block';
  }
  
  try {
    // Generate filename
    var dataKelompok = JSON.parse(localStorage.getItem('dataKelompok') || '{}');
    var namaKelompok = dataKelompok.namaKelompok || 'Kelompok';
    var timestamp = new Date().toISOString().split('T')[0];
    var filename = 'Pembelajaran_' + namaKelompok.replace(/\s+/g, '_') + '_' + timestamp + '.pdf';
    
    // Create metadata
    var metadata = {
      name: filename,
      mimeType: 'application/pdf'
    };
    
    // Add to specific folder if configured
    if (GDRIVE_FOLDER_ID) {
      metadata.parents = [GDRIVE_FOLDER_ID];
    }
    
    // Convert blob to base64
    var reader = new FileReader();
    reader.readAsDataURL(currentPdfBlob);
    reader.onloadend = function() {
      var base64data = reader.result.split(',')[1];
      
      // Upload using multipart upload
      var boundary = '-------314159265358979323846';
      var delimiter = "\r\n--" + boundary + "\r\n";
      var close_delim = "\r\n--" + boundary + "--";
      
      var multipartRequestBody =
        delimiter +
        'Content-Type: application/json\r\n\r\n' +
        JSON.stringify(metadata) +
        delimiter +
        'Content-Type: application/pdf\r\n' +
        'Content-Transfer-Encoding: base64\r\n' +
        '\r\n' +
        base64data +
        close_delim;
      
      var request = gapi.client.request({
        'path': '/upload/drive/v3/files',
        'method': 'POST',
        'params': {'uploadType': 'multipart'},
        'headers': {
          'Content-Type': 'multipart/related; boundary="' + boundary + '"'
        },
        'body': multipartRequestBody
      });
      
      request.execute(function(file) {
        if (file && file.id) {
          recordActivity('GDRIVE_UPLOAD', 'File berhasil diupload ke Google Drive', { fileId: file.id, filename: filename });
          
          if (statusDiv) {
            statusDiv.className = 'status-message success';
            statusDiv.innerHTML = '‚úÖ File berhasil diupload ke Google Drive!<br>' +
                                 '<small>File ID: ' + file.id + '</small><br>' +
                                 '<a href="https://drive.google.com/file/d/' + file.id + '/view" target="_blank" style="color: #2e7d32; font-weight: bold;">üìÇ Buka di Google Drive</a>';
          }
          
          // Share with teacher if email is configured
          if (EMAIL_GURU && EMAIL_GURU !== 'guru@example.com') {
            shareWithTeacher(file.id, filename);
          }
        } else {
          throw new Error('Upload gagal');
        }
      });
    };
    
  } catch (error) {
    console.error('Upload error:', error);
    recordActivity('GDRIVE_ERROR', 'Gagal upload ke Google Drive: ' + error.message);
    
    if (statusDiv) {
      statusDiv.className = 'status-message error';
      statusDiv.textContent = '‚ùå Gagal upload: ' + error.message;
    }
  }
}

// Share file with teacher
function shareWithTeacher(fileId, filename) {
  var permission = {
    type: 'user',
    role: 'reader',
    emailAddress: EMAIL_GURU
  };
  
  var request = gapi.client.request({
    path: '/drive/v3/files/' + fileId + '/permissions',
    method: 'POST',
    headers: {
      'Content-Type': 'application/json'
    },
    body: JSON.stringify(permission)
  });
  
  request.execute(function(resp) {
    if (resp && resp.id) {
      console.log('File shared with teacher:', EMAIL_GURU);
      recordActivity('GDRIVE_SHARE', 'File dibagikan ke guru: ' + EMAIL_GURU);
      alert('‚úÖ File berhasil diupload dan dibagikan ke guru!\n\nGuru: ' + EMAIL_GURU);
    }
  });
}

// Share via Email (alternative method)
function shareViaEmail() {
  if (!currentPdfBlob) {
    alert('‚ö†Ô∏è Tidak ada file PDF. Silakan generate PDF terlebih dahulu.');
    return;
  }
  
  var dataKelompok = JSON.parse(localStorage.getItem('dataKelompok') || '{}');
  var namaKelompok = dataKelompok.namaKelompok || 'Kelompok';
  var anggota = dataKelompok.anggota ? dataKelompok.anggota.join(', ') : '';
  
  var subject = 'Hasil Pembelajaran - ' + namaKelompok;
  var body = 'Yth. Bapak/Ibu Guru,%0D%0A%0D%0A' +
             'Terlampir hasil pembelajaran kami:%0D%0A' +
             'Kelompok: ' + namaKelompok + '%0D%0A' +
             'Anggota: ' + anggota + '%0D%0A' +
             'Tanggal: ' + new Date().toLocaleDateString('id-ID') + '%0D%0A%0D%0A' +
             'Catatan: File PDF sudah didownload, mohon dilampirkan saat mengirim email ini.%0D%0A%0D%0A' +
             'Terima kasih.';
  
  var emailGuru = EMAIL_GURU && EMAIL_GURU !== 'guru@example.com' ? EMAIL_GURU : '';
  var mailtoLink = 'mailto:' + emailGuru + '?subject=' + subject + '&body=' + body;
  
  window.location.href = mailtoLink;
  
  recordActivity('EMAIL_SHARE', 'Membuka email client untuk kirim hasil');
  
  alert('üìß Email client akan terbuka.\n\nJangan lupa lampirkan file PDF yang sudah didownload!');
}

// Initialize session when page loads
window.addEventListener('load', function() {
  loadSessionFromStorage();
  loadGDriveConfig();
  loadEmailConfig();
  
  if (!sessionData.startTime) {
    initializeSession();
  } else {
    document.getElementById('recordingIndicator').style.display = 'flex';
  }
  
  // Initialize Google API
  if (typeof gapi !== 'undefined') {
    gapiLoaded();
  }
  if (typeof google !== 'undefined' && google.accounts) {
    gisLoaded();
  }
  
  // Initialize EmailJS if configured
  if (typeof emailjs !== 'undefined' && EMAILJS_PUBLIC_KEY !== 'YOUR_EMAILJS_PUBLIC_KEY') {
    emailjs.init(EMAILJS_PUBLIC_KEY);
  }
});

// Save session before page unload
window.addEventListener('beforeunload', function() {
  saveSessionToStorage();
});



</script>

</body>
</html>
