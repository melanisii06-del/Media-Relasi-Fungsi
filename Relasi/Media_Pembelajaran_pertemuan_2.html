<!DOCTYPE html>
<!-- saved from url=(0060)file:///C:/Users/Melani%20Sintawati/Downloads/hahahahah.html -->
<html lang="id">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Media Pembelajaran ‚Äî Relasi & Fungsi (Final)</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<style>
/* --- CSS GLOBAL --- */
:root{--bg:#ffcb64;--panel:#fff3d9;--accent:#3e2723;--muted:#6b4b3a;--success:#2e7d32;--danger:#c62828}
html,body{
  height:100%;
  margin:0;
  font-family:'Poppins',sans-serif;
  background:var(--bg);
  color:var(--accent);
}

/* Background warna kuning lembut */
body {
  background: linear-gradient(135deg, #ffcb64 0%, #ffc850 50%, #ffb84d 100%);
}

body::before {
  content: '';
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: radial-gradient(circle at 20% 50%, rgba(255, 215, 0, 0.08), transparent 50%);
  z-index: -1;
  pointer-events: none;
}

.wrapper{
  min-height:100vh;
  display:flex;
  align-items:flex-start;
  justify-content:center;
  padding:28px;
  box-sizing:border-box;
  position: relative;
}
.card{width:1100px;max-width:98%;background:linear-gradient(180deg,var(--panel),#fff7e6);border-radius:18px;box-shadow:0 18px 40px rgba(0,0,0,.12);overflow:visible;position:relative;}
.card::after{
  content:'';
  position:absolute;
  top:12px;
  right:12px;
  width:160px;
  height:200px;
  background:url('https://cdn.pixabay.com/photo/2017/01/31/21/22/cartoon-children-2024079_1280.png') center/contain no-repeat;
  border-radius:14px;
  box-shadow:0 10px 24px rgba(0,0,0,0.14);
  animation: float 4s ease-in-out infinite;
  pointer-events:none;
  opacity:1;
  z-index:2;
}
.header{text-align:center;padding-top:10px}
h1{font-size:44px;margin:6px 0;color:var(--accent)}
.lead{color:rgba(0,0,0,0.6);margin-bottom:18px}
.slides{min-height:60vh;padding:28px 18px;}
.slide{display:none;padding:10px 18px 20px 18px;min-height:400px}
.slide.active{display:block}
.center{display:flex;flex-direction:column;align-items:center;gap:12px;padding-top:100px}
.btn{background:var(--accent);color:white;border:none;padding:10px 20px;border-radius:12px;cursor:pointer;font-size:16px}
.menu-grid{display:flex;gap:18px;justify-content:center;margin-top:16px;flex-wrap:wrap}
.menu-card{width:260px;height:120px;border-radius:14px;background:linear-gradient(180deg,#fff,#fff5e6);display:flex;align-items:center;justify-content:center;box-shadow:0 8px 18px rgba(0,0,0,0.06);cursor:pointer;border:3px solid rgba(0,0,0,0.04);font-size:18px;color:var(--muted);transition:all 0.2s;}
.menu-card:hover{background:#ffebc6;transform:translateY(-2px);box-shadow:0 10px 20px rgba(0,0,0,0.1)}
.input-large{width:88%;max-width:820px;padding:14px;border-radius:12px;border:2px dashed rgba(0,0,0,0.12);background:#fff9e6;font-size:16px;min-height:160px;resize:vertical;font-family:sans-serif;}
.input-large-half{width:45%;padding:14px;border-radius:12px;border:2px dashed rgba(0,0,0,0.12);background:#fff9e6;font-size:14px;min-height:120px;resize:vertical;font-family:sans-serif;}
/* Tahap 1: drag-drop himpunan */
.items{display:flex;flex-wrap:wrap;gap:10px;margin:12px 0}
.item{padding:10px 12px;border-radius:10px;background:#fff;border:2px solid rgba(0,0,0,0.06);box-shadow:0 4px 10px rgba(0,0,0,0.06);cursor:grab;user-select:none;font-size:15px}
.row3{display:flex;gap:16px;flex-wrap:wrap;margin-top:12px}
.col{flex:1;min-width:240px}
.dropzone{min-height:120px;border:2px dashed rgba(0,0,0,0.12);border-radius:12px;padding:10px;background:#fff;display:flex;flex-wrap:wrap;gap:8px;align-items:flex-start}
.dropzone.highlight{border-color:var(--accent);box-shadow:0 0 8px rgba(0,0,0,0.08)}
.dropzone.wrong{border-color:var(--danger);animation:shake .4s}
.feedback{margin-top:10px;font-weight:700;color:var(--muted)}
.sets-row{display:flex;gap:26px;justify-content:center;margin-top:26px;flex-wrap:wrap}
.set-box{display:flex;flex-direction:column;align-items:center;gap:8px}
.oval{width:260px;height:260px;border-radius:140px;border:3px solid var(--accent);background:white;display:flex;flex-direction:column;align-items:center;justify-content:space-around;font-size:18px;padding:14px;min-height:160px;box-sizing:border-box;}
.set-title{font-size:18px;color:var(--muted);margin-bottom:8px}
.dot-line{width:85%;height:28px;border-bottom:2px dashed #ffd199;margin:8px 0;display:flex;align-items:center;justify-content:center;color:#555;font-size:16px;cursor:text;font-family:sans-serif;}
.diagram-area{position:relative;height:380px;margin-top:18px;border-radius:12px;background:linear-gradient(180deg,rgba(255,255,255,0.6),rgba(255,255,255,0.3));display:flex;align-items:center;justify-content:center;gap:60px;padding:18px;overflow:hidden}
.toolbar{display:flex;gap:10px;justify-content:center;flex-wrap:wrap;margin:12px 0}
.tool{background:var(--accent);color:white;border:none;padding:8px 14px;border-radius:12px;cursor:pointer;font-family:inherit;font-size:14px;}
.tool.active{background:#ffeb3b;color:var(--accent);font-weight:bold;}
.canvas-box{background:#fff;padding:12px;border-radius:12px;box-shadow:0 8px 18px rgba(0,0,0,0.06);margin:10px auto;max-width:960px}
.label{font-size:16px;color:var(--muted);margin-bottom:8px;text-align:left;margin-left:8px}
.nav{display:flex;justify-content:center;gap:12px;margin-top:18px}
.btn.ghost{background:transparent;color:var(--accent);border:2px solid var(--accent)}
.nav .btn.ghost{background:transparent;color:var(--accent);border:2px solid var(--accent)}
@media (max-width:920px){ .card{padding:12px} h1{font-size:32px} .oval{width:200px;height:220px} .dot-line{width:78%} .canvas-box canvas{width:100%} .input-large-half{width:100%} }

/* Modal Papan Pesanan */
.modal-overlay{position:fixed;inset:0;background:rgba(0,0,0,.45);display:flex;align-items:center;justify-content:center;z-index:9999}
.modal-box{width:880px;max-width:94%;background:#fffdf6;border-radius:16px;box-shadow:0 18px 40px rgba(0,0,0,.25);overflow:hidden;border:3px solid #ffe3a1}
.modal-header{padding:16px 20px;background:#fff3d9;border-bottom:2px dashed #ffd199}
.modal-header h3{margin:0;color:var(--accent)}
.modal-content{padding:16px 20px;color:var(--muted)}
.modal-content .cols{display:flex;gap:18px;flex-wrap:wrap}
.modal-content .col{flex:1;min-width:260px;background:#fff;border:2px dashed #ffe0a8;border-radius:12px;padding:12px}
.modal-actions{display:flex;gap:10px;justify-content:flex-end;padding:14px 20px;background:#fffaf0;border-top:2px dashed #ffd199}
.badge{display:inline-block;background:#ffeb3b;color:#3e2723;border-radius:999px;padding:2px 10px;font-weight:700;margin-left:8px}
.list{margin:6px 0 0 16px}
.list li{margin:6px 0}

/* Papan Pesanan sticky di K3 */
.papan-sticky{position:sticky;top:0;z-index:50;background:#fffdf6;border:2px dashed #ffd199;border-radius:14px;margin:10px 0;padding:12px 14px;box-shadow:0 8px 20px rgba(0,0,0,0.05)}
.papan-sticky .title{display:flex;align-items:center;gap:8px;color:var(--accent);font-size:18px;font-weight:700;margin-bottom:6px}
.papan-sticky .grid{display:flex;gap:12px;flex-wrap:wrap}
.papan-sticky .panel{flex:1;min-width:240px;background:#fff;border-radius:10px;border:2px dashed #ffe0a8;padding:10px}
.papan-sticky ul{margin:6px 0 0 18px}

/* Evaluasi & Refleksi */
.card-lite{background:#fffdf6;border:2px dashed #ffd199;border-radius:14px;padding:14px;margin:10px 0}
.pill-row{display:flex;gap:10px;flex-wrap:wrap;margin-top:8px}
.pill{padding:8px 12px;border-radius:999px;border:2px solid rgba(0,0,0,0.08);cursor:pointer;background:#fff;color:var(--accent);font-weight:700}
.pill.active{background:#ffeb3b;border-color:#f7d53b}
.checklist{display:flex;flex-direction:column;gap:8px;margin-top:8px}
.emoji-row{display:flex;gap:10px;flex-wrap:wrap;margin:10px 0}
.emoji-btn{font-size:26px;padding:8px 12px;border-radius:12px;border:2px solid rgba(0,0,0,0.08);background:#fff;cursor:pointer}
.emoji-btn.active{border-color:#f7b500;box-shadow:0 4px 10px rgba(0,0,0,0.08)}

/* Styling untuk pilihan penyajian */
.penyajian-option {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 12px;
  background: #fff;
  border: 2px solid #ddd;
  border-radius: 10px;
  cursor: pointer;
  transition: all 0.3s ease;
}

.penyajian-option:hover {
  background: #fffbf0;
  border-color: var(--accent);
  transform: translateY(-2px);
}

.penyajian-option input[type="radio"] {
  width: 18px;
  height: 18px;
  cursor: pointer;
}

.penyajian-option input[type="radio"]:checked + span {
  font-weight: 700;
  color: var(--accent);
}

.penyajian-option span {
  font-size: 16px;
  color: var(--muted);
  transition: all 0.2s ease;
}

/* Styling untuk komentar */
.komentar-item {
  background: #f9f9f9;
  border-left: 4px solid var(--accent);
  padding: 12px;
  margin-bottom: 12px;
  border-radius: 8px;
  animation: slideInLeft 0.5s ease-out;
}

.komentar-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}

.komentar-kelompok {
  font-weight: 700;
  color: var(--accent);
  font-size: 14px;
}

.komentar-waktu {
  font-size: 12px;
  color: #999;
}

.komentar-isi {
  color: #333;
  line-height: 1.5;
  font-family: Arial, sans-serif;
  font-size: 14px;
}

@keyframes slideInLeft {
  from {
    opacity: 0;
    transform: translateX(-20px);
  }
  to {
    opacity: 1;
    transform: translateX(0);
  }
}

/* === ANIMASI === */
/* Animasi Fade In untuk slide */
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}
.slide.active { animation: fadeIn 0.5s ease-out; }

/* Animasi Shake untuk error */
@keyframes shake {
  0%, 100% { transform: translateX(0); }
  25% { transform: translateX(-10px); }
  75% { transform: translateX(10px); }
}

/* Animasi Bounce untuk tombol */
@keyframes bounce {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-8px); }
}

/* Animasi Pulse untuk highlight */
@keyframes pulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.05); }
}

/* Animasi Float untuk elemen dekoratif */
@keyframes float {
  0%, 100% { transform: translateY(0px); }
  50% { transform: translateY(-10px); }
}

/* Animasi Glow */
@keyframes glow {
  0%, 100% { box-shadow: 0 0 5px rgba(255, 235, 59, 0.5); }
  50% { box-shadow: 0 0 20px rgba(255, 235, 59, 0.8); }
}

/* Animasi untuk kartu menu */
.menu-card {
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  animation: fadeIn 0.6s ease-out;
}
.menu-card:nth-child(1) { animation-delay: 0.1s; }
.menu-card:nth-child(2) { animation-delay: 0.2s; }
.menu-card:nth-child(3) { animation-delay: 0.3s; }
.menu-card:hover { animation: pulse 0.6s ease-in-out; }

/* Animasi tombol */
.btn {
  transition: all 0.3s ease;
  position: relative;
  overflow: hidden;
}
.btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 12px rgba(0,0,0,0.15);
}
.btn:active {
  transform: translateY(0);
  box-shadow: 0 2px 4px rgba(0,0,0,0.1);
}
.btn::before {
  content: '';
  position: absolute;
  top: 50%;
  left: 50%;
  width: 0;
  height: 0;
  border-radius: 50%;
  background: rgba(255,255,255,0.3);
  transform: translate(-50%, -50%);
  transition: width 0.6s, height 0.6s;
}
.btn:hover::before {
  width: 300px;
  height: 300px;
}

/* Tombol kirim ke guru (floating) */
.floating-send{
  position:fixed !important;
  bottom:18px !important;
  right:18px !important;
  z-index:99999 !important;
  pointer-events:auto !important;
  display:block !important;
  visibility:visible !important;
}

.floating-send .btn{
  background:linear-gradient(135deg,#4caf50 0%,#2e7d32 100%) !important;
  box-shadow:0 10px 20px rgba(46,125,50,0.35) !important;
  font-size:16px !important;
  padding:12px 18px !important;
  pointer-events:auto !important;
  cursor:pointer !important;
  display:block !important;
  visibility:visible !important;
  opacity:1 !important;
}

/* Modal overlay untuk Google Form */
#gformModal{
  display:none;
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.7);
  z-index:10000;
}

#gformModalContent{
  background:#fff;
  width:90%;
  max-width:600px;
  margin:5% auto;
  padding:32px;
  border-radius:18px;
  text-align:center;
  box-shadow:0 14px 32px rgba(0,0,0,0.25);
  animation:fadeIn 0.35s ease;
}

#gformModalClose{
  position:absolute;
  top:14px;
  right:18px;
  font-size:30px;
  font-weight:700;
  color:#777;
  cursor:pointer;
}

.gform-title{font-size:22px;font-weight:700;color:#2e7d32;margin-bottom:12px}
.gform-message{color:#444;line-height:1.6;margin-bottom:18px}
.gform-link-btn{display:inline-block;background:linear-gradient(135deg,#4caf50 0%,#2e7d32 100%);color:#fff;padding:14px 26px;border-radius:12px;font-weight:700;text-decoration:none;box-shadow:0 8px 16px rgba(46,125,50,0.35)}
.gform-close-btn{display:inline-block;margin-top:12px;padding:10px 18px;border-radius:10px;background:#eee;color:#333;cursor:pointer}

/* Animasi item drag */
.item {
  transition: all 0.3s ease;
  animation: fadeIn 0.4s ease-out backwards;
}
.item:nth-child(1) { animation-delay: 0.05s; }
.item:nth-child(2) { animation-delay: 0.1s; }
.item:nth-child(3) { animation-delay: 0.15s; }
.item:nth-child(4) { animation-delay: 0.2s; }
.item:nth-child(5) { animation-delay: 0.25s; }
.item:nth-child(6) { animation-delay: 0.3s; }
.item:nth-child(7) { animation-delay: 0.35s; }
.item:nth-child(8) { animation-delay: 0.4s; }
.item:nth-child(9) { animation-delay: 0.45s; }
.item:nth-child(10) { animation-delay: 0.5s; }
.item:nth-child(11) { animation-delay: 0.55s; }
.item:nth-child(12) { animation-delay: 0.6s; }
.item:hover {
  transform: scale(1.05) rotate(2deg);
  box-shadow: 0 6px 16px rgba(0,0,0,0.12);
}
.item:active {
  cursor: grabbing;
  transform: scale(1.08);
}

/* Animasi dropzone */
.dropzone {
  transition: all 0.3s ease;
}
.dropzone.highlight {
  animation: pulse 0.6s ease-in-out infinite;
}

/* Animasi oval/himpunan */
.oval {
  transition: all 0.4s ease;
  animation: fadeIn 0.8s ease-out;
}
.oval:hover {
  transform: scale(1.02);
  box-shadow: 0 8px 20px rgba(0,0,0,0.1);
}

/* Animasi untuk pill */
.pill {
  transition: all 0.3s ease;
}
.pill:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}
.pill.active {
  animation: glow 2s ease-in-out infinite;
}

/* Animasi emoji button */
.emoji-btn {
  transition: all 0.3s ease;
}
.emoji-btn:hover {
  transform: scale(1.15) rotate(10deg);
}
.emoji-btn.active {
  animation: bounce 0.6s ease-in-out;
}

/* Animasi untuk header title */
.header h1 {
  animation: fadeIn 0.8s ease-out, float 3s ease-in-out infinite;
}

/* Animasi untuk progress bar */
.progress {
  animation: fadeIn 1s ease-out;
}

/* Animasi untuk modal */
.modal-overlay {
  animation: fadeIn 0.3s ease-out;
}
.modal-box {
  animation: bounceIn 0.5s cubic-bezier(0.68, -0.55, 0.265, 1.55);
}
@keyframes bounceIn {
  0% { transform: scale(0.3); opacity: 0; }
  50% { transform: scale(1.05); }
  70% { transform: scale(0.9); }
  100% { transform: scale(1); opacity: 1; }
}

/* Animasi untuk canvas box */
.canvas-box {
  transition: all 0.3s ease;
  animation: fadeIn 0.6s ease-out;
}
.canvas-box:hover {
  box-shadow: 0 12px 24px rgba(0,0,0,0.1);
}

/* Animasi untuk feedback message */
.feedback {
  animation: fadeIn 0.4s ease-out;
}

/* Animasi untuk card */
.card {
  animation: fadeIn 0.8s ease-out;
}

/* Animasi untuk toolbar */
.tool {
  transition: all 0.3s ease;
}
.tool:hover {
  transform: translateY(-3px);
  box-shadow: 0 4px 8px rgba(0,0,0,0.2);
}
.tool.active {
  animation: pulse 0.5s ease-in-out;
}

/* Animasi untuk card-lite */
.card-lite {
  animation: fadeIn 0.6s ease-out;
  transition: all 0.3s ease;
}
.card-lite:hover {
  box-shadow: 0 6px 16px rgba(0,0,0,0.08);
  transform: translateY(-2px);
}

/* Loading animation untuk gambar */
img {
  animation: fadeIn 0.8s ease-out;
}

/* === CHOICE CARDS (Pemilihan Kegiatan) === */
.choice-container {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 24px;
  margin: 30px auto;
  max-width: 1100px;
}

.choice-card {
  background: linear-gradient(135deg, #fff 0%, #fffef7 100%);
  border: 3px solid rgba(0,0,0,0.08);
  border-radius: 16px;
  padding: 28px;
  cursor: pointer;
  transition: all 0.35s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 4px 12px rgba(0,0,0,0.06);
  position: relative;
  overflow: hidden;
}

.choice-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 4px;
  background: linear-gradient(90deg, #ffcb64, #ff9800);
  transform: scaleX(0);
  transition: transform 0.35s ease;
}

.choice-card:hover::before {
  transform: scaleX(1);
}

.choice-card:hover {
  transform: translateY(-8px);
  box-shadow: 0 12px 28px rgba(0,0,0,0.15);
  border-color: var(--accent);
}

.choice-card.selected {
  border-color: var(--accent);
  background: linear-gradient(135deg, #fff9e6 0%, #ffebcc 100%);
  box-shadow: 0 8px 20px rgba(255, 152, 0, 0.25);
}

.choice-card.selected::before {
  transform: scaleX(1);
}

.choice-icon {
  font-size: 64px;
  margin-bottom: 16px;
  display: block;
  transition: all 0.3s ease;
}

.choice-card:hover .choice-icon {
  transform: scale(1.15) rotate(5deg);
}

.choice-title {
  font-size: 22px;
  font-weight: 700;
  color: var(--accent);
  margin-bottom: 12px;
}

.choice-desc {
  color: var(--muted);
  font-size: 14px;
  line-height: 1.6;
  margin-bottom: 14px;
}

.choice-badge {
  display: inline-block;
  background: #e3f2fd;
  color: #1565c0;
  padding: 6px 14px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 600;
  margin-top: 10px;
}

.choice-badge.visual { background: #fce4ec; color: #c2185b; }
.choice-badge.analytic { background: #e8f5e9; color: #2e7d32; }
.choice-badge.verbal { background: #fff3e0; color: #e65100; }

.preview-box {
  background: #fff;
  border: 2px dashed rgba(0,0,0,0.1);
  border-radius: 12px;
  padding: 20px;
  margin: 16px 0;
  text-align: center;
}

.preview-label {
  font-size: 14px;
  color: var(--muted);
  font-weight: 600;
  margin-bottom: 12px;
}

.preview-img {
  max-width: 100%;
  height: auto;
  border-radius: 8px;
  box-shadow: 0 4px 12px rgba(0,0,0,0.1);
}

.quick-preview-card {
  background: linear-gradient(135deg, #f5f5f5 0%, #ececec 100%);
  border-radius: 12px;
  padding: 20px;
  margin: 16px 0;
  border-left: 4px solid var(--accent);
}

.quick-preview-title {
  font-size: 18px;
  font-weight: 700;
  color: var(--accent);
  margin-bottom: 10px;
}

.quick-preview-content {
  color: #555;
  font-size: 14px;
  line-height: 1.7;
}

/* === GALLERY DISPLAY (Penyajian Karya) === */
.gallery-display-box {
  background: linear-gradient(135deg, #fff 0%, #f8f9fa 100%);
  border: 3px solid #ffcb64;
  border-radius: 16px;
  padding: 24px;
  margin: 20px 0;
  box-shadow: 0 8px 24px rgba(0,0,0,0.12);
  display: none;
  animation: fadeIn 0.5s ease-out;
}

.gallery-display-box.show {
  display: block;
}

.gallery-header {
  text-align: center;
  margin-bottom: 20px;
  padding-bottom: 16px;
  border-bottom: 2px dashed rgba(0,0,0,0.1);
}

.gallery-title {
  font-size: 24px;
  font-weight: 700;
  color: var(--accent);
  margin-bottom: 8px;
}

.gallery-subtitle {
  font-size: 14px;
  color: var(--muted);
  font-style: italic;
}

.gallery-content {
  min-height: 200px;
  background: #fff;
  border-radius: 12px;
  padding: 20px;
  border: 2px dashed rgba(0,0,0,0.08);
}

.gallery-image-wrapper {
  text-align: center;
  padding: 16px;
}

.gallery-image-wrapper img {
  max-width: 100%;
  height: auto;
  border-radius: 8px;
  box-shadow: 0 4px 16px rgba(0,0,0,0.15);
  border: 2px solid #e0e0e0;
}

.gallery-text-wrapper {
  padding: 20px;
}

.gallery-text-item {
  background: #fffef7;
  padding: 16px;
  border-radius: 10px;
  margin-bottom: 12px;
  border-left: 4px solid var(--accent);
}

.gallery-text-label {
  font-weight: 700;
  color: var(--accent);
  margin-bottom: 8px;
  font-size: 14px;
}

.gallery-text-content {
  color: #555;
  font-size: 15px;
  line-height: 1.7;
  white-space: pre-wrap;
}

.gallery-badge {
  display: inline-block;
  background: linear-gradient(135deg, #4caf50 0%, #2e7d32 100%);
  color: white;
  padding: 8px 16px;
  border-radius: 20px;
  font-size: 13px;
  font-weight: 600;
  margin-top: 12px;
}

/* Modal overlay untuk Google Form */
#gformModal {
  display: none;
  position: fixed;
  z-index: 9999;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0,0,0,0.7);
  animation: fadeInModal 0.3s ease;
}

#gformModalContent {
  position: relative;
  background: linear-gradient(135deg, #fff 0%, #f9f9f9 100%);
  margin: 5% auto;
  padding: 40px;
  border-radius: 20px;
  width: 90%;
  max-width: 600px;
  box-shadow: 0 10px 40px rgba(0,0,0,0.3);
  animation: slideDownModal 0.4s ease;
  text-align: center;
}

#gformModalClose {
  position: absolute;
  top: 15px;
  right: 20px;
  font-size: 32px;
  font-weight: bold;
  color: #999;
  cursor: pointer;
  transition: color 0.2s;
}

#gformModalClose:hover {
  color: #333;
}

.gform-title {
  color: #2a2420;
  font-size: 24px;
  margin-bottom: 20px;
  font-weight: 700;
}

.gform-message {
  color: #555;
  font-size: 16px;
  line-height: 1.6;
  margin-bottom: 30px;
}

.gform-link-btn {
  display: inline-block;
  background: linear-gradient(135deg, #4CAF50 0%, #45a049 100%);
  color: white;
  padding: 18px 40px;
  font-size: 20px;
  font-weight: 700;
  border-radius: 12px;
  text-decoration: none;
  box-shadow: 0 4px 15px rgba(76,175,80,0.4);
  transition: all 0.3s ease;
  margin: 10px;
}

.gform-link-btn:hover {
  background: linear-gradient(135deg, #45a049 0%, #3d8b40 100%);
  box-shadow: 0 6px 20px rgba(76,175,80,0.5);
  transform: translateY(-2px);
}

.gform-close-btn {
  display: inline-block;
  background: #ccc;
  color: #333;
  padding: 12px 30px;
  font-size: 16px;
  border-radius: 8px;
  cursor: pointer;
  margin-top: 20px;
  transition: all 0.2s;
}

.gform-close-btn:hover {
  background: #bbb;
}

@keyframes fadeInModal {
  from { opacity: 0; }
  to { opacity: 1; }
}

@keyframes slideDownModal {
  from {
    opacity: 0;
    transform: translateY(-50px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes floating {
  0%, 100% { transform: translateY(0px); }
  50% { transform: translateY(-12px); }
}

h1, h2 {
  animation: floating 3s ease-in-out infinite;
}
</style>
</head>
<body>

<div class="wrapper"><div class="card">
  <div class="header"><h1>Media Pembelajaran Relasi &amp; Fungsi</h1><div class="lead">Interaktif ‚Äî kerjakan dari Start ‚Üí Permasalahan</div></div>

  <main class="slides">

    <section class="slide active" id="start">
      <div class="center"><h2>Selamat Datang</h2><p class="lead">Media Pembelajaran: Relasi &amp; Fungsi</p><button class="btn" data-go="menu">Mulai</button></div>
    </section>

    <section class="slide" id="menu">
      <div class="center"><h2>Menu Utama</h2>
        <div class="menu-grid">
          <div class="menu-card" data-go="permasalahan-foto">Permasalahan</div>
        </div>
        <div style="margin-top:18px"><button class="btn" data-go="start">Kembali</button></div>
      </div>
    </section>

    <section class="slide" id="permasalahan-foto">
      <div class="panel">
        <div class="header">
           <h1>Orientasi Permasalahan </h1>
          <h1>Permasalahan ‚Äî Perhatikan Foto</h1>
          <div class="lead">Amati gambar berikut lalu tekan "Selesaikan" untuk lanjut ke Data Kelompok.</div>
        </div>

        <div class="content" style="text-align:center">
          <img src="../relasii.png" alt="Ilustrasi kantin sekolah" style="max-width:100%;height:auto;border-radius:10px;display:block;margin:0 auto 12px;">

          <div style="background:#fff3d9;border-left:4px solid #ffb84d;border-radius:10px;padding:16px;margin:14px auto;max-width:760px;text-align:left">
            <div style="font-weight:700;color:var(--accent);margin-bottom:10px;font-size:18px">ÔøΩÔ∏è Permasalahan: Ibu Kantin Kebingungan!</div>
            <p style="color:var(--muted);font-size:14px;line-height:1.6;margin:8px 0">
              Hari ini adalah hari Jumat, dan biasanya pesanan makanan dan minuman di kantin sekolah sangat ramai. Ibu kantin menerima begitu banyak pesanan dari siswa yang datang secara bersamaan di jam istirahat. Pesanan-pesanan itu tercampur-campur dan sangat sulit untuk diolah.
            </p>

            <p style="color:var(--muted);font-size:14px;line-height:1.6;margin:8px 0;font-weight:700;background:#fff9e6;padding:8px;border-radius:6px">
              Ibu kantin meminta bantuan kalian untuk menyusun ulang pesanan-pesanan itu dalam bentuk yang lebih teratur dan mudah dimengerti. Dengan cara yang rapi, ibu kantin bisa melayani siswa lebih cepat dan tidak ada pesanan yang terlewat.
            </p>

            <p style="color:var(--muted);font-size:14px;line-height:1.6;margin:8px 0">
              Pesanan dari 6 siswa (Ani, Budi, Citra, Dedi, Eka, Fira) mencakup pilihan makanan (Donat, Sosis, Cireng) dan minuman (Es Teh, Kopi, Jus Buah) yang mereka suka.
            </p>

            <p style="color:var(--muted);font-size:14px;line-height:1.6;margin:8px 0">
              Pertanyaan pemantik:
            </p>
            <ul style="color:var(--muted);font-size:14px;line-height:1.6;margin:6px 0 10px 18px">
              <li>Bagaimana cara terbaik untuk menampilkan hubungan antara nama siswa dengan pilihan makanan favorit mereka?</li>
              <li>Apakah semua cara menampilkan hubungan sama pentingnya? Mana yang paling memudahkan ibu kantin?</li>
              <li>Apa perbedaan antara relasi (hubungan biasa) dan fungsi (hubungan dengan syarat khusus)?</li>
            </ul>

            <p style="color:var(--accent);font-weight:700;font-size:14px;line-height:1.6;margin:10px 0">
              Tugas: Sajikan hubungan antara siswa-makanan dan siswa-minuman dalam berbagai bentuk penyajian relasi agar ibu kantin dapat melayani dengan lebih efisien.
            </p>
          </div>

          <!-- Textarea untuk siswa menuliskan solusi -->
          <div style="max-width:800px;margin:20px auto">
            <label style="display:block;color:var(--accent);font-weight:700;font-size:16px;margin-bottom:10px">üí° Ide Solusi Awal Kalian:</label>
            <p style="color:var(--muted);font-size:14px;margin-bottom:10px">Sebelum melanjutkan, tuliskan ide awal kalian tentang bagaimana cara membantu ibu kantin:</p>
            <textarea id="solusiAwalPertemuan2" placeholder="Contoh: Saya akan membuat tabel/diagram yang menghubungkan nama siswa dengan makanan dan minuman favorit mereka..." style="width:100%;min-height:120px;padding:14px;border-radius:10px;border:2px solid rgba(0,0,0,0.1);background:#fff;font-family:sans-serif;font-size:14px;resize:vertical;box-sizing:border-box"></textarea>
            <p style="color:var(--muted);font-size:12px;margin-top:8px;font-style:italic">üí≠ Tidak apa jika belum yakin, tuliskan saja apa yang terpikirkan saat ini!</p>
          </div>

          <p style="color:var(--accent);font-weight:700;margin:16px 0;font-size:18px">Misi Kalian:</p>
          <p style="color:var(--muted);margin-bottom:10px;font-size:14px;line-height:1.6">Membantu ibu kantin dengan menampilkan pesanan dalam berbagai bentuk penyajian relasi (diagram panah, himpunan pasangan berurutan, diagram kartesius, dan tabel) sehingga mudah dipahami dan pesanan dapat dilayani dengan cepat dan akurat!</p>

          <div style="display:flex;gap:8px;justify-content:center;margin-top:12px">
            <button class="btn ghost" data-go="menu">‚üµ Kembali</button>
            <button class="btn" data-go="identitas-kelompok">Lanjut ‚ü∂</button>
          </div>
        </div>
      </div>
    </section>

    <section class="slide" id="identitas-kelompok">
      <div class="panel">
        <div class="header">
          <h1>üë• Data Kelompok</h1>
          <div class="lead">Isi nama kelompok dan anggota kelompok Anda sebelum memulai.</div>
        </div>

        <div class="content" style="max-width:700px;margin:0 auto">
          <div class="card-lite" style="background:#fff;padding:16px;border-radius:10px;margin-bottom:20px">
            <label style="display:block;margin-bottom:8px;font-weight:bold;color:var(--accent);font-size:16px">üìù Nama Kelompok</label>
            <input type="text" id="namaKelompok" class="input" style="width:100%;padding:10px;border-radius:8px;border:2px solid #d1d5db;font-family:'Poppins',sans-serif;font-size:15px;box-sizing:border-box" placeholder="Contoh: Kelompok Avengers">
          </div>

          <!-- PREVIEW ANGGOTA YANG SUDAH DI-INPUT -->
          <div class="card-lite" style="background:#f9f5ff;border-left:4px solid #c084fc;padding:16px;border-radius:10px;margin-bottom:20px">
            <label style="color:var(--accent);font-weight:700;font-size:16px;display:block;margin-bottom:12px">‚úÖ Anggota yang Sudah Terdaftar</label>
            <div id="previewAnggota" style="display:flex;flex-direction:column;gap:12px;min-height:40px">
              <div style="color:var(--muted);font-size:14px;text-align:center;padding:20px">
                üìù Belum ada anggota yang di-input. Isi form di bawah untuk mulai.
              </div>
            </div>
          </div>

          <!-- FORM INPUT ANGGOTA -->
          <div class="card-lite" style="background:#fff;padding:16px;border-radius:10px">
            <label style="color:var(--accent);font-weight:700;font-size:16px;display:block;margin-bottom:12px">üë§ Input Anggota &amp; Tugas Kelompok</label>
            <div style="font-size:13px;color:var(--muted);margin-bottom:16px;padding:10px;background:#fff3cd;border-radius:6px;border-left:3px solid #ffcb64">
              <b>üí° Petunjuk:</b> Isi nama dan pilih peran untuk setiap anggota, kemudian klik <b>"INPUT"</b>. Tugas lengkap akan terlihat setelah Anda mengklik tombol tersebut.
            </div>

            <div style="display:flex;gap:8px;margin-bottom:12px">
              <div style="flex:1">
                <label style="display:block;font-size:12px;color:var(--accent);font-weight:700;margin-bottom:4px">Nama Anggota</label>
                <input type="text" id="inputNamaAnggota" placeholder="Ketik nama anggota..." style="width:100%;padding:10px;border-radius:6px;border:2px solid #d1d5db;font-family:'Poppins',sans-serif;font-size:14px;box-sizing:border-box">
              </div>
              <div style="flex:1">
                <label style="display:block;font-size:12px;color:var(--accent);font-weight:700;margin-bottom:4px">Pilih Peran</label>
                <select id="selectPenanggungJawab" style="width:100%;padding:10px;border-radius:6px;border:2px solid #d1d5db;font-family:'Poppins',sans-serif;font-size:14px;box-sizing:border-box">
                  <option value="">-- Pilih peran --</option>
                  <option value="Ketua Kelompok">Ketua Kelompok</option>
                  <option value="Wakil Ketua">Wakil Ketua</option>
                  <option value="Sekretaris">Sekretaris</option>
                  <option value="Anggota Aktif">Anggota Aktif</option>
                  <option value="Anggota">Anggota</option>
                </select>
              </div>
              <div>
                <label style="display:block;font-size:12px;color:var(--accent);font-weight:700;margin-bottom:4px">&nbsp;</label>
                <button class="btn" id="btnInputAnggota" style="padding:10px 20px;font-size:14px;width:100%">INPUT ‚ûú</button>
              </div>
            </div>

            <!-- Deskripsi peran (muncul ketika dipilih) -->
            <div id="deskripsiPeran" style="display:none;padding:12px;background:#f0f9ff;border-radius:6px;border-left:4px solid #3b82f6;margin-bottom:12px;font-size:13px;color:#1e40af">
              <b style="display:block;margin-bottom:6px">üìã Tugas untuk peran ini:</b>
              <span id="deskripsiTeks"></span>
            </div>
          </div>

          <div style="display:flex;gap:8px;justify-content:center;margin-top:20px">
            <button class="btn ghost" data-go="permasalahan-foto">‚üµ Kembali</button>
            <button class="btn" id="lanjutTahap1Btn">Lanjut ke Tahap 1 ‚ü∂</button>
          </div>

          <div id="feedbackKelompok" style="margin-top:12px;color:var(--success);font-weight:700;text-align:center;display:none"></div>
        </div>

        <div class="footer" style="margin-top:14px">
          <div class="progress">Data Identitas Kelompok</div>
        </div>
      </div>
    </section>
    <section class="slide" id="permasalahan">
      <div class="panel" role="application" aria-label="Tahap 1 Interaktif">
        <div class="header">
          <h2>Tahap 1: Penyelidikan Model Fungsi Tarif Delivery</h2>
          <p class="small">Gunakan data tarif dari KilatAntar untuk menemukan pola dan model fungsi linear.</p>
        </div>

        <h3>Daftar Item Kantin</h3>

        <div id="items" class="items">
          <!-- Nama siswa -->
          <div class="item" draggable="true" data-type="siswa" data-value="Ani">Ani</div>
          <div class="item" draggable="true" data-type="siswa" data-value="Budi">Budi</div>
          <div class="item" draggable="true" data-type="siswa" data-value="Citra">Citra</div>
          <div class="item" draggable="true" data-type="siswa" data-value="Dedi">Dedi</div>
          <div class="item" draggable="true" data-type="siswa" data-value="Eka">Eka</div>
          <div class="item" draggable="true" data-type="siswa" data-value="Fira">Fira</div>

          <!-- Jajanan -->
          <div class="item" draggable="true" data-type="jajanan" data-value="Donat">Donat</div>
          <div class="item" draggable="true" data-type="jajanan" data-value="Cireng">Cireng</div>
          <div class="item" draggable="true" data-type="jajanan" data-value="Sosis">Sosis</div>

          <!-- Minuman -->
          <div class="item" draggable="true" data-type="minuman" data-value="Es Teh">Es Teh</div>
          <div class="item" draggable="true" data-type="minuman" data-value="Kopi">Kopi</div>
          <div class="item" draggable="true" data-type="minuman" data-value="Jus Buah">Jus Buah</div>
        </div>

        <div class="card-lite" style="margin-top:12px">
          <div style="font-weight:700;color:var(--accent);margin-bottom:6px">Atur nama himpunan</div>
          <div style="display:flex;gap:10px;flex-wrap:wrap">
            <div style="flex:1;min-width:200px">
              <label for="inputSetA" style="display:block;margin-bottom:4px;color:var(--muted)">Himpunan A</label>
              <input id="inputSetA" type="text" value="" style="width:100%;padding:10px;border-radius:10px;border:1px solid rgba(0,0,0,0.15);background:#fff">
            </div>
            <div style="flex:1;min-width:200px">
              <label for="inputSetB" style="display:block;margin-bottom:4px;color:var(--muted)">Himpunan B</label>
              <input id="inputSetB" type="text" value="" style="width:100%;padding:10px;border-radius:10px;border:1px solid rgba(0,0,0,0.15);background:#fff">
            </div>
            <div style="flex:1;min-width:200px">
              <label for="inputSetC" style="display:block;margin-bottom:4px;color:var(--muted)">Himpunan C</label>
              <input id="inputSetC" type="text" value="" style="width:100%;padding:10px;border-radius:10px;border:1px solid rgba(0,0,0,0.15);background:#fff">
            </div>
          </div>
          <div style="margin-top:6px;color:var(--muted);font-size:14px">Isi nama himpunan di atas, lalu seret setiap item ke himpunan yang sesuai jenisnya (siswa, jajanan, minuman).</div>
        </div>

        <hr style="margin:20px 0">

        <div class="row3">
          <div class="col">
            <h3>Himpunan A ‚Äî <span id="setNameA"></span></h3>
            <div id="hA" class="dropzone" data-accept="siswa"></div>
          </div>

          <div class="col">
            <h3>Himpunan B ‚Äî <span id="setNameB"></span></h3>
            <div id="hB" class="dropzone" data-accept="jajanan"></div>
          </div>

          <div class="col">
            <h3>Himpunan C ‚Äî <span id="setNameC"></span></h3>
            <div id="hC" class="dropzone" data-accept="minuman"></div>
          </div>
        </div>

        <div id="feedback" class="feedback">Belum ada aksi.</div>

        <div style="display:flex;gap:10px;justify-content:flex-end;margin-top:20px">
          <button class="btn ghost" data-go="identitas-kelompok">‚üµ Kembali</button>
          <button class="btn" id="cek">Cek Hasil</button>
          <button class="btn ghost" id="reset">Reset</button>
          <button class="btn ghost" data-go="k1">Lanjut ‚ü∂</button>
        </div>
      </div>
    </section>

    <section class="slide" id="k1">
  <div class="panel">
    <h2>Kegiatan 1 ‚Äì Merumuskan Aturan Hubungan</h2>

    <!-- PENGANTAR AKTIVITAS -->
    <div style="margin-bottom:16px;padding:12px;border-radius:10px;background:#fff3cd;border-left:4px solid #ffcb64;color:#3e2723">
      <strong style="display:block;margin-bottom:6px">üìå Mengapa Kegiatan Ini Penting?</strong>
      <div class="small">Gunakan aktivitas berikut untuk menentukan jawaban: "Apa nama konsep yang menghubungkan dua himpunan?" Dengan memahami ini, kalian dapat menjelaskan hubungan antar himpunan dalam kantin kepada ibu pemilik.</div>
    </div>

    <p class="small">
      Kalian telah memilah anggota Himpunan A (Nama Siswa), B (Jajanan), dan C (Minuman).  
      Sekarang panitia membutuhkan aturan untuk <strong>menghubungkan</strong> anggota dari dua himpunan tersebut.
    </p>

    <!-- CLUE -->
    <div style="margin-top:10px">
      <button class="btn ghost" id="btnClueRelasi">Lihat Clue</button>
    </div>

    <h3 style="margin-top:18px">Pilih Jawaban yang Menurutmu Benar</h3>

    <div id="pilihanRelasi" style="margin-top:10px;display:flex;flex-direction:column;gap:10px">

      <button class="btn ghost relasiOption" data-value="Himpunan">
        A. Himpunan
      </button>

      <button class="btn ghost relasiOption" data-value="Relasi">
        B. Relasi
      </button>

      <button class="btn ghost relasiOption" data-value="Fungsi">
        C. Fungsi
      </button>

      <button class="btn ghost relasiOption" data-value="Pasangan">
        D. Pasangan Berurutan
      </button>

    </div>

    <div id="feedbackRelasi" class="feedback" style="margin-top:15px;font-size:16px;"></div>
    <hr style="margin:25px 0">

    <h3>Tuliskan Kesimpulanmu</h3>
    <p class="small">Setelah melihat clue dan mencoba menjawab, jelaskan alasan kalian memilih jawaban diatas. Tuliskan penjelasan mengapa <strong>relasi</strong> adalah jawaban yang tepat untuk menghubungkan siswa dengan makanan/minuman kesukaan mereka.</p>

    <textarea id="k2_penemuan_input"
              placeholder="Tuliskan pengertian relasi menurut pemahamanmu..."
              style="width:100%;height:140px;padding:10px;border-radius:12px;border:2px solid rgba(0,0,0,0.08);font-family:'Poppins';font-size:16px;">
    </textarea>

    <div style="display:flex;justify-content:flex-end;margin-top:12px;gap:10px">
      <button class="btn ghost" data-go="permasalahan">‚üµ Kembali</button>
      <button class="btn" id="btnKonfirmasiRelasi">Konfirmasi</button>
      <button class="btn ghost" data-go="k2" id="toK2Btn">Lanjut ‚ü∂</button>
    </div>
  </div>
    </section>

    <section class="slide" id="k2">
      <h2>Kegiatan 2: Membuat Himpunan</h2>
      
      <!-- PENGANTAR AKTIVITAS -->
      <div style="margin-bottom:14px;padding:12px;border-radius:10px;background:#fff3cd;border-left:4px solid #ffcb64;color:#3e2723">
        <strong style="display:block;margin-bottom:6px">üìå Mengapa Kegiatan Ini Penting?</strong>
        <div class="small">Aktivitas ini membantu kalian mengidentifikasi anggota dari setiap himpunan (Nama Siswa, Makanan Kesukaan, Minuman Kesukaan). Dengan cara ini, kalian dapat memahami domain dan kodomain dari relasi yang akan dibuat.</div>
      </div>

      <p>Dari wawancara, isilah tiga himpunan berikut (masukkan beberapa nama di tiap titik):</p>
      <div class="sets-row">
        <div class="set-box">
          <div class="set-title"><span id="k2SetNameA">Himpunan A</span></div>
          <div class="oval" id="oval_teman">
            <div class="dot-line" contenteditable="true" id="t1"></div>
            <div class="dot-line" contenteditable="true" id="t2"></div>
            <div class="dot-line" contenteditable="true" id="t3"></div>
            <div class="dot-line" contenteditable="true" id="t4"></div>
          </div>
        </div>
        <div class="set-box">
          <div class="set-title"><span id="k2SetNameB">Himpunan B</span></div>
          <div class="oval" id="oval_makanan">
            <div class="dot-line" contenteditable="true" id="m1"></div>
            <div class="dot-line" contenteditable="true" id="m2"></div>
            <div class="dot-line" contenteditable="true" id="m3"></div>
            <div class="dot-line" contenteditable="true" id="m4"></div>
          </div>
        </div>
        <div class="set-box">
          <div class="set-title"><span id="k2SetNameC">Himpunan C</span></div>
          <div class="oval" id="oval_minuman">
            <div class="dot-line" contenteditable="true" id="d1"></div>
            <div class="dot-line" contenteditable="true" id="d2"></div>
            <div class="dot-line" contenteditable="true" id="d3"></div>
            <div class="dot-line" contenteditable="true" id="d4"></div>
          </div>
        </div>
      </div>
      <div class="nav"><button class="btn" data-go="k1">Back</button><button class="btn" data-go="pilih-kegiatan">Next</button></div>
    </section>

    <!-- SLIDE PEMILIHAN KEGIATAN -->
    <section class="slide" id="pilih-kegiatan">
      <h2 style="text-align:center;color:var(--accent);margin-bottom:16px">üéØ Pilih Cara Menyajikan Relasi</h2>
      
      <div style="max-width:900px;margin:0 auto 24px;padding:16px;background:#fff3cd;border-radius:12px;border-left:4px solid #ffcb64">
        <strong style="display:block;margin-bottom:8px;color:var(--accent)">üìå Petunjuk Pemilihan:</strong>
        <p style="color:var(--muted);font-size:14px;line-height:1.6;margin:0">
          Kalian akan menggambar <strong>SATU relasi secara lengkap</strong> sesuai pilihan kalian. Setelah itu, kalian akan melihat preview singkat dari 2 bentuk lainnya. Pilih sesuai gaya belajar kalian!
        </p>
      </div>

      <div class="choice-container">
        <!-- CHOICE 1: Diagram Panah -->
        <div class="choice-card" data-choice="k3" id="choice-k3">
          <span class="choice-icon">üéØ</span>
          <div class="choice-title">Diagram Panah</div>
          <div class="choice-desc">
            Menggambar panah dari domain ke kodomain menggunakan canvas interaktif. Cocok untuk learner yang suka visualisasi hubungan langsung.
          </div>
          <span class="choice-badge visual">Visual Learner</span>
          <div style="margin-top:12px;font-size:13px;color:#666">
            ‚è±Ô∏è Waktu: ~12-15 menit
          </div>
        </div>

        <!-- CHOICE 2: Diagram Kartesius -->
        <div class="choice-card" data-choice="k4" id="choice-k4">
          <span class="choice-icon">üìä</span>
          <div class="choice-title">Diagram Kartesius</div>
          <div class="choice-desc">
            Menempatkan titik pada koordinat (x,y) untuk merepresentasikan relasi. Cocok untuk yang suka sistem koordinat dan analisis matematis.
          </div>
          <span class="choice-badge analytic">Analytic Learner</span>
          <div style="margin-top:12px;font-size:13px;color:#666">
            ‚è±Ô∏è Waktu: ~12-15 menit
          </div>
        </div>

        <!-- CHOICE 3: Pasangan Terurut -->
        <div class="choice-card" data-choice="k5" id="choice-k5">
          <span class="choice-icon">üìù</span>
          <div class="choice-title">Pasangan Terurut</div>
          <div class="choice-desc">
            Menulis relasi dalam bentuk notasi aljabar {(a,b), (c,d)}. Cocok untuk yang suka representasi ringkas dan simbolik.
          </div>
          <span class="choice-badge verbal">Verbal Learner</span>
          <div style="margin-top:12px;font-size:13px;color:#666">
            ‚è±Ô∏è Waktu: ~8-10 menit
          </div>
        </div>
      </div>

      <div style="text-align:center;margin-top:28px">
        <button class="btn" id="btnMulaiKegiatan" disabled style="padding:14px 32px;font-size:18px;opacity:0.5;cursor:not-allowed">
          Mulai Kegiatan Terpilih
        </button>
        <p id="pilihanInfo" style="margin-top:12px;color:var(--muted);font-size:14px">
          ‚¨ÜÔ∏è Klik salah satu kartu di atas untuk memilih
        </p>
      </div>

      <div class="nav" style="margin-top:24px">
        <button class="btn ghost" data-go="k2">‚üµ Kembali</button>
      </div>
    </section>

    <section class="slide" id="k3">
      <h2>Kegiatan 3: Diagram Panah Interaktif</h2>
      
      <!-- PENGANTAR AKTIVITAS -->
      <div style="margin-bottom:14px;padding:12px;border-radius:10px;background:#fff3cd;border-left:4px solid #ffcb64;color:#3e2723">
        <strong style="display:block;margin-bottom:6px">üìå Mengapa Kegiatan Ini Penting?</strong>
        <div class="small">Diagram panah adalah salah satu cara visual untuk menunjukkan relasi antar himpunan. Dengan menggambar panah dari siswa ke makanan/minuman yang disukai, kalian dapat dengan jelas melihat pola hubungan dan mengidentifikasi domain, kodomain, serta range.</div>
      </div>

      <p>Gambarlah dua relasi (Makanan & Minuman Kesukaan) dengan menghubungkan titik menggunakan panah. Klik 'Gambar Panah' terlebih dahulu.</p>

      <!-- Papan Pesanan: Tetap Terlihat (Sticky) -->
      <div class="papan-sticky" aria-live="polite">
        <div class="title">Papan Pesanan Kantin <span class="badge">Acuan Menggambar</span></div>
        <div class="grid">
          <div class="panel">
            <div style="font-weight:700;color:var(--accent);margin-bottom:6px">Menu Makanan Tersedia</div>
            <ul>
              <li>Donat</li>
              <li>Sosis</li>
              <li>Cireng</li>
            </ul>
          </div>
          <div class="panel">
            <div style="font-weight:700;color:var(--accent);margin-bottom:6px">Menu Minuman Tersedia</div>
            <ul>
              <li>Es Teh</li>
              <li>Kopi</li>
              <li>Jus Buah</li>
            </ul>
          </div>
          <div class="panel">
            <div style="font-weight:700;color:var(--accent);margin-bottom:6px">Daftar Pesanan Makanan</div>
            <ul style="list-style:disc">
              <li>Ani memesan Donat</li>
              <li>Budi memesan Sosis</li>
              <li>Citra memesan Donat</li>
              <li>Dedi memesan Sosis</li>
            </ul>
          </div>
          <div class="panel">
            <div style="font-weight:700;color:var(--accent);margin-bottom:6px">Daftar Pesanan Minuman</div>
            <ul style="list-style:disc">
              <li>Ani memesan Es Teh</li>
              <li>Budi memesan Kopi</li>
              <li>Citra memesan Es Teh</li>
              <li>Dedi memesan Kopi</li>
            </ul>
          </div>
        </div>
        <div style="margin-top:8px;color:var(--muted)"><strong>Petunjuk:</strong> Domain = <span id="domainHintName">Nama Siswa</span>. Kodomain = <span id="kodomainHintName">Semua Menu</span>. Range = Menu yang benar-benar mendapat panah saat kamu menggambar.</div>
      </div>

      <!-- RELASI MAKANAN KESUKAAN -->
      <h3 style="margin-top:20px;text-align:center">Relasi 1: Makanan Kesukaan</h3>
      <div class="diagram-area" id="diagramArea1" style="margin-bottom:20px">
        <div class="set-box" style="align-items:flex-end">
          <div class="set-title"><span id="k3SetNameA1">Himpunan A</span></div>
          <div class="oval" style="width:200px;height:300px" id="c_teman1">
            <div class="dot-line" id="ct1_1" contenteditable="true"></div>
            <div class="dot-line" id="ct2_1" contenteditable="true"></div>
            <div class="dot-line" id="ct3_1" contenteditable="true"></div>
            <div class="dot-line" id="ct4_1" contenteditable="true"></div>
          </div>
        </div>
        <canvas id="drawCanvas1" width="400" height="300" style="z-index: 5; border-radius: 12px; box-shadow: rgba(0, 0, 0, 0.08) 0px 8px 20px; width: 400px; height: 300px;"></canvas>
        <div class="set-box" style="align-items:flex-start">
          <div class="set-title"><span id="k3SetNameB1">Himpunan B</span></div>
          <div class="oval" style="width:200px;height:300px" id="c_items1">
            <div class="dot-line" id="cm1_1" contenteditable="true"></div>
            <div class="dot-line" id="cm2_1" contenteditable="true"></div>
            <div class="dot-line" id="cm3_1" contenteditable="true"></div>
            <div class="dot-line" id="cm4_1" contenteditable="true"></div>
          </div>
        </div>
      </div>
      <div class="toolbar">
        <button class="tool active" id="drawBtn1">Gambar Panah</button>
        <button class="tool" id="eraseBtn1">Hapus Gambar</button>
        <button class="tool" id="undoBtn1">Undo</button>
        <button class="tool" id="saveImgBtn1">Simpan Gambar</button>
      </div>

      <!-- Pertanyaan Range vs Kodomain (Untuk Relasi 1) -->
      <div id="rangeQuestion1" style="max-width:920px;margin:14px auto;padding:14px;border-radius:12px;background:#fffef7;border:2px dashed #ffd199;color:var(--muted)">
        <div style="font-weight:700;color:var(--accent);margin-bottom:8px">üîç Pertanyaan Investigasi: Domain, Kodomain, dan Range</div>
        <div style="margin-bottom:10px">Berdasarkan diagram panah yang kamu gambar untuk Relasi 1 (Makanan), sebutkan anggota Himpunan B (Kodomain) yang <strong>tidak mendapatkan panah</strong>!</div>
        <div style="display:flex;gap:10px;flex-wrap:wrap;align-items:center">
          <input type="text" id="jawabanTidakTerhubung1" placeholder="Ketik menu yang tidak mendapat panah..." style="flex:1;min-width:220px;padding:10px;border-radius:10px;border:1px solid rgba(0,0,0,0.12)">
          <button class="btn" id="cekJawaban1">Cek Jawaban</button>
          <button class="btn ghost" id="cekOtomatis1" title="Cek berdasarkan ujung panah di kanvas">Cek Otomatis</button>
        </div>
        <div id="feedbackJawaban1" class="feedback" style="margin-top:8px"></div>
      </div>

      <!-- RELASI MINUMAN KESUKAAN -->
      <h3 style="margin-top:30px;text-align:center">Relasi 2: Minuman Kesukaan</h3>
      <div class="diagram-area" id="diagramArea2">
        <div class="set-box" style="align-items:flex-end">
          <div class="set-title"><span id="k3SetNameA2">Himpunan A</span></div>
          <div class="oval" style="width:200px;height:300px" id="c_teman2">
            <div class="dot-line" id="ct1_2" contenteditable="true"></div>
            <div class="dot-line" id="ct2_2" contenteditable="true"></div>
            <div class="dot-line" id="ct3_2" contenteditable="true"></div>
            <div class="dot-line" id="ct4_2" contenteditable="true"></div>
          </div>
        </div>
        <canvas id="drawCanvas2" width="400" height="300" style="z-index: 5; border-radius: 12px; box-shadow: rgba(0, 0, 0, 0.08) 0px 8px 20px; width: 400px; height: 300px;"></canvas>
        <div class="set-box" style="align-items:flex-start">
          <div class="set-title"><span id="k3SetNameC2">Himpunan C</span></div>
          <div class="oval" style="width:200px;height:300px" id="c_items2">
            <div class="dot-line" id="cm1_2" contenteditable="true"></div>
            <div class="dot-line" id="cm2_2" contenteditable="true"></div>
            <div class="dot-line" id="cm3_2" contenteditable="true"></div>
            <div class="dot-line" id="cm4_2" contenteditable="true"></div>
          </div>
        </div>
      </div>
      <div class="toolbar">
        <button class="tool active" id="drawBtn2">Gambar Panah</button>
        <button class="tool" id="eraseBtn2">Hapus Gambar</button>
        <button class="tool" id="undoBtn2">Undo</button>
        <button class="tool" id="saveImgBtn2">Simpan Gambar</button>
      </div>

      <div class="nav"><button class="btn" data-go="pilih-kegiatan">Back</button><button class="btn" data-go="preview-activities">Next</button></div>
    </section>

    <section class="slide" id="k4">
      <h2>Kegiatan 4: Diagram Kartesius</h2>
      
      <!-- PENGANTAR AKTIVITAS -->
      <div style="margin-bottom:14px;padding:12px;border-radius:10px;background:#fff3cd;border-left:4px solid #ffcb64;color:#3e2723">
        <strong style="display:block;margin-bottom:6px">üìå Mengapa Kegiatan Ini Penting?</strong>
        <div class="small">Diagram kartesius adalah representasi alternatif dari relasi menggunakan koordinat (x,y). Dengan membuat diagram kartesius untuk relasi makanan dan minuman kesukaan, kalian dapat membandingkan berbagai cara menyajikan relasi yang sama.</div>
      </div>

      <p>Menggambar Diagram Kartesius ‚Äî **pilih mode 'Tambah Titik' atau 'Gambar Bebas'** di bawah ini.</p>
      <div class="toolbar" id="cartToolbar">
        <button class="tool active" id="pointTool">Tambah Titik</button>
        <button class="tool" id="drawTool">Gambar Bebas</button>
        <button class="tool" id="undoCanvas">Undo</button>
        <button class="tool" id="clearCanvas">Hapus Semua</button>
        <button class="tool" id="saveCanvas">Simpan Gambar</button>
      </div>

      <div class="canvas-box">
        <div class="label">Relasi Makanan Kesukaan</div>
        
        <div style="display:flex;gap:18px;margin-bottom:12px;flex-wrap:wrap">
          <div style="flex:1;min-width:280px">
            <label style="font-weight:700;color:var(--accent);margin-bottom:4px;display:block">Domain (Sumbu X) ‚Äî <span id="domainAxis1">Nama Siswa</span>:</label>
            <input type="text" id="domain1_input" placeholder="Pisahkan dengan koma: Ani, Budi, Citra, Dedi" style="width:100%;padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.12);font-size:14px">
            <button class="btn" id="applyDomain1" style="margin-top:6px;padding:6px 12px;font-size:13px">Terapkan Domain</button>
          </div>
          <div style="flex:1;min-width:280px">
            <label style="font-weight:700;color:var(--accent);margin-bottom:4px;display:block">Kodomain (Sumbu Y) ‚Äî <span id="kodomainAxis1">Menu Makanan</span>:</label>
            <input type="text" id="kodomain1_input" placeholder="Pisahkan dengan koma: Donat, Sosis, Cireng" style="width:100%;padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.12);font-size:14px">
            <button class="btn" id="applyKodomain1" style="margin-top:6px;padding:6px 12px;font-size:13px">Terapkan Kodomain</button>
          </div>
        </div>
        
        <canvas id="plane1" width="900" height="320"></canvas>
      </div>
      <div class="canvas-box">
        <div class="label">Relasi Minuman Kesukaan</div>
        
        <div style="display:flex;gap:18px;margin-bottom:12px;flex-wrap:wrap">
          <div style="flex:1;min-width:280px">
            <label style="font-weight:700;color:var(--accent);margin-bottom:4px;display:block">Domain (Sumbu X) ‚Äî <span id="domainAxis2">Nama Siswa</span>:</label>
            <input type="text" id="domain2_input" placeholder="Pisahkan dengan koma: Ani, Budi, Citra, Dedi" style="width:100%;padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.12);font-size:14px">
            <button class="btn" id="applyDomain2" style="margin-top:6px;padding:6px 12px;font-size:13px">Terapkan Domain</button>
          </div>
          <div style="flex:1;min-width:280px">
            <label style="font-weight:700;color:var(--accent);margin-bottom:4px;display:block">Kodomain (Sumbu Y) ‚Äî <span id="kodomainAxis2">Menu Minuman</span>:</label>
            <input type="text" id="kodomain2_input" placeholder="Pisahkan dengan koma: Es Teh, Kopi, Jus Buah" style="width:100%;padding:8px;border-radius:8px;border:1px solid rgba(0,0,0,0.12);font-size:14px">
            <button class="btn" id="applyKodomain2" style="margin-top:6px;padding:6px 12px;font-size:13px">Terapkan Kodomain</button>
          </div>
        </div>
        
        <canvas id="plane2" width="900" height="320"></canvas>
      </div>

      <div class="nav"><button class="btn" data-go="pilih-kegiatan">Back</button><button class="btn" data-go="preview-activities">Next</button></div>
    </section>

    <section class="slide" id="k5">
      <h2>Kegiatan 5: Pasangan Terurut &amp; Kesimpulan</h2>
      
      <!-- PENGANTAR AKTIVITAS -->
      <div style="margin-bottom:14px;padding:12px;border-radius:10px;background:#fff3cd;border-left:4px solid #ffcb64;color:#3e2723">
        <strong style="display:block;margin-bottom:6px">üìå Mengapa Kegiatan Ini Penting?</strong>
        <div class="small">Pasangan terurut (a,b) adalah notasi aljabar yang paling ringkas untuk menyatakan relasi. Dengan menyajikan relasi dalam bentuk ini dan menulis kesimpulan, kalian menyintesiskan semua pemahaman dari berbagai representasi yang telah dipelajari.</div>
      </div>

      <p>Mari menuliskan relasi dalam bentuk pasangan terurut dan tuliskan kesimpulan pembelajaran hari ini.</p>
      <div style="max-width:920px;margin:10px auto;text-align:center">
        <div style="display:flex;gap:12px;justify-content:center;flex-wrap:wrap;margin-bottom:14px">
          <textarea id="pairs_food" placeholder="Pasangan terurut makanan (contoh: {(Ali, Nasi)})" class="input-large-half"></textarea>
          <textarea id="pairs_drink" placeholder="Pasangan terurut minuman (contoh: {(Siti, Teh)})" class="input-large-half"></textarea>
        </div>
        <div style="margin-top:10px">
          <textarea id="conclusion" placeholder="Kesimpulan pembelajaran hari ini..." class="input-large" style="width:88%;height:160px;"></textarea>
        </div>
      </div>

      <div style="display:flex;gap:12px;justify-content:center;margin-top:14px">
        <button class="btn" data-go="pilih-kegiatan">Back</button>
        <button class="btn" id="finishBtn">Tandai Selesai</button>
        <button class="btn" data-go="preview-activities">Next ‚ü∂</button>
      </div>
    </section>

    <!-- SLIDE PREVIEW AKTIVITAS LAINNYA -->
    <section class="slide" id="preview-activities">
      <h2 style="text-align:center;color:var(--accent);margin-bottom:20px">üëÄ Preview: Bentuk Penyajian Lainnya</h2>
      
      <div style="max-width:900px;margin:0 auto 24px;padding:16px;background:#e8f5e9;border-radius:12px;border-left:4px solid #4caf50">
        <strong style="display:block;margin-bottom:8px;color:#2e7d32">‚úÖ Kegiatan Utama Selesai!</strong>
        <p style="color:#1b5e20;font-size:14px;line-height:1.6;margin:0">
          Kalian telah menyelesaikan <strong id="completedActivityName">kegiatan terpilih</strong>. Sekarang mari lihat 2 bentuk representasi lainnya secara singkat untuk memperluas pemahaman.
        </p>
      </div>

      <div id="previewContainer" style="max-width:900px;margin:0 auto">
        <!-- Preview akan dimuat via JavaScript -->
      </div>

      <div style="text-align:center;margin-top:32px;padding:20px;background:#fff3d9;border-radius:12px;max-width:700px;margin-left:auto;margin-right:auto">
        <h3 style="color:var(--accent);margin-bottom:12px">üí° Refleksi Singkat</h3>
        <p style="color:var(--muted);font-size:14px;margin-bottom:16px">
          Setelah melihat 3 bentuk representasi relasi, mana yang paling mudah dipahami menurutmu?
        </p>
        <textarea id="refleksiPemilihan" 
          placeholder="Tuliskan pendapatmu tentang ketiga bentuk representasi relasi..."
          style="width:100%;padding:12px;border-radius:10px;border:2px solid rgba(0,0,0,0.1);font-family:'Poppins';min-height:100px;resize:vertical"></textarea>
        <button class="btn" id="simpanRefleksiPemilihan" style="margin-top:12px">üíæ Simpan Refleksi</button>
        <div id="feedbackRefleksi" style="margin-top:10px;color:#2e7d32;font-weight:600"></div>
      </div>

      <div class="nav" style="margin-top:28px">
        <button class="btn ghost" id="backToSelectedActivity">‚üµ Kembali ke Kegiatan</button>
        <button class="btn" data-go="penyajian-relasi">Lanjut ke Gallery Walk ‚ü∂</button>
      </div>
    </section>

    <!-- Fase 4: Penyajian Hasil Karya -->
    <section class="slide" id="penyajian-relasi">
      <h2 style="color:var(--accent);margin-bottom:20px">üé® Fase 4: Penyajian Hasil Karya (Gallery Walk)</h2>
      <p style="color:var(--muted);margin-bottom:20px">
        Kalian sudah menyelesaikan kegiatan terpilih dan melihat preview bentuk lainnya. Sekarang pilih bentuk penyajian mana yang paling efektif untuk menyampaikan pemahaman relasi kalian kepada kelompok lain!
      </p>

      <!-- BAGIAN A: PILIH BENTUK PENYAJIAN RELASI -->
      <div class="card-lite">
        <div style="font-weight:700;color:var(--accent);margin-bottom:12px">üìä A. Pilih Bentuk Penyajian Relasi Kalian</div>
        <p style="color:var(--muted);font-size:14px;margin-bottom:12px">
          Kalian bisa menampilkan relasi makanan dalam bentuk:
        </p>
        
        <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(230px,1fr));gap:12px;margin-bottom:16px">
          <label class="penyajian-option">
            <input type="radio" name="bentukPenyajianRelasi" value="diagram-panah" checked>
            <span>üéØ Diagram Panah</span>
          </label>
          <label class="penyajian-option">
            <input type="radio" name="bentukPenyajianRelasi" value="diagram-kartesius">
            <span>üìä Diagram Kartesius</span>
          </label>
          <label class="penyajian-option">
            <input type="radio" name="bentukPenyajianRelasi" value="pasangan-terurut">
            <span>üìù Pasangan Terurut</span>
          </label>
        </div>

        <textarea id="deskripsiPenyajianRelasi" 
          placeholder="Jelaskan mengapa bentuk ini terbaik untuk menyajikan relasi... (contoh: Diagram panah paling jelas karena visualnya menunjukkan hubungan langsung antar anggota himpunan)"
          style="width:100%;padding:12px;border-radius:8px;border:2px solid #ddd;font-family:'Poppins';min-height:80px"></textarea>

        <button class="btn" id="btnSimpanPenyajianRelasi" style="margin-top:12px">üíæ Simpan Penyajian Kami</button>
        <div id="feedbackPenyajianRelasi" style="margin-top:12px"></div>
        
        <!-- AREA DISPLAY PENYAJIAN -->
        <div id="galleryDisplayBox" class="gallery-display-box">
          <div class="gallery-header">
            <div class="gallery-title">üñºÔ∏è Hasil Penyajian Kami</div>
            <div class="gallery-subtitle" id="gallerySubtitle">Bentuk: Diagram Panah</div>
          </div>
          <div class="gallery-content" id="galleryContent">
            <p style="text-align:center;color:var(--muted);padding:40px 20px">
              üì¶ Pilih bentuk penyajian dan klik "Simpan" untuk menampilkan karya kalian...
            </p>
          </div>
        </div>
      </div>

      <!-- BAGIAN B: GALLERY WALK - KOMENTAR DARI KELOMPOK LAIN -->
      <div class="card-lite" style="margin-top:20px">
        <div style="font-weight:700;color:var(--accent);margin-bottom:12px">üë• B. Gallery Walk: Berikan Saran</div>
        <p style="color:var(--muted);font-size:14px;margin-bottom:12px">
          Kunjungi hasil karya kelompok lain yang ditampilkan di atas dan berikan saran konstruktif berdasarkan penyajian yang kalian lihat!
        </p>

        <div style="display:flex;gap:12px;margin-bottom:16px">
          <input type="text" id="namaKelompokKomentarRelasi" 
            placeholder="Nama Kelompokmu (contoh: Kelompok 1)"
            style="flex:1;padding:10px;border-radius:8px;border:2px solid #ddd">
        </div>

        <textarea id="komentarPeerReviewRelasi" 
          placeholder="Tulis saran/komentar untuk kelompok ini... (contoh: Penyajian sudah jelas, tapi coba tambahkan penjelasan apa arti panah di diagram kalian)"
          style="width:100%;padding:12px;border-radius:8px;border:2px solid #ddd;font-family:Arial;min-height:100px"></textarea>

        <button class="btn" id="btnKirimKomentarRelasi" style="margin-top:12px">üí¨ Kirim Saran</button>

        <!-- DAFTAR KOMENTAR -->
        <div id="daftarKomentarRelasi" style="margin-top:20px">
          <h4 style="color:var(--accent);margin-bottom:12px">üìù Saran dari Kelompok Lain:</h4>
          <div id="komentarListRelasi" style="max-height:300px;overflow-y:auto">
            <p style="color:var(--muted);font-style:italic">Belum ada saran. Jadilah yang pertama memberikan masukan!</p>
          </div>
        </div>
      </div>

      <!-- NAVIGASI -->
      <div style="display:flex;gap:12px;justify-content:center;margin-top:24px;flex-wrap:wrap">
        <button class="btn ghost" data-go="preview-activities">‚üµ Kembali</button>
        <button class="btn" data-go="evaluasi">Lanjut ke Evaluasi ‚ü∂</button>
      </div>
    </section>

    <section class="slide" id="evaluasi">
      <h2>Fase Evaluasi &amp; Refleksi</h2>

      <div class="card-lite">
        <div style="font-weight:700;color:var(--accent);margin-bottom:6px">1) Konsolidasi Pengertian Relasi</div>
        <div style="margin-bottom:8px;color:var(--muted)">Pilih definisi terbaik tentang relasi setelah praktikmu:</div>
        <div class="pill-row" id="relasiDefinisiGroup">
          <div class="pill" data-value="set">Sekadar kumpulan dua himpunan</div>
          <div class="pill" data-value="aturan">Aturan pemasangan antar dua himpunan</div>
          <div class="pill" data-value="garis">Garis acak yang menghubungkan titik</div>
        </div>
        <div id="feedbackRelasiDef" class="feedback"></div>
      </div>

      <div class="card-lite">
        <div style="font-weight:700;color:var(--accent);margin-bottom:6px">2) Review Cara Menyatakan Relasi</div>
        <div style="margin-bottom:8px;color:var(--muted)">Centang cara-cara menyatakan relasi yang sudah kalian pakai:</div>
        <div class="checklist">
          <label><input type="checkbox" id="chkPanah"> Diagram Panah</label>
          <label><input type="checkbox" id="chkPasangan"> Himpunan Pasangan Berurutan {(a,b),(c,d)}</label>
          <label><input type="checkbox" id="chkKartesius"> Koordinat Kartesius</label>
          <label><input type="checkbox" id="chkTabel"> Tabel / Daftar Pesanan</label>
        </div>
      </div>

      <div class="card-lite">
        <div style="font-weight:700;color:var(--accent);margin-bottom:6px">3) Pemantapan Istilah DKR</div>
        <div style="margin-bottom:6px;color:var(--muted)">Cocokkan istilah dengan artinya.</div>
        <div style="display:flex;gap:12px;flex-wrap:wrap">
          <div style="flex:1;min-width:220px">
            <div>Domain:</div>
            <select id="selDomain" style="width:100%;padding:8px;border-radius:10px;border:1px solid rgba(0,0,0,0.12)">
              <option value="">-- pilih --</option>
              <option value="awal">Himpunan awal / siapa yang memilih</option>
              <option value="menu">Seluruh menu yang tersedia</option>
              <option value="laku">Hanya menu yang laku</option>
            </select>
          </div>
          <div style="flex:1;min-width:220px">
            <div>Kodomain:</div>
            <select id="selKodomain" style="width:100%;padding:8px;border-radius:10px;border:1px solid rgba(0,0,0,0.12)">
              <option value="">-- pilih --</option>
              <option value="awal">Himpunan awal / siapa yang memilih</option>
              <option value="menu">Seluruh menu yang tersedia</option>
              <option value="laku">Hanya menu yang laku</option>
            </select>
          </div>
          <div style="flex:1;min-width:220px">
            <div>Range:</div>
            <select id="selRange" style="width:100%;padding:8px;border-radius:10px;border:1px solid rgba(0,0,0,0.12)">
              <option value="">-- pilih --</option>
              <option value="awal">Himpunan awal / siapa yang memilih</option>
              <option value="menu">Seluruh menu yang tersedia</option>
              <option value="laku">Hanya menu yang laku</option>
            </select>
          </div>
        </div>
        <div id="feedbackDKR" class="feedback"></div>
      </div>

      <div class="card-lite">
        <div style="font-weight:700;color:var(--accent);margin-bottom:6px">4) Jurnal Refleksi Digital</div>
        <div style="color:var(--muted)">Pilih emoji perasaanmu dan tuliskan satu "Aha-Moment" hari ini.</div>
        <div class="emoji-row" id="emojiRow">
          <button class="emoji-btn" data-emo="wow">ü§©</button>
          <button class="emoji-btn" data-emo="ok">üôÇ</button>
          <button class="emoji-btn" data-emo="hmm">ü§î</button>
          <button class="emoji-btn" data-emo="hard">üòµ‚Äçüí´</button>
        </div>
        <textarea id="ahaInput" placeholder="Tuliskan Aha-Moment-mu..." style="width:100%;min-height:120px;padding:10px;border-radius:12px;border:2px dashed rgba(0,0,0,0.1);background:#fff"></textarea>
      </div>

      <div class="card-lite" style="margin-top:20px;border-top:3px solid #ffcb64;padding-top:16px">
        <div style="font-weight:700;color:var(--accent);margin-bottom:10px">Bagian E: ü§î Refleksi Individu</div>
        <div style="color:var(--muted);margin-bottom:12px;font-size:14px">Jawab pertanyaan berikut dengan jujur untuk memahami pembelajaran kalian dengan lebih dalam:</div>
        
        <div style="margin-bottom:14px">
          <div style="font-weight:600;color:var(--accent);margin-bottom:6px">1Ô∏è‚É£ Bagian mana dari materi relasi yang paling membingungkan bagimu?</div>
          <textarea id="refleksi7" placeholder="Jelaskan konsep atau aktivitas yang masih membuat kalian bingung..." style="width:100%;height:100px;padding:10px;border-radius:10px;border:1px solid rgba(0,0,0,0.12);font-size:14px"></textarea>
        </div>
        
        <div style="margin-bottom:14px">
          <div style="font-weight:600;color:var(--accent);margin-bottom:6px">2Ô∏è‚É£ Kesalahan apa saja yang sempat dilakukan kelompokmu saat menggambar relasi?</div>
          <textarea id="refleksi8" placeholder="Ceritakan kesalahan atau hambatan yang dihadapi kelompok..." style="width:100%;height:100px;padding:10px;border-radius:10px;border:1px solid rgba(0,0,0,0.12);font-size:14px"></textarea>
        </div>
        
        <div style="margin-bottom:14px">
          <div style="font-weight:600;color:var(--accent);margin-bottom:6px">3Ô∏è‚É£ Mengapa menurutmu masalah kantin ini belum sepenuhnya selesai hari ini?</div>
          <textarea id="refleksi9" placeholder="Apa yang masih perlu dipelajari lebih lanjut untuk menyelesaikan masalah kantin..." style="width:100%;height:100px;padding:10px;border-radius:10px;border:1px solid rgba(0,0,0,0.12);font-size:14px"></textarea>
        </div>
      </div>

      <div style="display:flex;justify-content:flex-end;gap:10px;margin-top:12px">
        <button class="btn ghost" data-go="k5">‚üµ Back</button>
        <button class="btn" id="btnFinishEvaluasi">Selesai &amp; Tampilkan Umpan Balik</button>
        <button class="btn ghost" data-go="soal" id="toSoalBtn">Next ‚ü∂</button>
      </div>

      <div id="autoFeedback" class="feedback" style="margin-top:10px;font-size:16px;font-weight:700"></div>
      
      <!-- Tombol Kirim ke Guru -->
      <div style="margin-top:30px;padding:20px;background:#fff3d9;border-radius:12px;border:2px dashed #ffd199;text-align:center;">
        <div style="font-size:18px;font-weight:700;color:var(--accent);margin-bottom:10px;">üì§ Kirim Hasil Pembelajaran</div>
        <div style="color:var(--muted);margin-bottom:16px;font-size:14px;">Setelah menyelesaikan semua tahapan, kirim hasil ke guru dalam bentuk PDF</div>
        <button class="btn" id="btnKirimHasilGuru" style="font-size:18px;padding:14px 30px;">
          üì§ Kirim Hasil ke Guru
        </button>
        <p style="font-size:13px;color:#666;margin-top:10px;">
          Hasil pembelajaran akan dikirim sebagai PDF melalui Google Form
        </p>
      </div>
      </div>
    </section>

    <section class="slide" id="soal">
      <h2>Soal Latihan</h2>
      <p>Halaman soal akan ditambahkan nanti.</p>
      <div class="nav"><button class="btn" data-go="menu">Menu</button></div>
    </section>

  
</main>

</div></div>
</div></div>

<!-- Modal: Papan Pesanan (muncul sebelum menggambar di K3) -->
<div id="papanPesananModal" class="modal-overlay" style="display:none" aria-modal="true" role="dialog">
  <div class="modal-box">
    <div class="modal-header">
      <h3>Papan Pesanan Kantin <span class="badge">Skenario Tetap</span></h3>
      <div class="lead" style="margin-top:4px;color:var(--muted)">Bacalah papan ini. Gunakan data ini saat menggambar diagram panah.</div>
    </div>
    <div class="modal-content">
      <div class="cols">
        <div class="col">
          <div style="font-weight:700;color:var(--accent);margin-bottom:6px">Menu Tersedia ‚Äî Himpunan B (Kodomain)</div>
          <ul class="list">
            <li>Donat</li>
            <li>Sosis</li>
            <li>Cireng <span class="badge">Sengaja belum dipesan</span></li>
          </ul>
        </div>
        <div class="col">
          <div style="font-weight:700;color:var(--accent);margin-bottom:6px">Daftar Pesanan</div>
          <ul class="list" style="list-style:disc">
            <li>Ani memesan Donat</li>
            <li>Budi memesan Sosis</li>
            <li>Citra memesan Donat</li>
            <li>Dedi memesan Sosis</li>
          </ul>
        </div>
      </div>
      <div style="margin-top:10px;color:var(--muted)">
        Petunjuk: Nama siswa adalah <strong>Domain</strong>. Semua menu di papan adalah <strong>Kodomain</strong>. Yang benar-benar mendapat panah saat kamu menggambar adalah <strong>Range</strong>.
      </div>
    </div>
    <div class="modal-actions">
      <button class="btn ghost" id="tutupPapanBtn">Tutup</button>
      <button class="btn" id="pakaiSkenarioBtn">Gunakan Skenario & Mulai Menggambar</button>
    </div>
  </div>
  
</div>

<script>
// --- Navigasi global (bisa dipakai di mana saja) ---
function show(id) {
  document.querySelectorAll('.slide').forEach(s => s.classList.remove('active'));
  document.getElementById(id)?.classList.add('active');
  document.querySelector('.card')?.scrollTo(0,0);
}
window.show = show;

// Progress global (dibuat global agar bisa dipakai di luar DOMContentLoaded)
const completion = { materi: 0, k1: 0, k2: 0, k3: 0, k4: 0, k5: 0 };
let progressCountEl = null;
let downloadPdfBtn = null;
function updateProgress() {
  let done = 0;
  ['materi', 'k1', 'k2', 'k3', 'k4', 'k5'].forEach(k => done += completion[k]);
  if (progressCountEl) progressCountEl.innerText = done + '/6';
  if (downloadPdfBtn) downloadPdfBtn.disabled = (done !== 6);
}

// --- Fungsi global untuk manajemen anggota ---
function removeAnggota(btn) {
  btn.closest('div').remove();
}

function addAnggota() {
  const container = document.getElementById('anggotaContainer');
  if (!container) return;
  
  const count = container.querySelectorAll('.anggota-input').length + 1;
  if (count > 5) {
    alert('Maksimal 5 anggota');
    return;
  }
  
  const div = document.createElement('div');
  div.style.cssText = 'display:flex;gap:8px;margin-bottom:8px';
  div.innerHTML = `
    <input type="text" class="anggota-input" placeholder="Nama anggota ${count}" style="flex:1;padding:10px;border-radius:8px;border:1px solid rgba(0,0,0,0.1)">
    <select class="tanggung-jawab-select" style="padding:10px;border-radius:8px;border:1px solid rgba(0,0,0,0.1);font-family:'Poppins',sans-serif;font-size:14px;min-width:150px">
      <option value="Ketua Kelompok">Ketua Kelompok</option>
      <option value="Wakil Ketua">Wakil Ketua</option>
      <option value="Sekretaris">Sekretaris</option>
      <option value="Anggota Aktif">Anggota Aktif</option>
      <option value="Anggota">Anggota</option>
    </select>
    <button class="btn ghost" onclick="removeAnggota(this)" style="min-width:40px">‚àí</button>
  `;
  container.appendChild(div);
}

document.addEventListener('DOMContentLoaded', () => {
  // Clear data anggota saat fresh load
  localStorage.removeItem('daftarAnggotaTerdaftar');

  // =========================================================
  // 1. LOGIKA GLOBAL DAN NAVIGASI
  // =========================================================

  // Setup event listener untuk navigasi dengan data-go attribute
  document.addEventListener('click', (ev) => {
    const btn = ev.target.closest('[data-go]');
    if (btn) {
      const slideId = btn.getAttribute('data-go');
      if (slideId) {
        show(slideId);
      }
    }
  });

  // dapatkan elemen progress setelah DOM siap
  progressCountEl = document.getElementById('progressCount');
  downloadPdfBtn = document.getElementById('downloadPdf');

  // Setup tombol tambah anggota
  const addAnggotaBtn = document.getElementById('addAnggotaBtn');
  if (addAnggotaBtn) {
    addAnggotaBtn.addEventListener('click', addAnggota);
  }

  // Setup tombol lanjut tahap 1 dengan validasi
  const lanjutTahap1Btn = document.getElementById('lanjutTahap1Btn');
  if (lanjutTahap1Btn) {
    lanjutTahap1Btn.addEventListener('click', () => {
      const namaKelompok = document.getElementById('namaKelompok')?.value.trim();
      const anggotaRows = document.querySelectorAll('#anggotaContainer > div');
      const anggota = Array.from(anggotaRows).map(row => {
        const namaInput = row.querySelector('.anggota-input');
        const tanggungJawabSelect = row.querySelector('.tanggung-jawab-select');
        const nama = namaInput?.value.trim();
        const tanggungJawab = tanggungJawabSelect?.value || 'Anggota';
        return nama ? { nama, tanggungJawab } : null;
      }).filter(x => x);
      
      if (!namaKelompok) {
        alert('Isi nama kelompok terlebih dahulu');
        return;
      }
      if (anggota.length === 0) {
        alert('Isi minimal satu nama anggota');
        return;
      }
      
      // Simpan data kelompok
      const kelompokData = { nama: namaKelompok, anggota: anggota };
      localStorage.setItem('kelompokData', JSON.stringify(kelompokData));
      
      // Simpan solusi awal jika ada
      const solusiAwal = document.getElementById('solusiAwalPertemuan2')?.value.trim();
      if (solusiAwal) {
        localStorage.setItem('solusiAwalPertemuan2', solusiAwal);
      }
      
      // Jika valid, lanjut ke slide permasalahan
      show('permasalahan');
    });
  }

    // Event listener untuk semua tombol navigasi dengan data-go
    document.querySelectorAll('[data-go]').forEach(el => {
      el.addEventListener('click', function() {
        const target = this.getAttribute('data-go');
        if (target) {
          show(target);
        }
      });
    });

    // Acak urutan item Tahap 1 saat halaman dimuat
    const itemsContainer = document.getElementById('items');
    if (itemsContainer) {
      const children = Array.from(itemsContainer.children);
      children.sort(() => Math.random() - 0.5);
      children.forEach(ch => itemsContainer.appendChild(ch));
    }

    // =========================================================
    // LOGIKA PEMILIHAN KEGIATAN (Choice-Based Learning)
    // =========================================================
    let selectedActivity = localStorage.getItem('selectedActivity') || null;
    
    // Setup event listener untuk choice cards
    const choiceCards = document.querySelectorAll('.choice-card');
    const btnMulaiKegiatan = document.getElementById('btnMulaiKegiatan');
    const pilihanInfo = document.getElementById('pilihanInfo');
    
    choiceCards.forEach(card => {
      card.addEventListener('click', function() {
        // Hapus selected dari semua cards
        choiceCards.forEach(c => c.classList.remove('selected'));
        
        // Tambah selected ke card yang diklik
        this.classList.add('selected');
        
        // Simpan pilihan
        selectedActivity = this.getAttribute('data-choice');
        localStorage.setItem('selectedActivity', selectedActivity);
        
        // Enable tombol mulai
        if (btnMulaiKegiatan) {
          btnMulaiKegiatan.disabled = false;
          btnMulaiKegiatan.style.opacity = '1';
          btnMulaiKegiatan.style.cursor = 'pointer';
        }
        
        // Update info text
        const activityNames = {
          'k3': 'Diagram Panah',
          'k4': 'Diagram Kartesius',
          'k5': 'Pasangan Terurut'
        };
        if (pilihanInfo) {
          pilihanInfo.innerHTML = `‚úÖ Kamu memilih: <strong>${activityNames[selectedActivity]}</strong>`;
          pilihanInfo.style.color = '#2e7d32';
          pilihanInfo.style.fontWeight = '600';
        }
      });
    });
    
    // Restore pilihan dari localStorage
    if (selectedActivity) {
      const selectedCard = document.querySelector(`.choice-card[data-choice="${selectedActivity}"]`);
      if (selectedCard) {
        selectedCard.classList.add('selected');
        if (btnMulaiKegiatan) {
          btnMulaiKegiatan.disabled = false;
          btnMulaiKegiatan.style.opacity = '1';
          btnMulaiKegiatan.style.cursor = 'pointer';
        }
      }
    }
    
    // Handle tombol mulai kegiatan
    if (btnMulaiKegiatan) {
      btnMulaiKegiatan.addEventListener('click', function() {
        if (selectedActivity) {
          show(selectedActivity);
        } else {
          alert('Pilih salah satu kegiatan terlebih dahulu!');
        }
      });
    }
    
    // Handle back to selected activity dari preview
    const backToSelectedActivity = document.getElementById('backToSelectedActivity');
    if (backToSelectedActivity) {
      backToSelectedActivity.addEventListener('click', function() {
        const activity = localStorage.getItem('selectedActivity');
        if (activity) {
          show(activity);
        } else {
          show('pilih-kegiatan');
        }
      });
    }
    
    // Generate preview untuk kegiatan yang tidak dipilih
    function generatePreviews() {
      const selected = localStorage.getItem('selectedActivity');
      if (!selected) return;
      
      const previewContainer = document.getElementById('previewContainer');
      const completedActivityName = document.getElementById('completedActivityName');
      
      if (!previewContainer) return;
      
      const activityData = {
        'k3': {
          title: 'Diagram Panah',
          icon: 'üéØ',
          desc: 'Diagram panah menunjukkan relasi dengan menggambar anak panah dari domain (himpunan awal) ke kodomain (himpunan tujuan). Setiap panah merepresentasikan satu pasangan hubungan.',
          example: 'Jika Ani suka Donat, maka ada panah dari "Ani" ke "Donat". Visual ini sangat jelas untuk melihat hubungan one-to-one, one-to-many, atau many-to-one.'
        },
        'k4': {
          title: 'Diagram Kartesius',
          icon: 'üìä',
          desc: 'Diagram Kartesius merepresentasikan relasi sebagai titik-titik pada bidang koordinat. Sumbu X adalah domain, sumbu Y adalah kodomain.',
          example: 'Jika Budi suka Sosis, maka ada titik di koordinat (Budi, Sosis). Format ini berguna untuk analisis matematis dan mudah dihubungkan dengan konsep fungsi.'
        },
        'k5': {
          title: 'Pasangan Terurut',
          icon: 'üìù',
          desc: 'Pasangan terurut adalah notasi aljabar yang paling ringkas untuk menyatakan relasi. Ditulis dalam bentuk {(a,b), (c,d), ...}',
          example: 'Relasi makanan kesukaan dapat ditulis: {(Ani, Donat), (Budi, Sosis), (Citra, Donat), (Dedi, Sosis)}. Format ini sangat efisien dan formal.'
        }
      };
      
      const allActivities = ['k3', 'k4', 'k5'];
      const otherActivities = allActivities.filter(a => a !== selected);
      
      // Update nama kegiatan yang selesai
      if (completedActivityName) {
        completedActivityName.textContent = activityData[selected].title;
      }
      
      // Generate preview cards
      let previewHTML = '';
      otherActivities.forEach(actId => {
        const data = activityData[actId];
        previewHTML += `
          <div class="quick-preview-card">
            <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
              <span style="font-size:40px">${data.icon}</span>
              <div class="quick-preview-title">${data.title}</div>
            </div>
            <div class="quick-preview-content">
              <p><strong>Deskripsi:</strong> ${data.desc}</p>
              <p style="margin-top:10px;padding:12px;background:#fff3d9;border-radius:8px;border-left:3px solid #ffcb64">
                <strong>üí° Contoh:</strong> ${data.example}
              </p>
            </div>
          </div>
        `;
      });
      
      previewContainer.innerHTML = previewHTML;
    }
    
    // Generate preview saat masuk ke slide preview-activities
    document.addEventListener('click', (ev) => {
      const btn = ev.target.closest('[data-go]');
      if (btn && btn.getAttribute('data-go') === 'preview-activities') {
        setTimeout(() => generatePreviews(), 100);
      }
    });
    
    // Handle simpan refleksi pemilihan
    const simpanRefleksiBtn = document.getElementById('simpanRefleksiPemilihan');
    if (simpanRefleksiBtn) {
      simpanRefleksiBtn.addEventListener('click', function() {
        const refleksi = document.getElementById('refleksiPemilihan')?.value.trim();
        const feedback = document.getElementById('feedbackRefleksi');
        
        if (!refleksi) {
          if (feedback) {
            feedback.textContent = '‚ùå Mohon isi refleksi terlebih dahulu';
            feedback.style.color = '#c62828';
          }
          return;
        }
        
        localStorage.setItem('refleksiPemilihanKegiatan', refleksi);
        
        if (feedback) {
          feedback.textContent = '‚úÖ Refleksi tersimpan!';
          feedback.style.color = '#2e7d32';
        }
      });
    }

    // Salin data himpunan dari K2 ke K3 (diagram panah)
    // Saat pindah ke K3, copy nama Teman, Makanan, Minuman ke diagram
    let papanShown = false; // legacy flag (modal not used now)
    const papanModal = document.getElementById('papanPesananModal');
    const btnPakaiSkenario = document.getElementById('pakaiSkenarioBtn');
    const btnTutupPapan = document.getElementById('tutupPapanBtn');

    // Modal actions (kept for compatibility; modal tidak otomatis ditampilkan)
    function hidePapanPesanan(){ if(papanModal) papanModal.style.display='none'; }
    btnPakaiSkenario?.addEventListener('click', ()=>{ hidePapanPesanan(); });
    btnTutupPapan?.addEventListener('click', ()=>{ hidePapanPesanan(); });

    document.body.addEventListener('click', (ev) => {
      const btn = ev.target.closest('[data-go]');
      if (btn && btn.getAttribute('data-go') === 'k3') {
        // Copy data dari k2 ke k3
        // Teman: t1..t4 ‚Üí ct1_1..ct4_1 (Relasi 1) dan ct1_2..ct4_2 (Relasi 2)
        for (let i = 1; i <= 4; i++) {
          const srcTeman = document.getElementById('t' + i);
          const destTeman1 = document.getElementById('ct' + i + '_1');
          const destTeman2 = document.getElementById('ct' + i + '_2');
          if (srcTeman) {
            const val = srcTeman.textContent.trim();
            if (destTeman1) destTeman1.textContent = val;
            if (destTeman2) destTeman2.textContent = val;
          }
        }
        // Makanan: m1..m4 ‚Üí cm1_1..cm4_1
        for (let i = 1; i <= 4; i++) {
          const srcMakanan = document.getElementById('m' + i);
          const destMakanan = document.getElementById('cm' + i + '_1');
          if (srcMakanan) {
            const val = srcMakanan.textContent.trim();
            if (destMakanan) destMakanan.textContent = val;
          }
        }
        // Minuman: d1..d4 ‚Üí cm1_2..cm4_2
        for (let i = 1; i <= 4; i++) {
          const srcMinuman = document.getElementById('d' + i);
          const destMinuman = document.getElementById('cm' + i + '_2');
          if (srcMinuman) {
            const val = srcMinuman.textContent.trim();
            if (destMinuman) destMinuman.textContent = val;
          }
        }
      }
      
      // Auto-populate K4 (Diagram Kartesius) dari K2
      if (btn && btn.getAttribute('data-go') === 'k4') {
        // Ambil data dari K2
        const temanData = [];
        const makananData = [];
        const minumanData = [];
        
        for (let i = 1; i <= 4; i++) {
          const teman = document.getElementById('t' + i);
          const makanan = document.getElementById('m' + i);
          const minuman = document.getElementById('d' + i);
          
          if (teman && teman.textContent.trim()) {
            temanData.push(teman.textContent.trim());
          }
          if (makanan && makanan.textContent.trim()) {
            makananData.push(makanan.textContent.trim());
          }
          if (minuman && minuman.textContent.trim()) {
            minumanData.push(minuman.textContent.trim());
          }
        }
        
        // Auto-fill input fields K4 dengan delay kecil agar DOM sudah ready
        setTimeout(() => {
          // Domain inputs (nama siswa)
          const domain1Input = document.getElementById('domain1_input');
          const domain2Input = document.getElementById('domain2_input');
          if (domain1Input && temanData.length > 0) {
            domain1Input.value = temanData.join(', ');
          }
          if (domain2Input && temanData.length > 0) {
            domain2Input.value = temanData.join(', ');
          }
          
          // Kodomain inputs (makanan & minuman)
          const kodomain1Input = document.getElementById('kodomain1_input');
          const kodomain2Input = document.getElementById('kodomain2_input');
          if (kodomain1Input && makananData.length > 0) {
            kodomain1Input.value = makananData.join(', ');
          }
          if (kodomain2Input && minumanData.length > 0) {
            kodomain2Input.value = minumanData.join(', ');
          }
        }, 100);
      }
    });
    
    // K1 completion: textarea non-empty (min 10 chars)
    const k1input = document.getElementById('k1_input');
    if(k1input) {
      k1input.addEventListener('input', () => {
        completion.k1 = k1input.value.trim().length > 10 ? 1 : 0; 
        updateProgress();
      });
    }

    // K2 completion: Check if at least one item in each set (Teman, Makanan, Minuman) is filled
    const k2Ids = ['t1', 'm1', 'd1'];
    function checkK2Completion() {
        return k2Ids.every(id => {
            const el = document.getElementById(id);
            return el && (el.innerText || el.textContent) && (el.innerText || el.textContent).trim().length > 0;
        });
    }
    document.querySelectorAll('#k2 .dot-line[contenteditable="true"]').forEach(el => {
        el.addEventListener('input', () => {
            completion.k2 = checkK2Completion() ? 1 : 0;
            updateProgress();
        });
    });

    // K5 completion: Pasangan terurut dan Kesimpulan (min 10 chars)
    const pairsF = document.getElementById('pairs_food'), pairsD = document.getElementById('pairs_drink'), conclusion = document.getElementById('conclusion');
    if(pairsF || pairsD || conclusion) {
      [pairsF, pairsD, conclusion].forEach(el => {
        if(el) {
          el.addEventListener('input', () => {
            completion.k5 = ((pairsF?.value.trim().length > 0 || pairsD?.value.trim().length > 0) && conclusion?.value.trim().length > 10) ? 1 : 0;
            updateProgress();
          });
        }
      });
    }

    const toSoalBtn = document.getElementById('toSoalBtn');

    document.getElementById('finishBtn')?.addEventListener('click', () => {
      if (completion.k5 === 0) {
        alert('Lengkapi setidaknya satu pasangan terurut dan isi kesimpulan (min. 10 karakter) terlebih dahulu.'); 
        return;
      }
      completion.k5 = 1; 
      updateProgress(); 
      alert('Kegiatan Selesai. Lanjut ke Penyajian Relasi!');
      show('penyajian-relasi');
    });

    // ======== FASE 4: PENYAJIAN HASIL KARYA (GALLERY WALK) ========
    const btnSimpanPenyajianRelasi = document.getElementById('btnSimpanPenyajianRelasi');
    const btnKirimKomentarRelasi = document.getElementById('btnKirimKomentarRelasi');
    const feedbackPenyajianRelasi = document.getElementById('feedbackPenyajianRelasi');
    const komentarListRelasi = document.getElementById('komentarListRelasi');

    // Load komentar dari localStorage
    let daftarKomentarRelasi = JSON.parse(localStorage.getItem('komentarPeerReviewRelasi') || '[]');

    function tampilkanKomentarRelasi() {
      if (daftarKomentarRelasi.length === 0) {
        komentarListRelasi.innerHTML = '<p style="color:var(--muted);font-style:italic">Belum ada saran. Jadilah yang pertama memberikan masukan!</p>';
        return;
      }
      
      komentarListRelasi.innerHTML = daftarKomentarRelasi.map((k, idx) => `
        <div class="komentar-item">
          <div class="komentar-header">
            <span class="komentar-kelompok">üë• ${k.kelompok}</span>
            <span class="komentar-waktu">${k.waktu}</span>
          </div>
          <div class="komentar-isi">${k.komentar}</div>
        </div>
      `).join('');
    }

    // Function untuk generate gallery display
    function generateGalleryDisplay(bentuk) {
      const galleryContent = document.getElementById('galleryContent');
      const gallerySubtitle = document.getElementById('gallerySubtitle');
      const galleryBox = document.getElementById('galleryDisplayBox');
      
      if (!galleryContent || !gallerySubtitle || !galleryBox) return;
      
      const bentukLabels = {
        'diagram-panah': 'üéØ Diagram Panah',
        'diagram-kartesius': 'üìä Diagram Kartesius',
        'pasangan-terurut': 'üìù Pasangan Terurut'
      };
      
      gallerySubtitle.textContent = `Bentuk: ${bentukLabels[bentuk] || bentuk}`;
      
      let contentHTML = '';
      
      if (bentuk === 'diagram-panah') {
        // Ambil gambar canvas dari K3 (Diagram Panah)
        const canvasImg1 = localStorage.getItem('canvasImage_drawCanvas1');
        const canvasImg2 = localStorage.getItem('canvasImage_drawCanvas2');
        
        if (canvasImg1 || canvasImg2) {
          contentHTML = '<div class="gallery-image-wrapper">';
          if (canvasImg1) {
            contentHTML += `
              <div style="margin-bottom:20px">
                <div style="font-weight:700;color:var(--accent);margin-bottom:10px">Relasi 1: Makanan Kesukaan</div>
                <img src="${canvasImg1}" alt="Diagram Panah Makanan" style="max-width:100%;height:auto;border-radius:8px;box-shadow:0 4px 16px rgba(0,0,0,0.15)">
              </div>
            `;
          }
          if (canvasImg2) {
            contentHTML += `
              <div>
                <div style="font-weight:700;color:var(--accent);margin-bottom:10px">Relasi 2: Minuman Kesukaan</div>
                <img src="${canvasImg2}" alt="Diagram Panah Minuman" style="max-width:100%;height:auto;border-radius:8px;box-shadow:0 4px 16px rgba(0,0,0,0.15)">
              </div>
            `;
          }
          contentHTML += '</div>';
        } else {
          contentHTML = '<p style="text-align:center;color:var(--muted);padding:40px 20px">üìå Diagram panah belum dibuat. Kerjakan Kegiatan 3 terlebih dahulu.</p>';
        }
      } 
      else if (bentuk === 'diagram-kartesius') {
        // Ambil gambar canvas dari K4 (Diagram Kartesius)
        const plane1Img = localStorage.getItem('canvasImage_plane1');
        const plane2Img = localStorage.getItem('canvasImage_plane2');
        
        if (plane1Img || plane2Img) {
          contentHTML = '<div class="gallery-image-wrapper">';
          if (plane1Img) {
            contentHTML += `
              <div style="margin-bottom:20px">
                <div style="font-weight:700;color:var(--accent);margin-bottom:10px">Relasi 1: Makanan Kesukaan</div>
                <img src="${plane1Img}" alt="Diagram Kartesius Makanan" style="max-width:100%;height:auto;border-radius:8px;box-shadow:0 4px 16px rgba(0,0,0,0.15)">
              </div>
            `;
          }
          if (plane2Img) {
            contentHTML += `
              <div>
                <div style="font-weight:700;color:var(--accent);margin-bottom:10px">Relasi 2: Minuman Kesukaan</div>
                <img src="${plane2Img}" alt="Diagram Kartesius Minuman" style="max-width:100%;height:auto;border-radius:8px;box-shadow:0 4px 16px rgba(0,0,0,0.15)">
              </div>
            `;
          }
          contentHTML += '</div>';
        } else {
          contentHTML = '<p style="text-align:center;color:var(--muted);padding:40px 20px">üìå Diagram Kartesius belum dibuat. Kerjakan Kegiatan 4 terlebih dahulu.</p>';
        }
      } 
      else if (bentuk === 'pasangan-terurut') {
        // Ambil teks dari K5 (Pasangan Terurut)
        const pairsFood = document.getElementById('pairs_food')?.value.trim();
        const pairsDrink = document.getElementById('pairs_drink')?.value.trim();
        const conclusion = document.getElementById('conclusion')?.value.trim();
        
        if (pairsFood || pairsDrink || conclusion) {
          contentHTML = '<div class="gallery-text-wrapper">';
          
          if (pairsFood) {
            contentHTML += `
              <div class="gallery-text-item">
                <div class="gallery-text-label">üìã Pasangan Terurut Makanan:</div>
                <div class="gallery-text-content">${pairsFood}</div>
              </div>
            `;
          }
          
          if (pairsDrink) {
            contentHTML += `
              <div class="gallery-text-item">
                <div class="gallery-text-label">ü•§ Pasangan Terurut Minuman:</div>
                <div class="gallery-text-content">${pairsDrink}</div>
              </div>
            `;
          }
          
          if (conclusion) {
            contentHTML += `
              <div class="gallery-text-item">
                <div class="gallery-text-label">üí° Kesimpulan:</div>
                <div class="gallery-text-content">${conclusion}</div>
              </div>
            `;
          }
          
          contentHTML += '</div>';
        } else {
          contentHTML = '<p style="text-align:center;color:var(--muted);padding:40px 20px">üìå Pasangan terurut belum diisi. Kerjakan Kegiatan 5 terlebih dahulu.</p>';
        }
      }
      
      galleryContent.innerHTML = contentHTML;
      galleryBox.classList.add('show');
      
      // Smooth scroll ke gallery display
      setTimeout(() => {
        galleryBox.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
      }, 200);
    }
    
    // Simpan pilihan penyajian
    btnSimpanPenyajianRelasi?.addEventListener('click', () => {
      const bentukPenyajian = document.querySelector('input[name="bentukPenyajianRelasi"]:checked')?.value;
      const deskripsi = document.getElementById('deskripsiPenyajianRelasi')?.value.trim();
      
      if (!deskripsi || deskripsi.length < 20) {
        feedbackPenyajianRelasi.innerHTML = '<div style="padding:12px;border-radius:8px;background:#fef3c7;border-left:4px solid #f7b500;color:#78350f;font-weight:600">‚ö†Ô∏è Jelaskan dulu mengapa memilih bentuk penyajian ini (minimal 20 karakter)!</div>';
        return;
      }
      
      const penyajian = {
        bentuk: bentukPenyajian,
        deskripsi: deskripsi,
        timestamp: new Date().toLocaleString('id-ID')
      };
      
      localStorage.setItem('penyajianRelasiKelompok', JSON.stringify(penyajian));
      
      // Generate dan tampilkan gallery display
      generateGalleryDisplay(bentukPenyajian);
      
      feedbackPenyajianRelasi.innerHTML = `
        <div style="padding:12px;border-radius:8px;background:#d1fae5;border-left:4px solid #10b981;color:#065f46;font-weight:600">
          ‚úÖ Penyajian tersimpan! Kelompokmu memilih: <strong>${bentukPenyajian}</strong>
          <br><small>Lihat hasil karya kalian di bawah. Kelompok lain bisa memberikan saran!</small>
        </div>
      `;
    });
    
    // Auto-restore penyajian saat masuk ke slide Gallery Walk
    document.addEventListener('click', (ev) => {
      const btn = ev.target.closest('[data-go]');
      if (btn && btn.getAttribute('data-go') === 'penyajian-relasi') {
        setTimeout(() => {
          const savedPenyajian = localStorage.getItem('penyajianRelasiKelompok');
          if (savedPenyajian) {
            try {
              const data = JSON.parse(savedPenyajian);
              // Restore pilihan radio button
              const radioBtn = document.querySelector(`input[name="bentukPenyajianRelasi"][value="${data.bentuk}"]`);
              if (radioBtn) {
                radioBtn.checked = true;
              }
              // Restore deskripsi
              const deskripsiField = document.getElementById('deskripsiPenyajianRelasi');
              if (deskripsiField && data.deskripsi) {
                deskripsiField.value = data.deskripsi;
              }
              // Auto-generate display
              generateGalleryDisplay(data.bentuk);
            } catch(e) {
              console.error('Error restoring penyajian:', e);
            }
          }
        }, 100);
      }
    });

    // Kirim komentar
    btnKirimKomentarRelasi?.addEventListener('click', () => {
      const namaKelompok = document.getElementById('namaKelompokKomentarRelasi')?.value.trim();
      const komentar = document.getElementById('komentarPeerReviewRelasi')?.value.trim();
      
      if (!namaKelompok) {
        alert('‚ö†Ô∏è Tulis nama kelompokmu dulu!');
        return;
      }
      
      if (!komentar || komentar.length < 15) {
        alert('‚ö†Ô∏è Saran terlalu singkat! Berikan masukan yang membangun (minimal 15 karakter)');
        return;
      }
      
      const komentarBaru = {
        kelompok: namaKelompok,
        komentar: komentar,
        waktu: new Date().toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' })
      };
      
      daftarKomentarRelasi.push(komentarBaru);
      localStorage.setItem('komentarPeerReviewRelasi', JSON.stringify(daftarKomentarRelasi));
      
      // Reset input
      document.getElementById('komentarPeerReviewRelasi').value = '';
      
      // Tampilkan komentar
      tampilkanKomentarRelasi();
      
      // Notifikasi sukses
      alert(`‚úÖ Saran dari "${namaKelompok}" berhasil dikirim!`);
    });

    // Load komentar saat halaman dibuka
    if (komentarListRelasi) {
      tampilkanKomentarRelasi();
    }


    // =========================================================
    // 2. LOGIKA KEGIATAN 3: DIAGRAM PANAH (2 Canvas)
    // =========================================================

    // Fungsi helper untuk menggambar kepala panah
    function drawArrowhead(ctx, x1, y1, x2, y2) {
        const angle = Math.atan2(y2 - y1, x2 - x1);
        const size = 10;
        ctx.beginPath();
        ctx.moveTo(x2, y2);
        ctx.lineTo(x2 - size * Math.cos(angle - Math.PI / 6), y2 - size * Math.sin(angle - Math.PI / 6));
        ctx.lineTo(x2 - size * Math.cos(angle + Math.PI / 6), y2 - size * Math.sin(angle + Math.PI / 6));
        ctx.closePath();
        ctx.fill();
    }

    // Setup untuk Canvas 1
    const drawCanvas1 = document.getElementById('drawCanvas1');
    if (drawCanvas1) {
        const dctx1 = drawCanvas1.getContext('2d');
        const drawBtn1 = document.getElementById('drawBtn1');
        const eraseBtn1 = document.getElementById('eraseBtn1');
        const undoBtn1 = document.getElementById('undoBtn1');
        const saveImgBtn1 = document.getElementById('saveImgBtn1');

      let drawMode1 = 'draw', isDrawing1 = false;
      let strokes1 = [];
      let rightHits1 = new Set(); // id elemen kanan yang terkena ujung panah

      function rightTargets1(){
        return ['cm1_1','cm2_1','cm3_1','cm4_1']
          .map(id=>document.getElementById(id))
          .filter(Boolean);
      }
      function detectTargetHit1(absX, absY){
        const margin = 12; // toleransi agar mudah terdeteksi
        for(const el of rightTargets1()){
          const r = el.getBoundingClientRect();
          if(absX >= r.left - margin && absX <= r.right + margin && absY >= r.top - margin && absY <= r.bottom + margin){
            return el.id;
          }
        }
        return null;
      }
      function recomputeRightHits1(){
        rightHits1 = new Set();
        const r = drawCanvas1.getBoundingClientRect();
        strokes1.forEach(s=>{
          if(!s.length) return;
          const last = s[s.length-1];
          const absX = r.left + last.x;
          const absY = r.top + last.y;
          const hit = detectTargetHit1(absX, absY);
          if(hit) rightHits1.add(hit);
        });
      }

        function resizeDraw1() {
            drawCanvas1.width = 400; 
            drawCanvas1.height = 300;
            drawCanvas1.style.width = '400px'; 
            drawCanvas1.style.height = '300px'; 
            redrawDraw1();
        }
        window.addEventListener('resize', resizeDraw1);
        resizeDraw1(); 

        function redrawDraw1() {
            dctx1.clearRect(0, 0, drawCanvas1.width, drawCanvas1.height);
            dctx1.strokeStyle = '#3e2723';
            dctx1.lineWidth = 4;
            dctx1.lineJoin = 'round';
            dctx1.lineCap = 'round';
            dctx1.fillStyle = '#3e2723'; 

            strokes1.forEach(s => {
                dctx1.beginPath();
                for (let i = 0; i < s.length - 1; i++) {
                    dctx1.moveTo(s[i].x, s[i].y);
                    dctx1.lineTo(s[i + 1].x, s[i + 1].y);
                }
                dctx1.stroke();

                if (s.length > 1) {
                    const last = s[s.length - 1];
                    const secondLast = s[s.length - 2] || s[s.length-1]; 
                    drawArrowhead(dctx1, secondLast.x, secondLast.y, last.x, last.y);
                }
            });
        }
        
        drawBtn1.addEventListener('click', () => { 
            drawMode1 = 'draw';
            drawBtn1.classList.add('active');
            eraseBtn1.classList.remove('active');
        });
        eraseBtn1.addEventListener('click', () => { 
          strokes1 = []; rightHits1 = new Set();
          redrawDraw1(); 
            drawBtn1.classList.remove('active');
            eraseBtn1.classList.add('active');
        });
        undoBtn1.addEventListener('click', () => { 
          strokes1.pop(); 
          recomputeRightHits1();
          redrawDraw1(); 
        });
        saveImgBtn1.addEventListener('click', () => { 
            const imgData = drawCanvas1.toDataURL();
            // Simpan ke localStorage untuk gallery display
            localStorage.setItem('canvasImage_drawCanvas1', imgData);
            // Download file
            const link = document.createElement('a'); 
            link.download = 'diagram_panah_makanan.png'; 
            link.href = imgData; 
            link.click();
            alert('‚úÖ Gambar tersimpan! Bisa ditampilkan di Gallery Walk.');
        });

        drawCanvas1.addEventListener('pointerdown', (e) => {
            if (drawMode1 !== 'draw') return;
            isDrawing1 = true;
            const r = drawCanvas1.getBoundingClientRect();
            strokes1.push([{ x: e.clientX - r.left, y: e.clientY - r.top }]);
        });
        drawCanvas1.addEventListener('pointermove', (e) => {
            if (!isDrawing1) return;
            const r = drawCanvas1.getBoundingClientRect();
            const p = strokes1[strokes1.length - 1];
            p.push({ x: e.clientX - r.left, y: e.clientY - r.top });
            redrawDraw1();
        });
        drawCanvas1.addEventListener('pointerup', () => {
          if (isDrawing1) {
            isDrawing1 = false;
            // Daftarkan hit target kanan berdasarkan ujung panah terakhir
            const r = drawCanvas1.getBoundingClientRect();
            const lastStroke = strokes1[strokes1.length-1] || [];
            if(lastStroke.length){
              const last = lastStroke[lastStroke.length-1];
              const absX = r.left + last.x;
              const absY = r.top + last.y;
              const hit = detectTargetHit1(absX, absY);
              if(hit) rightHits1.add(hit);
            }
            completion.k3 = 1;
            updateProgress();
          }
        });
        drawCanvas1.addEventListener('pointerleave', () => {
            if (isDrawing1) {
                isDrawing1 = false;
            }
        });
        
        drawBtn1.click(); // Set default mode

        // Cek Otomatis & Jawaban Pertanyaan (Relasi 1)
        const btnCekOtomatis1 = document.getElementById('cekOtomatis1');
        const btnCekJawaban1 = document.getElementById('cekJawaban1');
        const inputJawaban1 = document.getElementById('jawabanTidakTerhubung1');
        const fbJawaban1 = document.getElementById('feedbackJawaban1');

        function getKodomainTexts1(){
          return rightTargets1()
            .map(el=>el.textContent.trim())
            .filter(t=>t.length>0);
        }
        function getRangeTexts1(){
          const ids = Array.from(rightHits1);
          const texts = ids.map(id=>{
            const el = document.getElementById(id);
            return (el?.textContent||'').trim();
          }).filter(t=>t.length>0);
          return Array.from(new Set(texts));
        }
        function computeNotHit1(){
          const kd = getKodomainTexts1();
          const rg = new Set(getRangeTexts1());
          return kd.filter(x=>!rg.has(x));
        }

        btnCekOtomatis1?.addEventListener('click', ()=>{
          const notHit = computeNotHit1();
          if(notHit.length === 0){
            fbJawaban1.style.color = '#6b4b3a';
            fbJawaban1.textContent = 'Belum ada panah yang terdeteksi di sisi kanan atau semua menu sudah terpukul. Coba gambar panah lalu cek lagi.';
          } else if (notHit.length === 1){
            inputJawaban1.value = notHit[0];
            fbJawaban1.style.color = '#2e7d32';
            fbJawaban1.textContent = `Bagus! Anggota Himpunan B yang tidak mendapat panah: ${notHit[0]}. Itulah perbedaan Kodomain dan Range.`;
          } else {
            fbJawaban1.style.color = '#6b4b3a';
            fbJawaban1.textContent = `Lebih dari satu item belum mendapat panah: ${notHit.join(', ')}. Ingat, skenario papan memuat Donat & Sosis saja yang dipesan.`;
          }
        });

        btnCekJawaban1?.addEventListener('click', ()=>{
          const ans = (inputJawaban1?.value||'').trim().toLowerCase();
          const notHit = computeNotHit1().map(x=>x.toLowerCase());
          if(!ans){
            fbJawaban1.style.color = '#c62828';
            fbJawaban1.textContent = 'Tulis jawaban terlebih dahulu.';
            return;
          }
          if(notHit.includes(ans)){
            fbJawaban1.style.color = '#2e7d32';
            fbJawaban1.textContent = '‚úî Benar! Itulah anggota Kodomain yang tidak termasuk Range.';
          } else {
            fbJawaban1.style.color = '#c62828';
            fbJawaban1.textContent = '‚úò Coba lagi. Perhatikan panah yang kamu gambar dan bandingkan dengan Papan Pesanan.';
          }
        });
    }

    // Setup untuk Canvas 2
    const drawCanvas2 = document.getElementById('drawCanvas2');
    if (drawCanvas2) {
        const dctx2 = drawCanvas2.getContext('2d');
        const drawBtn2 = document.getElementById('drawBtn2');
        const eraseBtn2 = document.getElementById('eraseBtn2');
        const undoBtn2 = document.getElementById('undoBtn2');
        const saveImgBtn2 = document.getElementById('saveImgBtn2');

        let drawMode2 = 'draw', isDrawing2 = false;
        let strokes2 = [];

        function resizeDraw2() {
            drawCanvas2.width = 400; 
            drawCanvas2.height = 300;
            drawCanvas2.style.width = '400px'; 
            drawCanvas2.style.height = '300px'; 
            redrawDraw2();
        }
        window.addEventListener('resize', resizeDraw2);
        resizeDraw2(); 

        function redrawDraw2() {
            dctx2.clearRect(0, 0, drawCanvas2.width, drawCanvas2.height);
            dctx2.strokeStyle = '#3e2723';
            dctx2.lineWidth = 4;
            dctx2.lineJoin = 'round';
            dctx2.lineCap = 'round';
            dctx2.fillStyle = '#3e2723'; 

            strokes2.forEach(s => {
                dctx2.beginPath();
                for (let i = 0; i < s.length - 1; i++) {
                    dctx2.moveTo(s[i].x, s[i].y);
                    dctx2.lineTo(s[i + 1].x, s[i + 1].y);
                }
                dctx2.stroke();

                if (s.length > 1) {
                    const last = s[s.length - 1];
                    const secondLast = s[s.length - 2] || s[s.length-1]; 
                    drawArrowhead(dctx2, secondLast.x, secondLast.y, last.x, last.y);
                }
            });
        }

        drawBtn2.addEventListener('click', () => { 
            drawMode2 = 'draw';
            drawBtn2.classList.add('active');
            eraseBtn2.classList.remove('active');
        });
        eraseBtn2.addEventListener('click', () => { 
            strokes2 = []; 
            redrawDraw2(); 
            drawBtn2.classList.remove('active');
            eraseBtn2.classList.add('active');
        });
        undoBtn2.addEventListener('click', () => { 
            strokes2.pop(); 
            redrawDraw2(); 
        });
        saveImgBtn2.addEventListener('click', () => { 
            const imgData = drawCanvas2.toDataURL();
            // Simpan ke localStorage untuk gallery display
            localStorage.setItem('canvasImage_drawCanvas2', imgData);
            // Download file
            const link = document.createElement('a'); 
            link.download = 'diagram_panah_minuman.png'; 
            link.href = imgData; 
            link.click();
            alert('‚úÖ Gambar tersimpan! Bisa ditampilkan di Gallery Walk.');
        });

        drawCanvas2.addEventListener('pointerdown', (e) => {
            if (drawMode2 !== 'draw') return;
            isDrawing2 = true;
            const r = drawCanvas2.getBoundingClientRect();
            strokes2.push([{ x: e.clientX - r.left, y: e.clientY - r.top }]);
        });
        drawCanvas2.addEventListener('pointermove', (e) => {
            if (!isDrawing2) return;
            const r = drawCanvas2.getBoundingClientRect();
            const p = strokes2[strokes2.length - 1];
            p.push({ x: e.clientX - r.left, y: e.clientY - r.top });
            redrawDraw2();
        });
        drawCanvas2.addEventListener('pointerup', () => {
            if (isDrawing2) {
                isDrawing2 = false;
                completion.k3 = 1;
                updateProgress();
            }
        });
        drawCanvas2.addEventListener('pointerleave', () => {
            if (isDrawing2) {
                isDrawing2 = false;
            }
        });
        
        drawBtn2.click(); // Set default mode
    }
    
    // =========================================================
    // 3. LOGIKA KEGIATAN 4: KARTESIUS
    // =========================================================
    
    const planeIds = ['plane1', 'plane2'];
    const planes = planeIds.map(id => document.getElementById(id));
    const pctx = planes.map(p => p?.getContext('2d')).filter(ctx => ctx);
    const planeState = [
      { points: [], paths: [], domainItems: [], kodomainItems: [] }, 
      { points: [], paths: [], domainItems: [], kodomainItems: [] }
    ];
    let planeMode = 'point';
    let emojiState = '';

    function drawGrid(ctx, w, h, idx) {
      ctx.clearRect(0, 0, w, h); ctx.fillStyle = '#fff'; ctx.fillRect(0, 0, w, h); 
      ctx.strokeStyle = 'rgba(0,0,0,0.06)'; ctx.lineWidth = 1; const step = 20; 
      for (let x = 0; x <= w; x += step) { ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, h); ctx.stroke(); } 
      for (let y = 0; y <= h; y += step) { ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(w, y); ctx.stroke(); } 
      ctx.strokeStyle = '#111'; ctx.lineWidth = 2; 
      const originX = 60, originY = h - 40;
      const axisLen = Math.min(w - originX - 40, originY - 20); // samakan panjang sumbu X dan Y
      const endX = originX + axisLen;
      const endY = originY - axisLen;

      ctx.beginPath(); ctx.moveTo(originX, originY); ctx.lineTo(endX, originY); ctx.stroke(); 
      ctx.beginPath(); ctx.moveTo(originX, originY); ctx.lineTo(originX, endY); ctx.stroke(); 
      ctx.fillStyle = '#111'; 
      ctx.beginPath(); ctx.moveTo(endX, originY); ctx.lineTo(endX - 10, originY - 6); ctx.lineTo(endX - 10, originY + 6); ctx.closePath(); ctx.fill(); 
      ctx.beginPath(); ctx.moveTo(originX, endY); ctx.lineTo(originX - 6, endY + 10); ctx.lineTo(originX + 6, endY + 10); ctx.closePath(); ctx.fill(); 
        
      ctx.font = '13px Poppins'; ctx.fillStyle = '#3e2723';
      const state = planeState[idx];
      if(state.domainItems && state.domainItems.length > 0){
        const spacing = axisLen / (state.domainItems.length + 1);
        state.domainItems.forEach((item, i) => {
          const x = originX + spacing * (i + 1);
          ctx.fillText(item, x - 15, originY + 20);
          ctx.beginPath(); ctx.moveTo(x, originY - 3); ctx.lineTo(x, originY + 3); ctx.stroke();
        });
      }
      if(state.kodomainItems && state.kodomainItems.length > 0){
        const spacing = axisLen / (state.kodomainItems.length + 1);
        state.kodomainItems.forEach((item, i) => {
          const y = originY - spacing * (i + 1);
          ctx.fillText(item, originX + 8, y + 4);
          ctx.beginPath(); ctx.moveTo(originX - 3, y); ctx.lineTo(originX + 3, y); ctx.stroke();
        });
      }
    }

    function redrawPlane(idx) {
        const pl = planes[idx], ctx = pctx[idx]; drawGrid(ctx, pl.width, pl.height, idx); 
        ctx.strokeStyle = '#3e2723'; ctx.lineWidth = 3; ctx.lineJoin = 'round'; ctx.lineCap = 'round'; 
        planeState[idx].paths.forEach(path => { 
            ctx.beginPath(); path.forEach((p, i) => i ? ctx.lineTo(p.x, p.y) : ctx.moveTo(p.x, p.y)); ctx.stroke(); 
        }); 
        planeState[idx].points.forEach(pt => { 
            ctx.beginPath(); ctx.fillStyle = '#ffeb3b'; 
            ctx.ellipse(pt.x, pt.y, 8, 8, 0, 0, Math.PI * 2); ctx.fill(); 
            ctx.strokeStyle = '#3e2723'; ctx.stroke(); 
            ctx.font = '14px Poppins'; ctx.fillStyle = '#3e2723'; 
            ctx.fillText(pt.name, pt.x + 12, pt.y + 4); 
        }); 
    }

    planes.forEach((pl, idx) => {
        if (!pl) return;
        drawGrid(pctx[idx], pl.width, pl.height, idx);
        let drawing = false;
        pl.addEventListener('pointerdown', e => {
            const r = pl.getBoundingClientRect();
            const x = e.clientX - r.left, y = e.clientY - r.top;
            if (planeMode === 'point') {
                const name = prompt('Masukkan nama titik:');
                if (name) {
                    planeState[idx].points.push({ x, y, name });
                    redrawPlane(idx);
                    completion.k4 = 1;
                    updateProgress();
                }
            } else {
                drawing = true;
                planeState[idx].paths.push([{ x, y }]);
            }
        });
        pl.addEventListener('pointermove', e => {
            if (planeMode === 'draw' && drawing) {
                const r = pl.getBoundingClientRect();
                const x = e.clientX - r.left, y = e.clientY - r.top;
                const path = planeState[idx].paths[planeState[idx].paths.length - 1];
                path.push({ x, y });
                redrawPlane(idx);
            }
        });
        pl.addEventListener('pointerup', e => {
            if (drawing) {
                drawing = false;
                if (planeState[idx].paths.length > 0 && planeState[idx].paths[planeState[idx].paths.length-1].length > 1) {
                     completion.k4 = 1;
                } else if (planeState[idx].points.length > 0) {
                     completion.k4 = 1;
                } else {
                     completion.k4 = 0;
                }
                updateProgress();
            }
        });
    });

    // Event handlers untuk input Domain dan Kodomain
    document.getElementById('applyDomain1')?.addEventListener('click', () => {
        const input = document.getElementById('domain1_input').value.trim();
        if(input) {
            planeState[0].domainItems = input.split(',').map(s => s.trim()).filter(s => s);
            redrawPlane(0);
        }
    });
    document.getElementById('applyKodomain1')?.addEventListener('click', () => {
        const input = document.getElementById('kodomain1_input').value.trim();
        if(input) {
            planeState[0].kodomainItems = input.split(',').map(s => s.trim()).filter(s => s);
            redrawPlane(0);
        }
    });
    document.getElementById('applyDomain2')?.addEventListener('click', () => {
        const input = document.getElementById('domain2_input').value.trim();
        if(input) {
            planeState[1].domainItems = input.split(',').map(s => s.trim()).filter(s => s);
            redrawPlane(1);
        }
    });
    document.getElementById('applyKodomain2')?.addEventListener('click', () => {
        const input = document.getElementById('kodomain2_input').value.trim();
        if(input) {
            planeState[1].kodomainItems = input.split(',').map(s => s.trim()).filter(s => s);
            redrawPlane(1);
        }
    });

    // Evaluasi & Refleksi handlers
    const relasiDefGroup = document.getElementById('relasiDefinisiGroup');
    const feedbackRelasiDef = document.getElementById('feedbackRelasiDef');
    relasiDefGroup?.addEventListener('click', (e)=>{
        const pill = e.target.closest('.pill');
        if(!pill) return;
        relasiDefGroup.querySelectorAll('.pill').forEach(p=>p.classList.remove('active'));
        pill.classList.add('active');
        const val = pill.dataset.value;
        if(val === 'aturan'){
            feedbackRelasiDef.style.color = '#2e7d32';
            feedbackRelasiDef.textContent = 'Benar: relasi adalah aturan pemasangan antar dua himpunan.';
        } else {
            feedbackRelasiDef.style.color = '#c62828';
            feedbackRelasiDef.textContent = 'Coba lagi: relasi adalah aturan pemasangan, bukan sekadar himpunan atau garis acak.';
        }
    });

    const feedbackDKR = document.getElementById('feedbackDKR');
    function cekDKR(){
        const d = document.getElementById('selDomain')?.value;
        const k = document.getElementById('selKodomain')?.value;
        const r = document.getElementById('selRange')?.value;
        if(!d || !k || !r){
            feedbackDKR.style.color = '#6b4b3a';
            feedbackDKR.textContent = 'Lengkapi pilihan Domain, Kodomain, dan Range.';
            return false;
        }
        if(d==='awal' && k==='menu' && r==='laku'){
            feedbackDKR.style.color = '#2e7d32';
            feedbackDKR.textContent = 'Tepat! Range adalah bagian dari Kodomain yang benar-benar dipasangkan.';
            return true;
        } else {
            feedbackDKR.style.color = '#c62828';
            feedbackDKR.textContent = 'Periksa lagi: Domain = yang memilih, Kodomain = semua menu tersedia, Range = menu yang laku.';
            return false;
        }
    }

    document.getElementById('selDomain')?.addEventListener('change', cekDKR);
    document.getElementById('selKodomain')?.addEventListener('change', cekDKR);
    document.getElementById('selRange')?.addEventListener('change', cekDKR);

    const emojiRow = document.getElementById('emojiRow');
    emojiRow?.addEventListener('click', (e)=>{
        const btn = e.target.closest('.emoji-btn');
        if(!btn) return;
        emojiRow.querySelectorAll('.emoji-btn').forEach(b=>b.classList.remove('active'));
        btn.classList.add('active');
        emojiState = btn.dataset.emo || '';
    });

    document.getElementById('btnFinishEvaluasi')?.addEventListener('click', ()=>{
        const autoFeedback = document.getElementById('autoFeedback');
        const aha = document.getElementById('ahaInput')?.value.trim() || '';
        const defOK = feedbackRelasiDef?.textContent?.includes('Benar');
        const dkrOK = cekDKR();
        const checklistOK = ['chkPanah','chkPasangan','chkKartesius','chkTabel'].some(id=>document.getElementById(id)?.checked);
        const emojiOK = !!emojiState;

        if(defOK && dkrOK && checklistOK && emojiOK && aha.length>=5){
            autoFeedback.style.color = '#2e7d32';
            autoFeedback.textContent = 'Selamat! Kamu telah menyelesaikan misi penyelidikan relasi di Kantin Sekolah. Kamu hebat sudah menemukan konsep matematika ini secara mandiri!';
        } else {
            autoFeedback.style.color = '#c62828';
            autoFeedback.textContent = 'Lengkapi dulu: pilih definisi relasi yang benar, cocokan DKR, centang minimal satu cara, pilih emoji, dan isi Aha-Moment (‚â•5 karakter).';
        }
    });

    document.getElementById('pointTool')?.addEventListener('click', () => { 
        planeMode = 'point'; 
        document.getElementById('pointTool').classList.add('active'); 
        document.getElementById('drawTool').classList.remove('active'); 
    });
    document.getElementById('drawTool')?.addEventListener('click', () => { 
        planeMode = 'draw'; 
        document.getElementById('drawTool').classList.add('active'); 
        document.getElementById('pointTool').classList.remove('active'); 
    });
    document.getElementById('clearCanvas')?.addEventListener('click', () => { 
        planeState[0].points = []; planeState[0].paths = []; 
        planeState[1].points = []; planeState[1].paths = []; 
        redrawPlane(0); redrawPlane(1); 
        completion.k4 = 0; updateProgress(); 
    });
    document.getElementById('undoCanvas')?.addEventListener('click', () => { 
        for (let i = 1; i >= 0; i--) { 
            const s = planeState[i]; 
            if (s.paths.length) { s.paths.pop(); redrawPlane(i); break; } 
            else if (s.points.length) { s.points.pop(); redrawPlane(i); break; } 
        } 
        completion.k4 = (planeState[0].points.length > 0 || planeState[0].paths.length > 0 || planeState[1].points.length > 0 || planeState[1].paths.length > 0) ? 1 : 0;
        updateProgress();
    });
    document.getElementById('saveCanvas')?.addEventListener('click', () => { 
        planes.forEach((pl, i) => { 
            if(pl){ 
                const imgData = pl.toDataURL();
                // Simpan ke localStorage untuk gallery display
                const canvasId = i === 0 ? 'plane1' : 'plane2';
                localStorage.setItem('canvasImage_' + canvasId, imgData);
                // Download file
                const link = document.createElement('a'); 
                link.download = 'plane_' + (i + 1) + '.png'; 
                link.href = imgData; 
                link.click(); 
            } 
        }); 
        alert('‚úÖ Gambar tersimpan! Bisa ditampilkan di Gallery Walk.');
    });
    
    // Set default K4 mode
    document.getElementById('pointTool')?.click(); 


    // =========================================================
    // 4. LOGIKA PDF GENERATION & KIRIM KE GURU
    // =========================================================

    const { jsPDF } = window.jspdf;
    
    // Fungsi untuk generate PDF
    async function generatePDFLaporan() {
        const pdf = new jsPDF({ orientation: 'portrait', unit: 'px', format: [1100, 1400] });
        
        // Slides yang akan di-capture (sesuaikan dengan flow baru)
        const slidesToCapture = [
            'identitas-kelompok',
            'permasalahan',
            'k1',
            'k2',
            'pilih-kegiatan',
            // Tambahkan slide kegiatan yang dipilih user
            localStorage.getItem('selectedActivity') || 'k3',
            'preview-activities',
            'penyajian-relasi',
            'evaluasi'
        ];
        
        const activeSlideId = document.querySelector('.slide.active')?.id || 'start';

        for (let i = 0; i < slidesToCapture.length; i++) {
            const id = slidesToCapture[i];
            const el = document.getElementById(id);
            if (!el) continue;

            // Set slide active
            document.querySelectorAll('.slide').forEach(s => s.classList.remove('active'));
            el.classList.add('active');
            
            await new Promise(r => setTimeout(r, 150)); 

            // Redraw canvas if needed
            if (id === 'k3') {
                if (typeof redrawDraw1 === 'function') redrawDraw1();
                if (typeof redrawDraw2 === 'function') redrawDraw2();
            }
            if (id === 'k4' && typeof redrawPlane === 'function') {
                redrawPlane(0);
                redrawPlane(1);
            }

            // Capture slide
            try {
                const canvas = await html2canvas(el, { 
                  scale: 1.2, 
                  useCORS: true, 
                  allowTaint: true, 
                  logging: false,
                    backgroundColor: null
                });
                const img = canvas.toDataURL('image/png');
                const pageW = pdf.internal.pageSize.getWidth();
                const imgW = pageW;
                const imgH = canvas.height * (imgW / canvas.width);
                
                if (i > 0) pdf.addPage();
                pdf.addImage(img, 'PNG', 0, 0, imgW, imgH);
            } catch(e) {
                console.error('Error capturing slide:', id, e);
            }
        }
        
        // Kembali ke slide aktif
        show(activeSlideId);
        
        return pdf;
    }
    
    // Fungsi show modal Google Form
    window.showMetodePengiriman = async function() {
        try {
            // Generate PDF
            const pdf = await generatePDFLaporan();
            
            // Save PDF
            const kelompokData = JSON.parse(localStorage.getItem('kelompokData') || '{}');
            const namaKelompok = kelompokData.nama || 'Kelompok';
            const fileName = `LKPD_Relasi_${namaKelompok.replace(/\s+/g, '_')}.pdf`;
            
            pdf.save(fileName);
            
            // Show modal
            const modal = document.getElementById('gformModal');
            if (modal) {
                modal.style.display = 'block';
                
                // Set Google Form link (ganti dengan link Form guru)
                const gformLink = document.getElementById('gformLink');
                if (gformLink) {
                    // TODO: Ganti dengan link Google Form yang sebenarnya
                    gformLink.href = 'https://forms.gle/ZSJ28D5hA49ff6Jq5';
                }
            }
        } catch(error) {
            console.error('Error generating PDF:', error);
            alert('‚ùå Gagal membuat PDF. Pastikan semua kegiatan sudah dikerjakan.');
        }
    }
    
    // Fungsi close modal
    window.closeGFormModal = function() {
        const modal = document.getElementById('gformModal');
        if (modal) {
            modal.style.display = 'none';
        }
    }
    
    // Event listener untuk tombol Kirim Hasil
    document.getElementById('btnKirimHasilGuru')?.addEventListener('click', showMetodePengiriman);
    
    // Legacy support - jika masih ada button dengan id downloadPdf
    document.getElementById('downloadPdf')?.addEventListener('click', async () => {
        try {
            const pdf = await generatePDFLaporan();
            pdf.save('Hasil_LKPD_Relasi_Fungsi.pdf');
        } catch(error) {
            console.error('Error:', error);
            alert('‚ùå Gagal membuat PDF');
        }
    });

    updateProgress();

    // --- LOGIKA INPUT IDENTITAS KELOMPOK (SISTEM INPUT/PREVIEW) ---
    
    // Deskripsi peran lengkap
    const deskripsiPeranMap = {
      'Ketua Kelompok': 'Memimpin diskusi, mengatur waktu, memastikan semua anggota ikut berkontribusi, dan membuat keputusan akhir.',
      'Wakil Ketua': 'Siap membantu ketua, menyiapkan materi, memotivasi anggota lain, dan menggantikan ketua jika diperlukan.',
      'Sekretaris': 'Mencatat hasil diskusi, menulis kesimpulan, mendokumentasikan proses, dan mengelola berkas kelompok.',
      'Anggota Aktif': 'Aktif memberikan ide, melakukan tugas teknis, mengerjakan soal, dan memberikan kontribusi nyata.',
      'Anggota': 'Turut serta dalam diskusi dan mengerjakan tugas kelompok sesuai arahan dari pemimpin.'
    };

    // Load data anggota dari localStorage saat page load
    function loadDataAnggota() {
      const saved = localStorage.getItem('daftarAnggotaTerdaftar');
      if (saved) {
        try {
          return JSON.parse(saved);
        } catch (e) {
          return [];
        }
      }
      return [];
    }

    // Save data anggota ke localStorage
    function saveDataAnggota(anggotaList) {
      localStorage.setItem('daftarAnggotaTerdaftar', JSON.stringify(anggotaList));
    }

    // Render preview anggota
    function renderPreviewAnggota() {
      const anggotaList = loadDataAnggota();
      const previewContainer = document.getElementById('previewAnggota');
      
      if (!previewContainer) return;

      if (anggotaList.length === 0) {
        previewContainer.innerHTML = `
          <div style="color:var(--muted);font-size:14px;text-align:center;padding:20px">
            üìù Belum ada anggota yang di-input. Isi form di bawah untuk mulai.
          </div>
        `;
        return;
      }

      previewContainer.innerHTML = anggotaList.map((anggota, idx) => `
        <div style="padding:14px;background:white;border-radius:8px;border-left:4px solid #8b5cf6;display:flex;justify-content:space-between;align-items:flex-start;gap:12px">
          <div style="flex:1">
            <div style="font-weight:700;color:var(--accent);font-size:15px;margin-bottom:6px">üë§ ${anggota.nama}</div>
            <div style="font-size:13px;color:var(--muted);margin-bottom:4px"><b>üìã Peran:</b> ${anggota.peran}</div>
            <div style="font-size:13px;color:#059669;line-height:1.5"><b>‚úÖ Tugas:</b> ${deskripsiPeranMap[anggota.peran] || anggota.peran}</div>
          </div>
          <button class="btn ghost" onclick="hapusAnggotaTerdaftar(${idx})" style="min-width:50px;padding:8px;color:#ef4444">‚úñ</button>
        </div>
      `).join('');
    }

    // Fungsi hapus anggota dari preview
    window.hapusAnggotaTerdaftar = function(idx) {
      const anggotaList = loadDataAnggota();
      anggotaList.splice(idx, 1);
      saveDataAnggota(anggotaList);
      renderPreviewAnggota();
    };

    // Event listener untuk input nama
    const inputNamaAnggota = document.getElementById('inputNamaAnggota');
    inputNamaAnggota?.addEventListener('focus', () => {
      // Clear preview description on focus to new input
    });

    // Event listener untuk select peran - tampilkan deskripsi
    const selectPenanggungJawab = document.getElementById('selectPenanggungJawab');
    selectPenanggungJawab?.addEventListener('change', () => {
      const peran = selectPenanggungJawab.value;
      const deskripsiDiv = document.getElementById('deskripsiPeran');
      const deskripsiTeks = document.getElementById('deskripsiTeks');
      
      if (peran && deskripsiPeranMap[peran]) {
        deskripsiDiv.style.display = 'block';
        deskripsiTeks.innerText = deskripsiPeranMap[peran];
      } else {
        deskripsiDiv.style.display = 'none';
      }
    });

    // Event listener untuk tombol INPUT
    const btnInputAnggota = document.getElementById('btnInputAnggota');
    btnInputAnggota?.addEventListener('click', () => {
      const nama = inputNamaAnggota?.value.trim() || '';
      const peran = selectPenanggungJawab?.value || '';

      if (!nama) {
        alert('‚ö†Ô∏è Mohon isi nama anggota terlebih dahulu.');
        return;
      }

      if (!peran) {
        alert('‚ö†Ô∏è Mohon pilih peran/tanggung jawab.');
        return;
      }

      // Cek duplikasi nama
      const anggotaList = loadDataAnggota();
      if (anggotaList.some(a => a.nama.toLowerCase() === nama.toLowerCase())) {
        alert('‚ö†Ô∏è Nama anggota sudah terdaftar. Gunakan nama lain.');
        return;
      }

      // Cek maksimal 5 anggota
      if (anggotaList.length >= 5) {
        alert('‚ö†Ô∏è Maksimal 5 anggota per kelompok.');
        return;
      }

      // Tambah anggota ke list
      anggotaList.push({ nama, peran });
      saveDataAnggota(anggotaList);

      // Reset form
      inputNamaAnggota.value = '';
      selectPenanggungJawab.value = '';
      document.getElementById('deskripsiPeran').style.display = 'none';
      inputNamaAnggota.focus();

      // Re-render preview
      renderPreviewAnggota();
    });

    // Render preview saat page load
    renderPreviewAnggota();

    // Simpan kelompok
    document.getElementById('lanjutTahap1Btn')?.addEventListener('click', () => {
      const namaKelompok = document.getElementById('namaKelompok')?.value.trim();
      const anggota = loadDataAnggota();

      if (!namaKelompok) {
        alert('‚ö†Ô∏è Mohon isi nama kelompok terlebih dahulu.');
        return;
      }

      if (anggota.length === 0) {
        alert('‚ö†Ô∏è Mohon isi minimal 1 nama anggota.');
        return;
      }

      const kelompokData = { nama: namaKelompok, anggota: anggota };
      localStorage.setItem('kelompokData', JSON.stringify(kelompokData));

      // Simpan solusi awal jika ada
      const solusiAwal = document.getElementById('solusiAwalPertemuan2')?.value.trim();
      if (solusiAwal) {
        localStorage.setItem('solusiAwalPertemuan2', solusiAwal);
      }

      const feedback = document.getElementById('feedbackKelompok');
      if (feedback) {
        feedback.textContent = `‚úì Kelompok "${namaKelompok}" berhasil disimpan dengan ${anggota.length} anggota!`;
        feedback.style.display = 'block';
      }

      alert(`Data kelompok berhasil disimpan!\n\nKelompok: ${namaKelompok}\nJumlah Anggota: ${anggota.length}\n\nSiap melanjutkan ke tahap berikutnya!`);
      show('permasalahan');
    });

    // --- LEGACY CODE (dihapus karena sudah diganti dengan sistem input/preview) ---

    // === Fase 3: Penyelidikan Nilai & Bentuk Fungsi (Tarif Delivery) ===
    const dataTarif = [
      { km: 2, biaya: 15000 },
      { km: 4, biaya: 19000 },
      { km: 7, biaya: 26000 },
      { km: 10, biaya: 33000 }
    ];

    const mSlider = document.getElementById('mSlider');
    const bSlider = document.getElementById('bSlider');
    const mValue = document.getElementById('mValue');
    const bValue = document.getElementById('bValue');
    const modelLabel = document.getElementById('modelLabel');
    const btnDuaTitik = document.getElementById('btnDuaTitik');
    const tableBody = document.getElementById('tarifTableBody');
    const totalErrorEl = document.getElementById('totalError');
    const inputF6 = document.getElementById('inputF6');
    const inputF12 = document.getElementById('inputF12');
    const feedbackTarif = document.getElementById('feedbackTarif');
    const refleksiTarif = document.getElementById('refleksiTarif');
    const readinessInfo = document.getElementById('readinessInfo');
    const btnNextFase4 = document.getElementById('btnNextFase4');

    let currentTotalErr = 0;

    function formatRupiah(n){
      if (isNaN(n)) return '-';
      return n.toLocaleString('id-ID');
    }

    function hitungPrediksi(km, m, b){
      return m * km + b;
    }

    function updateTarifView(){
      const m = parseInt(mSlider?.value || '0', 10);
      const b = parseInt(bSlider?.value || '0', 10);
      if (mValue) mValue.textContent = `m = ${formatRupiah(m)} per km`;
      if (bValue) bValue.textContent = `b = ${formatRupiah(b)} (biaya tetap)`;
      if (modelLabel) modelLabel.textContent = `Model: f(x) = ${formatRupiah(m)}¬∑x + ${formatRupiah(b)} (m: per km, b: tetap)`;

      if (!tableBody) return;
      let html = '';
      let totalErr = 0;
      dataTarif.forEach(row => {
        const pred = hitungPrediksi(row.km, m, b);
        const err = pred - row.biaya;
        totalErr += Math.abs(err);
        html += `
          <tr>
            <td style="padding:8px;border:1px solid #ffd199">${row.km} km</td>
            <td style="padding:8px;border:1px solid #ffd199">${formatRupiah(row.biaya)}</td>
            <td style="padding:8px;border:1px solid #ffd199">${formatRupiah(pred)}</td>
            <td style="padding:8px;border:1px solid #ffd199;color:${Math.abs(err)<=500?'#2e7d32':'#c62828'}">${err>0?'+':''}${formatRupiah(err)}</td>
          </tr>
        `;
      });
      tableBody.innerHTML = html;
      currentTotalErr = totalErr;
      if (totalErrorEl) totalErrorEl.textContent = formatRupiah(totalErr);
      checkReadiness();
    }

    mSlider?.addEventListener('input', updateTarifView);
    bSlider?.addEventListener('input', updateTarifView);
    updateTarifView();

    document.getElementById('btnCekTarif')?.addEventListener('click', () => {
      const m = parseInt(mSlider?.value || '0', 10);
      const b = parseInt(bSlider?.value || '0', 10);
      const f6User = parseInt(inputF6?.value || '0', 10);
      const f12User = parseInt(inputF12?.value || '0', 10);
      const f6True = hitungPrediksi(6, m, b);
      const f12True = hitungPrediksi(12, m, b);

      const tol = 500; // toleransi pembulatan
      const ok6 = Math.abs(f6User - f6True) <= tol;
      const ok12 = Math.abs(f12User - f12True) <= tol;

      if (!inputF6?.value || !inputF12?.value) {
        if (feedbackTarif) {
          feedbackTarif.textContent = 'Isi kedua nilai f(6) dan f(12) dulu.';
          feedbackTarif.style.color = '#c62828';
        }
        return;
      }

      if (ok6 && ok12) {
        if (feedbackTarif) {
          feedbackTarif.textContent = '‚úÖ Tepat! Nilai fungsi sesuai model yang kamu tetapkan.';
          feedbackTarif.style.color = '#2e7d32';
        }
      } else {
        const miss = [];
        if (!ok6) miss.push('f(6)');
        if (!ok12) miss.push('f(12)');
        if (feedbackTarif) {
          feedbackTarif.textContent = `‚ùå Cek lagi ${miss.join(' dan ')}. (Toleransi ¬±${tol})`;
          feedbackTarif.style.color = '#c62828';
        }
      }
      checkReadiness();
    });

    function checkReadiness(){
      if (!btnNextFase4 || !readinessInfo) return;
      const m = parseInt(mSlider?.value || '0', 10);
      const b = parseInt(bSlider?.value || '0', 10);
      const okMB = (m > 0 && b >= 0);
      const okErr = (currentTotalErr <= 2500 && currentTotalErr > 0);
      const f6User = parseInt(inputF6?.value || 'NaN', 10);
      const f12User = parseInt(inputF12?.value || 'NaN', 10);
      const f6True = hitungPrediksi(6, m, b);
      const f12True = hitungPrediksi(12, m, b);
      const tol = 500;
      const okF = (!isNaN(f6User) && !isNaN(f12User) && Math.abs(f6User - f6True) <= tol && Math.abs(f12User - f12True) <= tol);
      const okRef = (refleksiTarif?.value.trim().length >= 10);

      const li = [
        `${okMB ? '‚úî' : '‚úò'} m > 0 dan b ‚â• 0`,
        `${okErr ? '‚úî' : '‚úò'} Total error ‚â§ 2.500 (sekarang: ${formatRupiah(currentTotalErr)})`,
        `${okF ? '‚úî' : '‚úò'} f(6) dan f(12) sesuai model (¬±${tol})`,
        `${okRef ? '‚úî' : '‚úò'} Refleksi singkat (‚â• 10 karakter)`
      ];
      readinessInfo.innerHTML = li.map(x=>`<li>${x}</li>`).join('');
      const allOk = okMB && okErr && okF && okRef;
      btnNextFase4.disabled = !allOk;
    }

    inputF6?.addEventListener('input', checkReadiness);
    inputF12?.addEventListener('input', checkReadiness);
    refleksiTarif?.addEventListener('input', checkReadiness);

    btnDuaTitik?.addEventListener('click', () => {
      // Gunakan dua titik data: (2,15000) dan (7,26000)
      const x1 = 2, y1 = 15000;
      const x2 = 7, y2 = 26000;
      let m = (y2 - y1) / (x2 - x1); // 2200
      let b = y1 - m * x1;           // 10600
      // Sesuaikan ke langkah slider
      const mStep = 50, bStep = 500;
      m = Math.round(m / mStep) * mStep;
      b = Math.round(b / bStep) * bStep;
      if (mSlider) mSlider.value = String(Math.max(0, Math.min(4000, m)));
      if (bSlider) bSlider.value = String(Math.max(0, Math.min(20000, b)));
      updateTarifView();
    });

    const determineCategoryFromName = (name, fallback) => {
      const n = (name || '').toLowerCase();
      if(n.includes('siswa') || n.includes('teman')) return 'siswa';
      if(n.includes('jajan') || n.includes('makan')) return 'jajanan';
      if(n.includes('minum') || n.includes('drink')) return 'minuman';
      return fallback; // tetap gunakan jenis default jika tidak dikenali
    };

    const setNameBindings = [
      { inputId: 'inputSetA', labelId: 'setNameA', fallback: 'Nama Siswa', zoneId: 'hA' },
      { inputId: 'inputSetB', labelId: 'setNameB', fallback: 'Jajanan', zoneId: 'hB' },
      { inputId: 'inputSetC', labelId: 'setNameC', fallback: 'Minuman', zoneId: 'hC' }
    ];

    const labelTargets = [
      { id: 'domainHintName', source: 'inputSetA', fallback: 'Nama Siswa' },
      { id: 'kodomainHintName', source: 'inputSetB', fallback: 'Semua Menu' },
      { id: 'domainAxis1', source: 'inputSetA', fallback: 'Nama Siswa' },
      { id: 'kodomainAxis1', source: 'inputSetB', fallback: 'Menu Makanan' },
      { id: 'domainAxis2', source: 'inputSetA', fallback: 'Nama Siswa' },
      { id: 'kodomainAxis2', source: 'inputSetC', fallback: 'Menu Minuman' },
      // K2 set titles
      { id: 'k2SetNameA', source: 'inputSetA', fallback: 'Himpunan A' },
      { id: 'k2SetNameB', source: 'inputSetB', fallback: 'Himpunan B' },
      { id: 'k2SetNameC', source: 'inputSetC', fallback: 'Himpunan C' },
      // K3 Relasi 1 set titles
      { id: 'k3SetNameA1', source: 'inputSetA', fallback: 'Himpunan A' },
      { id: 'k3SetNameB1', source: 'inputSetB', fallback: 'Himpunan B' },
      // K3 Relasi 2 set titles
      { id: 'k3SetNameA2', source: 'inputSetA', fallback: 'Himpunan A' },
      { id: 'k3SetNameC2', source: 'inputSetC', fallback: 'Himpunan C' }
    ];

    const getSetName = (inputId, fallback) => {
      const el = document.getElementById(inputId);
      const val = el ? el.value.trim() : '';
      return val || fallback;
    };

    const refreshLabels = () => {
      labelTargets.forEach(({ id, source, fallback }) => {
        const t = document.getElementById(id);
        if(!t) return;
        t.textContent = getSetName(source, fallback);
      });
    };

    setNameBindings.forEach(({ inputId, labelId, fallback, zoneId }) => {
      const input = document.getElementById(inputId);
      const label = document.getElementById(labelId);
      const zone = document.getElementById(zoneId);
      if (!input || !label || !zone) return;
      const sync = () => {
        const val = input.value.trim();
        label.textContent = val || '';
        const resolved = determineCategoryFromName(val, zone.dataset.accept);
        zone.dataset.currentAccept = resolved;
        refreshLabels();
      };
      input.addEventListener('input', sync);
      sync();
    });

    // --- LOGIKA DRAG & DROP UNTUK TAHAP 1 ---
    const feedback = document.getElementById("feedback");
    const dropzones = document.querySelectorAll(".dropzone");
    const placed = new Set(); // simpan item yang sudah benar ditempatkan

    // Setup untuk Clue button
    document.getElementById("btnClueRelasi")?.addEventListener('click', () => {
      alert("Clue:\nKalian sudah membuat Himpunan A, B, dan C.\nSekarang kalian memerlukan ATURAN untuk menghubungkan dua himpunan.\nApa nama konsep matematikanya?");
    });

    document.querySelectorAll(".item").forEach(item=>{
      item.addEventListener("dragstart", e=>{
        e.dataTransfer.setData("value", item.dataset.value);
        e.dataTransfer.setData("type", item.dataset.type);
      });
    });

    dropzones.forEach(zone=>{
      zone.addEventListener("dragover", e=>{ e.preventDefault(); zone.classList.add("highlight"); });
      zone.addEventListener("dragleave", e=>zone.classList.remove("highlight"));

      zone.addEventListener("drop", e=>{
        e.preventDefault();
        zone.classList.remove("highlight");

        const val = e.dataTransfer.getData("value");
        const type = e.dataTransfer.getData("type");
        const accept = zone.dataset.currentAccept || zone.dataset.accept;

        // sudah ditempatkan sebelumnya? tolak
        if(placed.has(val)){
          feedback.textContent = "Item ini sudah ditempatkan.";
          feedback.style.color = "#6b4b3a";
          return;
        }

        // prevent duplicate
        if([...zone.children].some(c=>c.dataset && c.dataset.value === val)){
          feedback.textContent = "Duplikasi tidak diperbolehkan.";
          feedback.style.color = "#c62828";
          return;
        }

        // check correctness
        if(type !== accept){
          feedback.textContent = "Elemen salah himpunan!";
          feedback.style.color = "#c62828";
          zone.classList.add("wrong");
          setTimeout(()=>zone.classList.remove("wrong"), 500);
          return;
        }

        const chip = document.createElement("div");
        chip.className = "item";
        chip.textContent = val;
        chip.dataset.value = val;
        zone.appendChild(chip);

        // tandai sebagai sudah ditempatkan dan hilangkan dari daftar sumber
        placed.add(val);
        const src = Array.from(document.querySelectorAll('#items .item')).find(el=>el.dataset.value===val);
        if(src) src.remove();

        feedback.textContent = "Penempatan benar.";
        feedback.style.color = "#2e7d32";
      });
    });

    // BUTTON CEK
    const cekBtn = document.getElementById("cek");
    if (cekBtn) {
      cekBtn.onclick = ()=>{
        alert("Silakan cek apakah setiap item sudah masuk himpunan yang benar.");
      };
    }

    // RESET
    const resetBtn = document.getElementById("reset");
    if (resetBtn) {
      resetBtn.onclick = ()=>{
        document.getElementById("hA").innerHTML = "";
        document.getElementById("hB").innerHTML = "";
        document.getElementById("hC").innerHTML = "";
        feedback.textContent = "Reset berhasil.";
        feedback.style.color = "#6b4b3a";
      };
    }

    // --- LOGIKA KEGIATAN 3.2: PILIHAN RELASI ---
    const feedbackBox = document.getElementById("feedbackRelasi");
    const toK2Btn = document.getElementById("toK2Btn");
    let relasiBenar = false;
    const inputKesimpulanRelasi = document.getElementById("k2_penemuan_input");

    document.querySelectorAll(".relasiOption").forEach(btn=>{
      btn.onclick = ()=>{
        const val = btn.dataset.value;

        if(val === "Relasi"){
          relasiBenar = true;
          feedbackBox.style.color = "#2e7d32";
          feedbackBox.textContent =
            "‚úî Benar! Disebut RELASI karena aturan ini memasangkan anggota dari dua himpunan. Fungsi adalah bentuk khusus dari relasi.";
        }
        else if(val === "Fungsi"){
          relasiBenar = false;
          feedbackBox.style.color = "#c62828";
          feedbackBox.textContent =
            "‚úò Masih kurang tepat. Fungsi memang memasangkan himpunan, tetapi dengan syarat khusus. Kita butuh istilah yang lebih umum dari fungsi.";
        }
        else if(val === "Himpunan"){
          relasiBenar = false;
          feedbackBox.style.color = "#c62828";
          feedbackBox.textContent =
            "‚úò Belum tepat. Himpunan hanya kumpulan objek, bukan aturan yang memasangkan dua himpunan.";
        }
        else {
          relasiBenar = false;
          feedbackBox.style.color = "#c62828";
          feedbackBox.textContent =
            "‚úò Hampir. Pasangan berurutan memang digunakan dalam relasi, tapi ini bukan nama konsep keseluruhannya.";
        }
        cekSiapLanjut();
      };
    });

    function cekSiapLanjut(){
      if(toK2Btn){
        toK2Btn.disabled = false;
        toK2Btn.style.opacity = '1';
        toK2Btn.style.cursor = 'pointer';
      }
    }

    // update kesiapan saat siswa mengetik kesimpulan
    if(inputKesimpulanRelasi){
      inputKesimpulanRelasi.addEventListener('input', cekSiapLanjut);
    }

    document.getElementById("btnKonfirmasiRelasi")?.addEventListener('click', ()=>{
      const isi = inputKesimpulanRelasi?.value.trim() || "";
      if(!isi){
        alert("Tuliskan dulu kesimpulanmu tentang pengertian RELASI (minimal 10 karakter).");
        return;
      }
      if(!relasiBenar){
        alert("Pilih jawaban yang benar dulu (Relasi), lalu tuliskan kesimpulanmu.");
        return;
      }
      
      // Update completion untuk k1
      completion.k1 = 1;
      updateProgress();
      
      alert("Bagus! Kamu sudah merumuskan pengertian relasi. Lanjut ke penyajian relasi.");
      cekSiapLanjut();
      if(toK2Btn && !toK2Btn.disabled){
        toK2Btn.click();
      }
    });

}); // Akhir DOMContentLoaded

</script>

<!-- Modal Google Form -->
<div id="gformModal">
  <div id="gformModalContent">
    <span id="gformModalClose" onclick="closeGFormModal()">&times;</span>
    <div class="gform-title">‚úÖ PDF Berhasil Dibuat</div>
    <div class="gform-message">
      <p>File PDF jawabanmu sudah disiapkan.</p>
      <p style="font-weight:700;color:#d32f2f">Silakan upload ke Google Form melalui tombol di bawah.</p>
    </div>
    <a href="" id="gformLink" class="gform-link-btn" target="_blank">üìù BUKA GOOGLE FORM</a>
    <div class="gform-close-btn" onclick="closeGFormModal()">Tutup</div>
  </div>
</div>

<!-- Google Form Helper Script -->
<script src="google-form-helper.js"></script>

<script>
// Override generatePDFReport agar membuat PDF dari screenshot tampilan siswa
(function(){
  window.generatePDFReport = async function(){
    const { jsPDF } = window.jspdf;
    if(!jsPDF) throw new Error('jsPDF library belum dimuat');
    
    const namaKelompok = document.getElementById('namaKelompok')?.value || 'Kelompok';
    console.log('üé¨ Mulai screenshot semua slide...');
    
    try {
      const pdf = new jsPDF('p', 'mm', 'a4');
      const imgWidth = 210; // A4 width mm
      const pageHeight = 297; // A4 height mm
      let pageCount = 0;
      
      // Ambil semua slides
      const slides = document.querySelectorAll('.slide');
      console.log('üìÑ Total slides ditemukan:', slides.length);
      
      for (let i = 0; i < slides.length; i++) {
        const slide = slides[i];
        
        // Tampilkan slide temporary
        slide.style.display = 'block';
        slide.classList.add('active');
        
        // Tunggu rendering
        await new Promise(r => setTimeout(r, 150));
        
        try {
          // Screenshot slide dengan background putih terang, font SANGAT tegas
          const canvas = await html2canvas(slide, {
            scale: 4,
            useCORS: true,
            allowTaint: true,
            backgroundColor: '#ffffff', // Background putih terang
            logging: false,
            windowHeight: slide.scrollHeight,
            imageTimeout: 8000,
            removeContainer: true,
            proxy: null,
            filter: (element) => {
              return true;
            }
          });
          
          // PERTEGAS WARNA SECARA AGRESIF
          const ctx = canvas.getContext('2d');
          const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
          const data = imageData.data;
          
          for (let i = 0; i < data.length; i += 4) {
            const r = data[i];
            const g = data[i+1];
            const b = data[i+2];
            const a = data[i+3];
            
            // Hitung luminance
            const lum = (r * 0.299 + g * 0.587 + b * 0.114) / 255;
            
            // Jika teks (gelap) - pertegas
            if (lum < 0.7) {
              data[i] = Math.max(0, r - 40);     // R lebih gelap
              data[i+1] = Math.max(0, g - 40);   // G lebih gelap
              data[i+2] = Math.max(0, b - 40);   // B lebih gelap
            }
            // Jika background (terang) - perjelas
            else {
              data[i] = Math.min(255, r + 15);     // R lebih cerah
              data[i+1] = Math.min(255, g + 15);   // G lebih cerah
              data[i+2] = Math.min(255, b + 15);   // B lebih cerah
            }
          }
          
          // Naikkan saturation untuk warna lebih hidup
          for (let i = 0; i < data.length; i += 4) {
            const r = data[i];
            const g = data[i+1];
            const b = data[i+2];
            
            const max = Math.max(r, g, b);
            const min = Math.min(r, g, b);
            const l = (max + min) / 2;
            
            if (max !== min) {
              let s = l > 128 ? (max - min) / (510 - max - min) : (max - min) / (max + min);
              s = Math.min(1, s * 1.4); // Naikkan saturation
              
              const h = 
                max === r ? (((g - b) / (max - min)) % 6) / 6 :
                max === g ? ((b - r) / (max - min) + 2) / 6 :
                ((r - g) / (max - min) + 4) / 6;
              
              // HSL to RGB
              const c = (1 - Math.abs(2 * l / 255 - 1)) * s * 255;
              const x = c * (1 - Math.abs((h * 6) % 2 - 1));
              const m = l / 2 - c / 2;
              
              let nr = 0, ng = 0, nb = 0;
              if (h < 1/6) { nr = c; ng = x; }
              else if (h < 2/6) { nr = x; ng = c; }
              else if (h < 3/6) { ng = c; nb = x; }
              else if (h < 4/6) { ng = x; nb = c; }
              else if (h < 5/6) { nr = x; nb = c; }
              else { nr = c; nb = x; }
              
              data[i] = Math.round((nr + m) * 1.1);
              data[i+1] = Math.round((ng + m) * 1.1);
              data[i+2] = Math.round((nb + m) * 1.1);
            }
          }
          
          ctx.putImageData(imageData, 0, 0);
          
          // Hitung ukuran agar sesuai 1 halaman penuh (A4)
          const slideHeight = (canvas.height * imgWidth) / canvas.width;
          const scaleToFit = pageHeight / slideHeight;
          
          // Scale down jika terlalu besar, atau gunakan ukuran natural jika pas
          let finalWidth = imgWidth;
          let finalHeight = slideHeight;
          
          if (slideHeight > pageHeight - 5) {
            finalWidth = imgWidth * scaleToFit;
            finalHeight = slideHeight * scaleToFit;
          }
          
          // Gunakan JPEG dengan quality maksimal
          const imgData = canvas.toDataURL('image/jpeg', 1.0);
          
          // Setiap slide di halaman baru
          if (pageCount > 0) {
            pdf.addPage();
          }
          
          // Center slide di halaman
          const xPos = (imgWidth - finalWidth) / 2;
          const yPos = (pageHeight - finalHeight) / 2;
          
          pdf.addImage(imgData, 'JPEG', xPos, yPos, finalWidth, finalHeight);
          pageCount++;
          
          console.log(`‚úÖ Slide ${i + 1}/${slides.length} ‚Üí Halaman ${pageCount} (${Math.round(slideHeight)}mm)`);
        } catch(slideErr) {
          console.warn(`‚ö†Ô∏è Slide ${i + 1} error:`, slideErr.message);
        }
        
        // Sembunyikan slide kembali
        slide.style.display = 'none';
        slide.classList.remove('active');
      }
      
      const filename = `Hasil_Pertemuan2_${namaKelompok.replace(/\s+/g, '_')}_${new Date().toISOString().split('T')[0]}.pdf`;
      pdf.save(filename);
      console.log('‚úÖ PDF berhasil dibuat:', filename, `(${pageCount} halaman)`);
      return filename;
    } catch(err) {
      console.error('‚ùå Error saat screenshot:', err);
      throw err;
    }
  };

  // Pastikan alur downloadHasil memakai versi screenshot ini
  window.downloadHasil = async function(){
    try{
      alert('‚è≥ Mengumpulkan data pengerjaan...');
      await window.generatePDFReport();
      alert('‚úÖ Data berhasil disimpan!\n\nFile JSON sudah didownload.\n\nLangkah selanjutnya:\n1. Buka Google Drive Anda\n2. Upload file JSON ke folder guru\n3. Guru bisa membuka & melihat semua data');
      console.log('Data pengerjaan siswa berhasil disimpan.');
    } catch(err){
      console.error('Gagal menyimpan data:', err);
      alert('‚ùå Gagal menyimpan: ' + err.message);
      throw err;
    }
  };
})();
</script>

</body></html>
